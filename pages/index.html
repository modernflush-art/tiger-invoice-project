<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tiger Invoice Dashboard</title>
  <!-- Google Fonts removed to prevent 400 error -->
  <style>
    /* CSS Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #fafbfc;
      --bg-secondary: #ffffff;
      --bg-sidebar: #ffffff;
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --border-color: #e2e8f0;
      --border-light: #f7fafc;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --hover-bg: #f7fafc;
      --active-bg: #ebf8ff;
      --active-color: #f97316;
      --success-color: #38a169;
      --warning-color: #d69e2e;
      --error-color: #e53e3e;
      --card-bg: #ffffff;
      --input-bg: #ffffff;
      --input-border: #e2e8f0;
      --gradient-primary: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
    }

    [data-theme="dark"] {
      --bg-primary: #0f1419;
      --bg-secondary: #1a202c;
      --bg-sidebar: #1a202c;
      --text-primary: #f7fafc;
      --text-secondary: #cbd5e0;
      --text-muted: #718096;
      --border-color: #2d3748;
      --border-light: #4a5568;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
      --hover-bg: #2d3748;
      --active-bg: #2c5282;
      --active-color: #fb923c;
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --error-color: #f56565;
      --card-bg: #1a202c;
      --input-bg: #2d3748;
      --input-border: #4a5568;
      --gradient-primary: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
      background: var(--bg-primary);
      margin: 0;
      padding: 0;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-color);
      padding: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-lg);
      position: relative;
      z-index: 10;
    }

    .sidebar-header {
      padding: 24px 24px 20px;
      border-bottom: 1px solid var(--border-color);
      background: var(--gradient-primary);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .sidebar-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    .sidebar-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: white;
      margin: 0;
      position: relative;
      z-index: 1;
    }

    .sidebar-header p {
      color: rgba(255, 255, 255, 0.9);
      margin: 4px 0 0;
      font-size: 14px;
      position: relative;
      z-index: 1;
    }

    .user-info {
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-sidebar);
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 18px;
      box-shadow: var(--shadow);
      border: 3px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .user-avatar:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg);
    }

    .user-details h3 {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.4;
      margin: 0;
    }

    .user-details p {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.3;
      margin: 2px 0 0;
    }

    .nav-section {
      padding: 0 24px;
      margin-bottom: 24px;
    }

    .nav-section h4 {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: var(--radius-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      margin-bottom: 4px;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .nav-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--active-color);
      transform: scaleY(0);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .nav-item:hover {
      color: var(--text-primary);
      background: var(--hover-bg);
      transform: translateX(4px);
    }

    .nav-item.active {
      color: var(--active-color);
      background: var(--active-bg);
      font-weight: 600;
    }

    .nav-item.active::before {
      transform: scaleY(1);
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 0;
      background: var(--bg-primary);
      overflow-y: auto;
      position: relative;
      margin-top: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .stats-section {
      margin: 0 16px 8px 16px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0 0 8px 0;
      padding: 8px 16px 6px 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .header h1 {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    .header-actions {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .theme-toggle {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
      padding: 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      position: relative;
      overflow: hidden;
    }

    .theme-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .theme-toggle:hover {
      background: var(--hover-bg);
      border-color: var(--active-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .theme-toggle:hover::before {
      left: 100%;
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .theme-toggle:hover svg {
      transform: rotate(180deg);
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      font-family: inherit;
      letter-spacing: 0.3px;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .btn-secondary {
      background: var(--card-bg);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
      padding: 10px 20px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }

    .btn-secondary:hover {
      background: var(--hover-bg);
      border-color: var(--active-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin: 0 0 8px 0;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card h3 {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 4px;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .stat-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Data Overview Styles */
    .data-overview {
      margin: 0 16px 16px 16px;
    }

    .overview-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
    }

    .overview-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .overview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }

    .overview-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .view-all-btn {
      color: var(--active-color);
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: color 0.2s;
    }

    .view-all-btn:hover {
      color: var(--text-primary);
    }

    .overview-content {
      padding: 16px 24px;
      max-height: 400px;
      overflow-y: auto;
    }

    /* Customer/Item List Items */
    .list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-light);
      transition: background-color 0.2s;
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item:hover {
      background: var(--hover-bg);
      margin: 0 -24px;
      padding: 12px 24px;
    }

    .list-item-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .list-item-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .list-item-details h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 2px 0;
    }

    .list-item-details p {
      font-size: 12px;
      color: var(--text-secondary);
      margin: 0;
    }

    .list-item-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-active {
      background: var(--success-color);
      color: white;
    }

    .status-inactive {
      background: var(--text-muted);
      color: white;
    }

    .status-instock {
      background: var(--success-color);
      color: white;
    }

    .status-lowstock {
      background: var(--warning-color);
      color: white;
    }

    .status-outofstock {
      background: var(--error-color);
      color: white;
    }

    .status-draft {
      background: var(--text-muted);
      color: white;
    }

    .status-paid {
      background: var(--success-color);
      color: white;
    }

    .status-pending {
      background: var(--warning-color);
      color: white;
    }

    .status-overdue {
      background: var(--error-color);
      color: white;
    }

    .list-item-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .list-item:hover .list-item-actions {
      opacity: 1;
    }

    .action-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn-edit {
      background: var(--active-color);
      color: white;
    }

    .action-btn-edit:hover {
      background: var(--text-primary);
    }

    .action-btn-delete {
      background: var(--error-color);
      color: white;
    }

    .action-btn-delete:hover {
      background: #dc2626;
    }

    /* Quick Actions Styles */
    .quick-actions {
      margin: 0 16px 16px 16px;
    }

    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .quick-action-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      padding: 24px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
      overflow: hidden;
    }

    .quick-action-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }

    .quick-action-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--active-color);
    }

    .quick-action-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      flex-shrink: 0;
    }

    .quick-action-content {
      flex: 1;
    }

    .quick-action-content h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 4px 0;
    }

    .quick-action-content p {
      font-size: 12px;
      color: var(--text-secondary);
      margin: 0;
      line-height: 1.4;
    }

    .quick-action-arrow {
      color: var(--text-secondary);
      opacity: 0.6;
      transition: all 0.2s;
    }

    .quick-action-card:hover .quick-action-arrow {
      opacity: 1;
      transform: translateX(4px);
    }

    .stat-trend {
      font-size: 14px;
      font-weight: 500;
    }

    .stat-trend.positive {
      color: var(--success-color);
    }

    .stat-trend.negative {
      color: var(--error-color);
    }

    .recent-invoices {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      margin-bottom: 40px;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow);
    }

    .recent-invoices:hover {
      box-shadow: var(--shadow-lg);
    }

    .recent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 28px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }

    .recent-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .recent-header a {
      color: var(--active-color);
      text-decoration: none;
      font-size: 14px;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: var(--radius-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .recent-header a:hover {
      background: var(--active-bg);
    }

    .recent-table {
      width: 100%;
      border-collapse: collapse;
    }

    .recent-table th, .recent-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
      font-size: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .recent-table th {
      background: var(--bg-primary);
      color: var(--text-secondary);
      font-weight: 700;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .recent-table tr:last-child td {
      border-bottom: none;
    }

    .recent-table tr:hover {
      background: var(--hover-bg);
      transform: scale(1.01);
    }

    .recent-table tr {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-block;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .status-draft {
      background: var(--hover-bg);
      color: var(--text-secondary);
    }

    .status-badge:hover {
      transform: scale(1.05);
    }

    /* Customer Table Styles */
    .customer-table-wrapper {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      margin: 0 16px 8px 16px;
    }

    .customer-table {
      width: 100%;
      border-collapse: collapse;
    }

    .customer-table th {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 14px;
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .customer-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-primary);
    }

    .customer-table tr:last-child td {
      border-bottom: none;
    }

    .customer-table tr:hover {
      background: var(--hover-bg);
    }

    .status-active {
      color: var(--success-color);
      font-weight: 600;
    }

    .status-inactive {
      color: var(--error-color);
      font-weight: 600;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-edit {
      background: var(--warning-color);
      color: white;
    }

    .btn-edit:hover {
      background: #e67e22;
    }

    .btn-delete {
      background: var(--error-color);
      color: white;
    }

    .btn-delete:hover {
      background: #c0392b;
    }

    .loading {
      text-align: center;
      padding: 12px;
      color: var(--text-secondary);
    }

    /* Item Table Styles */
    .item-table-wrapper {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      margin: 0 16px 8px 16px;
    }

    .item-table {
      width: 100%;
      border-collapse: collapse;
    }

    .item-table th {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 14px;
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .item-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-primary);
    }

    .item-table tr:last-child td {
      border-bottom: none;
    }

    .item-table tr:hover {
      background: var(--hover-bg);
    }

    .item-image {
      max-width: 50px;
      max-height: 50px;
      border-radius: 5px;
      margin: 0 2px;
    }

    .no-image {
      color: var(--text-muted);
      font-style: italic;
    }

    .no-files {
      color: var(--text-muted);
      font-style: italic;
    }

    .file-icon {
      display: inline-block;
      text-align: center;
      padding: 8px;
      margin: 2px;
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 60px;
    }

    .file-icon:hover {
      background: var(--hover-bg);
      border-color: var(--active-color);
    }

    /* Invoice Table Styles */
    .invoice-table-wrapper {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      margin: 0 16px 8px 16px;
    }

    /* Sale Invoice Styles */
    .invoice-content {
      padding: 20px;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      padding: 12px 24px;
      background: var(--card-bg);
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .tab.active {
      background: var(--active-color);
      color: white;
      border-bottom-color: var(--active-color);
    }

    .tab:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
    }

    .form-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text-primary);
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--active-color);
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .form-group textarea {
      height: 60px;
      resize: vertical;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .checkbox-group label {
      margin: 0;
      font-weight: 500;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .items-table th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 12px 8px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      border-bottom: 1px solid var(--border-color);
    }

    .items-table td {
      padding: 8px;
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
    }

    .items-table input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 12px;
      background: var(--input-bg);
      color: var(--text-primary);
    }

    .items-table input[readonly] {
      background: var(--bg-secondary);
      color: var(--text-secondary);
    }

    .bottom-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .financial-summary {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .financial-summary .form-group {
      margin-bottom: 12px;
    }

    .financial-summary input {
      background: var(--card-bg);
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-toggle {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .dropdown-toggle:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      min-width: 160px;
      margin-top: 4px;
    }

    .dropdown-menu button {
      display: block;
      width: 100%;
      padding: 10px 16px;
      border: none;
      background: none;
      color: var(--text-primary);
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }

    .dropdown-menu button:hover {
      background: var(--hover-bg);
    }

    .dropdown-menu.show {
      display: block;
    }

    @media (max-width: 1200px) {
      .form-section, .bottom-section {
        grid-template-columns: 1fr;
      }
    }

    .invoice-table {
      width: 100%;
      border-collapse: collapse;
    }

    .invoice-table th {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 14px;
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .invoice-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-primary);
    }

    .invoice-table tr:last-child td {
      border-bottom: none;
    }

    .invoice-table tr:hover {
      background: var(--hover-bg);
    }

    .status-paid {
      background: #dcfce7;
      color: var(--success-color);
    }

    .status-pending {
      background: #fef9c3;
      color: var(--warning-color);
    }

    .status-overdue {
      background: #fef2f2;
      color: var(--error-color);
    }

    .amount {
      font-weight: 600;
    }

    /* Invoice Form Styles */
    .invoice-container {
      max-width: 700px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 32px 28px 28px 28px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .invoice-items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .invoice-items-table th,
    .invoice-items-table td {
      border: 1px solid var(--border-color);
      padding: 12px;
      text-align: left;
    }

    .invoice-items-table th {
      background: var(--bg-secondary);
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .invoice-items-table td input {
      width: 100%;
      box-sizing: border-box;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 14px;
    }

    .invoice-items-table td input:focus {
      outline: none;
      background: var(--hover-bg);
    }

    .items-table-section {
      margin: 24px 0;
    }

    .invoice-actions {
      display: flex;
      gap: 12px;
      margin-top: 18px;
    }

    .btn-secondary {
      background: var(--text-secondary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow);
      font-family: inherit;
      letter-spacing: 0.3px;
    }

    .btn-secondary:hover {
      background: var(--text-muted);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* Enhanced Invoice Form Styles */
    .customer-section,
    .invoice-details,
    .items-section {
      margin-bottom: 32px;
    }

    .customer-section h3,
    .invoice-details h3,
    .items-section h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border-color);
    }

    .input-with-button {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .input-with-button .form-control {
      flex: 1;
    }

    .input-with-button .btn-small {
      white-space: nowrap;
      padding: 8px 12px;
      font-size: 12px;
    }

    .items-header {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 16px;
    }

    .totals-section {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 20px;
      margin: 24px 0;
      border: 1px solid var(--border-color);
    }

    .totals-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .total-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .total-item label {
      font-weight: 500;
      color: var(--text-secondary);
    }

    .total-item span {
      font-weight: 600;
      color: var(--text-primary);
    }

    .total-grand {
      border-top: 2px solid var(--border-color);
      padding-top: 12px;
      margin-top: 8px;
    }

    .total-grand label,
    .total-grand span {
      font-size: 18px;
      font-weight: 700;
      color: var(--active-color);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .form-control {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--input-border);
      border-radius: var(--radius-md);
      font-size: 15px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--active-color);
      box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
    }

    .form-control:hover {
      border-color: var(--active-color);
    }

            .form-control::placeholder {
          color: var(--text-muted);
        }

        /* File Upload Section Styles */
        .file-upload-section {
          grid-column: span 2;
          background: linear-gradient(135deg, var(--input-bg) 0%, var(--border-light) 100%);
          border: 2.5px dashed var(--active-color);
          border-radius: 18px;
          text-align: center;
          padding: 38px 0 32px 0;
          margin-bottom: 36px;
          transition: all 0.3s ease;
        }

        .file-upload-section:hover {
          border-color: var(--primary-color);
          background: linear-gradient(135deg, var(--hover-bg) 0%, var(--input-bg) 100%);
        }

        .file-upload-section h3 {
          font-size: 22px;
          font-weight: 700;
          color: var(--text-primary);
          margin-bottom: 18px;
          border: none;
          padding-bottom: 0;
        }

        .file-upload-btn {
          display: inline-block;
          padding: 14px 38px;
          background: var(--active-color);
          color: white;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          font-size: 18px;
          font-weight: 700;
          margin-bottom: 10px;
          transition: all 0.2s;
        }

        .file-upload-btn:hover {
          background: var(--primary-color);
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(249, 115, 22, 0.3);
        }

        #customerFileList {
          margin-top: 18px;
        }

        .uploaded-file {
          display: flex;
          align-items: center;
          justify-content: space-between;
          background: var(--card-bg);
          padding: 10px 15px;
          margin: 5px 0;
          border-radius: 8px;
          border: 1px solid var(--border-color);
          color: var(--text-primary);
        }

        .uploaded-file .file-info {
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .uploaded-file .file-name {
          font-weight: 600;
          color: var(--text-primary);
        }

        .uploaded-file .file-size {
          font-size: 12px;
          color: var(--text-secondary);
        }

        .uploaded-file .remove-file {
          background: var(--error-color);
          color: white;
          border: none;
          padding: 4px 8px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
          transition: background 0.2s;
        }

        .uploaded-file .remove-file:hover {
          background: #dc2626;
        }

    .items-section {
      margin-bottom: 24px;
    }

    .items-section h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
    }

    .items-table-wrapper {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px;
    }

    .items-table th {
      background: var(--bg-primary);
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 14px;
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .items-table td {
      padding: 8px;
      border-bottom: 1px solid var(--border-light);
    }

    .items-table tr:last-child td {
      border-bottom: none;
    }

    .totals-section {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .totals-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .total-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .total-item label {
      font-weight: 600;
      color: var(--text-primary);
    }

    .total-item span {
      font-weight: 600;
      color: var(--text-primary);
    }

    .total-grand {
      border-top: 2px solid var(--border-color);
      padding-top: 12px;
      margin-top: 8px;
      font-size: 18px;
    }

    .total-grand label,
    .total-grand span {
      font-size: 18px;
      font-weight: 700;
      color: var(--active-color);
    }

    /* Customer Form Styles */
    .customer-form-wrapper {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }

    /* Item Form Styles */
    .item-form-wrapper {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }

    .image-upload-section {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: var(--bg-secondary);
      transition: border-color 0.2s;
    }

    .image-upload-section:hover {
      border-color: var(--active-color);
    }

    .image-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 16px;
      justify-content: center;
    }

    .image-preview img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      border: 2px solid var(--border-color);
    }

    .upload-hint {
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Settings Styles */
    .settings-wrapper {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .settings-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .settings-section h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-primary);
    }

    .checkbox-label input[type="checkbox"] {
      display: none;
    }

    .checkmark {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-radius: 4px;
      position: relative;
      transition: all 0.2s;
    }

    .checkbox-label input[type="checkbox"]:checked + .checkmark {
      background: var(--active-color);
      border-color: var(--active-color);
    }

    .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background: var(--hover-bg);
    }

    .btn-danger {
      background: var(--error-color);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .setting-hint {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Help Styles */
    .help-wrapper {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .help-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .help-section h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .help-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .help-step {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .step-number {
      width: 32px;
      height: 32px;
      background: var(--active-color);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
    }

    .step-content h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .step-content p {
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .faq-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .faq-item {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    .faq-question {
      padding: 16px;
      background: var(--bg-secondary);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
      color: var(--text-primary);
      transition: background-color 0.2s;
    }

    .faq-question:hover {
      background: var(--hover-bg);
    }

    .faq-icon {
      font-size: 18px;
      font-weight: bold;
      color: var(--text-secondary);
      transition: transform 0.2s;
    }

    .faq-item.active .faq-icon {
      transform: rotate(45deg);
    }

    .faq-answer {
      padding: 0 16px;
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
      background: var(--card-bg);
    }

    .faq-item.active .faq-answer {
      padding: 16px;
      max-height: 500px;
    }

    .faq-answer p {
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .faq-answer ol {
      color: var(--text-secondary);
      line-height: 1.6;
      padding-left: 20px;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .feature-card {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--border-color);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .feature-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .feature-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .feature-card h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .feature-card p {
      color: var(--text-secondary);
      line-height: 1.6;
      font-size: 14px;
    }

    .shortcuts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .shortcut-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }

    .shortcut-item kbd {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      font-family: monospace;
      color: var(--text-primary);
      font-weight: 600;
    }

    .shortcut-item span {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .support-content {
      text-align: center;
    }

    .support-content > p {
      color: var(--text-secondary);
      margin-bottom: 24px;
      font-size: 16px;
    }

    .support-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .support-option {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .support-option h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .support-option p {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 4px;
    }



    .empty-state h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
      line-height: 1.5;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-color);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    /* Page Sections */
    .page-section {
      display: none;
      flex: 1;
    }

    .page-section.active {
      display: block;
      height: 100vh;
      padding: 0;
      margin: 0;
      overflow-y: auto;
    }

    @media (max-width: 1100px) {
      .stats-grid { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 768px) {
      .main-content { padding: 16px 0; }
      .stats-grid { grid-template-columns: 1fr; gap: 18px; }
      .stat-card { padding: 18px 10px 18px 10px; }
      .recent-header, .recent-table th, .recent-table td { padding: 10px; }
    }

    /* Recent Invoices Section */
    .recent-invoices-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      margin: 32px 16px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .section-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .view-all-link {
      color: var(--active-color);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
    }

    .view-all-link:hover {
      text-decoration: underline;
    }

    /* Invoice Statistics Cards */
    .invoice-stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 20px;
      border-top: 3px solid var(--active-color);
      position: relative;
    }

    .stat-header {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Invoices Table */
    .invoices-table-container {
      overflow-x: auto;
    }

    .invoices-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
    }

    .invoices-table thead {
      background: var(--bg-secondary);
    }

    .invoices-table th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .invoices-table td {
      padding: 16px;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-primary);
    }

    .invoices-table tbody tr:nth-child(even) {
      background: var(--bg-secondary);
    }

    .invoices-table tbody tr:hover {
      background: var(--hover-bg);
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-draft {
      background: #374151;
      color: #9ca3af;
    }

    .status-pending {
      background: #92400e;
      color: #fbbf24;
    }

    .status-paid {
      background: #065f46;
      color: #34d399;
    }

    .status-overdue {
      background: #7f1d1d;
      color: #f87171;
    }

    .total-amount {
      text-align: right;
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    .action-buttons {
      display: flex;
      gap: 6px;
    }

    .btn-view {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-view:hover {
      background: #2563eb;
    }

    .btn-edit {
      background: var(--active-color);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-edit:hover {
      background: #ea580c;
    }

    .btn-delete {
      background: var(--error-color);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-delete:hover {
      background: #dc2626;
    }

    /* Empty state for invoices */
    .empty-invoices {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-invoices svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.6;
    }

    .empty-invoices h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .empty-invoices p {
      font-size: 14px;
      margin: 0;
      line-height: 1.5;
    }

    /* Notifications Page Styles */
    .notifications-wrapper {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .notification-filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
    }

    .filter-btn.active {
      background: var(--active-color);
      color: white;
      border-color: var(--active-color);
    }

    .notifications-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .notification-item {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid var(--border-color);
      transition: all 0.2s;
      cursor: pointer;
      display: flex;
      align-items: flex-start;
    }

    .notification-item:hover {
      box-shadow: var(--shadow);
      transform: translateY(-1px);
    }

    .notification-item.unread {
      border-left: 4px solid var(--active-color);
      background: var(--active-bg);
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .notification-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
      margin-bottom: 4px;
    }

    .notification-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    .notification-message {
      color: var(--text-secondary);
      font-size: 13px;
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .notification-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .notification-btn {
      padding: 4px 8px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-view {
      background: var(--active-color);
      color: white;
    }

    .btn-view:hover {
      background: #2563eb;
    }

    .btn-dismiss {
      background: var(--text-muted);
      color: white;
    }

    .btn-dismiss:hover {
      background: #64748b;
    }

    .notification-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .icon-overdue {
      background: #fef2f2;
      color: var(--error-color);
    }

    .icon-stock {
      background: #fef9c3;
      color: var(--warning-color);
    }

    .icon-system {
      background: #eff6ff;
      color: var(--active-color);
    }

    .icon-success {
      background: #dcfce7;
      color: var(--success-color);
    }

    .notification-content {
      flex: 1;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }



    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* All Invoices Page Styles */
    .search-filter-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 20px;
      flex-wrap: wrap;
    }

    .search-box {
      position: relative;
      flex: 1;
      max-width: 300px;
    }

    .search-box input {
      width: 100%;
      padding: 10px 40px 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
    }

    .search-box svg {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .filter-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-buttons .filter-btn {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .filter-buttons .filter-btn:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
    }

    .filter-buttons .filter-btn.active {
      background: var(--active-color);
      color: white;
      border-color: var(--active-color);
    }

    /* Create Invoice Page Scrollable Styles */
    .invoice-content {
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      padding: 20px;
    }

    .invoice-content::-webkit-scrollbar {
      width: 8px;
    }

    .invoice-content::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    .invoice-content::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    .invoice-content::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Customer and Item Information Sections */
    .info-sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .info-section {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
    }

    .info-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .info-section-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 16px;
    }

    .info-section-count {
      background: var(--active-color);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .info-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-item-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .info-item-details {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .info-item-status {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-active {
      background: #dcfce7;
      color: #166534;
    }

    .status-inactive {
      background: #fef2f2;
      color: #dc2626;
    }

    /* Customer Selector Modal Scrollbar Styles */
    #customerList::-webkit-scrollbar {
      width: 8px;
    }

    #customerList::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    #customerList::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    #customerList::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }


  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>Tiger Invoice</h2>
      </div>
      <div class="user-info">
        <div class="user-avatar">
          <img id="sidebarProfilePic" src="https://ui-avatars.com/api/?name=SP&background=3b82f6&color=fff&size=128" alt="Profile Picture" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
        </div>
        <div class="user-details">
          <h3 id="sidebarUserName">Loading...</h3>
          <p id="sidebarUserEmail">Loading...</p>
        </div>
      </div>
      <nav>
        <div class="nav-section">
          <h4>Main</h4>
          <div class="nav-item active" onclick="showPage('dashboard', event)">Home</div>
          <div class="nav-item" onclick="window.location.href='customer.html'">Customers</div>
          <div class="nav-item" onclick="window.location.href='item.html'">Items</div>
    
            
        </div>

        <div class="nav-section">
          <h4>Other</h4>
          <div class="nav-item" onclick="showPage('notifications', event)">Notifications</div>
          <div class="nav-item" onclick="showPage('help', event)">Help!</div>
          
          <div class="nav-item" onclick="showPage('settings', event)">Settings</div>
          <div class="nav-item" onclick="logout()">Logout</div>
        </div>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Dashboard Page -->
      <div id="dashboard" class="page-section active">
        <div class="header">
          <h1>Dashboard</h1>
          <div class="header-actions">
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Toggle theme">
              <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
            <button class="btn-primary" onclick="showPage('create-invoice')">Create Invoice</button>
          </div>
        </div>

        <!-- Stats Section -->
        <div class="stats-section">
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
              <h3>Total Customers</h3>
              <div class="stat-value" id="statCustomers">0</div>
              <div class="stat-subtitle">Active: <span id="statActiveCustomers">0</span></div>
            </div>
            <div class="stat-card">
              <h3>Total Items</h3>
              <div class="stat-value" id="statItems">0</div>
              <div class="stat-subtitle">In Stock: <span id="statInStock">0</span></div>
            </div>
            <div class="stat-card">
              <h3>Low Stock Items</h3>
              <div class="stat-value" id="statLowStock">0</div>
              <div class="stat-subtitle">Needs Attention</div>
            </div>
            <div class="stat-card">
              <h3>Out of Stock</h3>
              <div class="stat-value" id="statOutOfStock">0</div>
              <div class="stat-subtitle">Requires Restocking</div>
            </div>
          </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="quick-actions">
          <div class="quick-actions-grid">
            <div class="quick-action-card" onclick="showPage('create-invoice')">
              <div class="quick-action-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14,2 14,8 20,8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10,9 9,9 8,9"></polyline>
                </svg>
              </div>
              <div class="quick-action-content">
                <h3>Create Invoice</h3>
                <p>Generate a new invoice for your customers</p>
              </div>
              <div class="quick-action-arrow">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M5 12h14M12 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>

            <div class="quick-action-card" onclick="window.location.href='customer.html'">
              <div class="quick-action-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
              </div>
              <div class="quick-action-content">
                <h3>Manage Customers</h3>
                <p>Add, edit, and manage your customer database</p>
              </div>
              <div class="quick-action-arrow">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M5 12h14M12 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>

            <div class="quick-action-card" onclick="window.location.href='item.html'">
              <div class="quick-action-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                  <line x1="7" y1="7" x2="7.01" y2="7"></line>
                </svg>
              </div>
              <div class="quick-action-content">
                <h3>Manage Items</h3>
                <p>Add, edit, and track your inventory items</p>
              </div>
              <div class="quick-action-arrow">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M5 12h14M12 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>
          </div>
        </div>

                  <!-- Recent Invoices Section -->
     <div class="recent-invoices-section">
       <div class="section-header">
            <h2>Recent Invoices</h2>
         <a href="#" class="view-all-link" onclick="showAllInvoices(); console.log('View All clicked');">View All</a>
          </div>
       
       <!-- Invoice Statistics Cards -->
       <div class="invoice-stats-grid">
         <div class="stat-card">
           <div class="stat-header">TOTAL INVOICES</div>
           <div class="stat-value" id="totalInvoices">0</div>
         </div>
         <div class="stat-card">
           <div class="stat-header">PAID</div>
           <div class="stat-value" id="paidInvoices">0</div>
         </div>
         <div class="stat-card">
           <div class="stat-header">PENDING</div>
           <div class="stat-value" id="pendingInvoices">0</div>
         </div>
         <div class="stat-card">
           <div class="stat-header">OVERDUE</div>
           <div class="stat-value" id="overdueInvoices">0</div>
         </div>
       </div>
       
       <!-- Invoices Table -->
       <div class="invoices-table-container">
         <table class="invoices-table">
            <thead>
              <tr>
               <th>Invoice Number</th>
               <th>Customer Name</th>
                <th>Date</th>
               <th>Status</th>
                <th>Total</th>
               <th>Actions</th>
              </tr>
            </thead>
           <tbody id="recentInvoicesList">
             <!-- Recent invoices will be loaded here -->
            </tbody>
          </table>
       </div>
        </div>
      </div>

      <!-- Create Invoice Page -->
      <div id="create-invoice" class="page-section">
        <div class="header">
          <h1>Sale Invoice</h1>
          <div class="header-actions">
            <button class="btn-secondary" onclick="newInvoice()" style="margin-right: 8px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              New Invoice
            </button>
            <button class="btn-primary" onclick="saveInvoice()" style="margin-right: 8px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17,21 17,13 7,13 7,21"></polyline>
                <polyline points="7,3 7,8 15,8"></polyline>
              </svg>
              Save
            </button>
            <button class="btn-secondary" onclick="testFirebaseSave()" style="margin-right: 8px;">
              Test Firebase
            </button>
            <div class="dropdown">
              <button class="btn-secondary dropdown-toggle" onclick="toggleInvoiceMenu()">
                More â–¼
              </button>
              <div class="dropdown-menu" id="invoiceMenu">
                <button onclick="printInvoice()">Print Invoice</button>
                <button onclick="exportInvoice()">Export PDF</button>
                <button onclick="clearInvoice()">Clear Form</button>
              </div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Status Messages -->
        <div id="invoiceFormStatusMessage"></div>

        <!-- Invoice Content -->
        <div class="invoice-content">
          <div class="tabs">
            <button class="tab active" onclick="switchTab('sale-invoice')">Sale Invoice</button>
            <button class="tab" onclick="switchTab('customer-list')">Customer Invoice List</button>
          </div>

          <!-- Customer and Item Information Sections -->
          <div class="info-sections">
            <div class="info-section">
              <div class="info-section-header">
                <div class="info-section-title">Recent Customers</div>
                <div class="info-section-count" id="customerCount">0</div>
              </div>
              <div class="info-list" id="recentCustomersList">
                <!-- Recent customers will be loaded here -->
              </div>
            </div>
            
            <div class="info-section">
              <div class="info-section-header">
                <div class="info-section-title">Recent Items</div>
                <div class="info-section-count" id="itemCount">0</div>
              </div>
              <div class="info-list" id="recentItemsList">
                <!-- Recent items will be loaded here -->
              </div>
            </div>
          </div>
          
          <!-- Customer Information Section -->
          <div class="form-section">
            <div>
              <div class="form-group">
                <label for="customer">Customer</label>
                <div style="display: flex; gap: 5px;">
                  <select id="customerSelect" onchange="autoFillCustomer(this.value)" style="flex: 1;">
                    <option value="">Select Customer</option>
                  </select>
                  <input type="text" id="customer" placeholder="Enter customer code" onchange="searchCustomer(this.value)">
                  <button class="btn btn-primary" style="padding: 8px 12px;" onclick="showCustomerSelector()">...</button>
                </div>
              </div>
              <div class="form-group">
                <label for="customerName">Name</label>
                <input type="text" id="customerName" placeholder="Enter customer name">
              </div>
              <div class="form-group">
                <label for="contact">Contact</label>
                <input type="text" id="contact" placeholder="Enter contact person">
              </div>
              <div class="form-group">
                <label for="address">Address</label>
                <div style="display: flex; gap: 5px;">
                  <textarea id="address" placeholder="Enter customer address"></textarea>
                  <button class="btn btn-primary" style="padding: 8px 12px;">Edit Note</button>
                </div>
              </div>
              <div class="form-group">
                <label for="phone">Phone</label>
                <input type="text" id="phone" placeholder="Enter phone number">
              </div>
              <div class="form-group">
                <label for="customerGroup">Customer Group</label>
                <input type="text" id="customerGroup" placeholder="Enter customer group">
              </div>
              <div class="form-group">
                <label for="taxNumber">Tax Number</label>
                <input type="text" id="taxNumber" placeholder="Enter tax number">
              </div>
            </div>
            
            <div>
              <div class="form-group">
                <label for="invoiceType">Invoice Type</label>
                <select id="invoiceType">
                  <option value="">Select invoice type</option>
                  <!-- Invoice type options will be loaded dynamically from Firebase RTDB -->
                </select>
              </div>
              <div class="form-group">
                <label for="invoiceNo">Invoice No</label>
                <input type="text" id="invoiceNo" placeholder="Enter invoice number">
              </div>
              <div class="form-group">
                <label for="invoiceDate">Date</label>
                <input type="date" id="invoiceDate">
              </div>
              <div class="form-group">
                <label for="status">Status</label>
                <input type="text" id="status" value="Draft" readonly>
              </div>
              <div class="form-group">
                <div class="checkbox-group">
                  <input type="checkbox" id="deliveryStatus">
                  <label for="deliveryStatus">Delivery Status</label>
                </div>
              </div>
              <div class="form-group">
                <div class="checkbox-group">
                  <input type="checkbox" id="expressStatus">
                  <label for="expressStatus">Express Status</label>
                </div>
              </div>
              <div class="form-group">
                <label for="barcode">Barcode</label>
                <input type="text" id="barcode" placeholder="Enter barcode">
              </div>
            </div>
          </div>
          
          <!-- Items Table -->
          <table class="items-table" id="itemsTable">
            <thead>
              <tr>
                <th>Item</th>
                <th>Description</th>
                <th>Warehouse</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Dis(%)</th>
                <th>Dis($)</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="itemsBody">
              <!-- Invoice items will be loaded dynamically from Firebase RTDB -->
            </tbody>
          </table>
          
          <button class="btn btn-primary" onclick="addItemRow()">Add Item</button>
          
          <!-- Bottom Section -->
          <div class="bottom-section">
            <div>
              <div class="form-group">
                <label for="warehouse">Warehouse</label>
                <select id="warehouse">
                  <option value="">Select warehouse</option>
                  <!-- Warehouse options will be loaded dynamically from Firebase RTDB -->
                </select>
              </div>
              <div class="form-group">
                <label for="sale">Sale</label>
                <select id="sale">
                  <option value="">Select sale</option>
                  <!-- Sale options will be loaded dynamically from Firebase RTDB -->
                </select>
              </div>
              <div class="form-group">
                <label for="paymentTerm">Payment Term</label>
                <input type="text" id="paymentTerm" placeholder="Enter payment terms">
              </div>
              <div class="form-group">
                <label for="currency">Currency</label>
                <select id="currency">
                  <option value="">Select currency</option>
                  <!-- Currency options will be loaded dynamically from Firebase RTDB -->
                </select>
              </div>
              <div class="form-group">
                <label for="refNumber">Ref Number</label>
                <input type="text" id="refNumber" placeholder="Enter reference number">
              </div>
              <div class="form-group">
                <label for="dateDue">Date Due</label>
                <input type="date" id="dateDue">
              </div>
              <div class="form-group">
                <label for="shipping">Shipping</label>
                <select id="shipping">
                  <option value="">Select shipping method</option>
                  <!-- Shipping options will be loaded dynamically from Firebase RTDB -->
                </select>
              </div>
              <div class="form-group">
                <label for="dateShip">Date Ship</label>
                <input type="date" id="dateShip">
              </div>
              <div class="form-group">
                <label for="note">Note</label>
                <textarea id="note" placeholder="Enter notes"></textarea>
              </div>
              <div class="form-group">
                <label for="shipAddress">Ship Address</label>
                <input type="text" id="shipAddress" placeholder="Enter shipping address">
              </div>
              <div class="form-group">
                <label for="soNumber">SO Number</label>
                <input type="text" id="soNumber" placeholder="Enter SO number">
              </div>
              <div class="form-group">
                <label for="soDate">SO Date</label>
                <input type="date" id="soDate">
              </div>
              <div class="form-group">
                <label for="reference">Reference</label>
                <input type="text" id="reference" placeholder="Enter reference">
              </div>
            </div>
            
            <div class="financial-summary">
              <div class="form-group">
                <label for="subTotal">Sub Total</label>
                <input type="number" id="subTotal" value="0.00" step="0.01" readonly>
              </div>
              <div class="form-group">
                <label for="cashAccount">Cash Account</label>
                <input type="text" id="cashAccount" placeholder="Enter cash account">
              </div>
              <div class="form-group">
                <label for="promotionPercent">Promotion(%)</label>
                <input type="number" id="promotionPercent" value="0" step="0.01" min="0" onchange="calculateTotals()">
              </div>
              <div class="form-group">
                <label for="promotionAmount">Amount</label>
                <input type="number" id="promotionAmount" value="0.00" step="0.01" readonly>
              </div>
              <div class="form-group">
                <label for="proAmount">Pro Am($)</label>
                <input type="number" id="proAmount" value="0.00" step="0.01" readonly>
              </div>
              <div class="form-group">
                <label for="netDue">Net Due</label>
                <input type="number" id="netDue" value="0.00" step="0.01" readonly>
              </div>
              <div class="form-group">
                <label for="discountPercent">Discount(%)</label>
                <input type="number" id="discountPercent" value="0" step="0.01" min="0" onchange="calculateTotals()">
              </div>
              <div class="form-group">
                <label for="discountAmount">Discount($)</label>
                <input type="number" id="discountAmount" value="0.00" step="0.01" readonly>
              </div>
              <div class="form-group">
                <label for="reference2">Reference</label>
                <input type="text" id="reference2" placeholder="Enter reference">
              </div>
              <div class="form-group">
                <label for="vatPercent">VAT(%)</label>
                <input type="number" id="vatPercent" value="0" step="0.01" min="0" onchange="calculateTotals()">
              </div>
              <div class="form-group">
                <label for="deAccount">De Account</label>
                <input type="text" id="deAccount" placeholder="Enter De account">
              </div>
              <div class="form-group">
                <div class="checkbox-group">
                  <input type="checkbox" id="freight" onchange="calculateTotals()">
                  <label for="freight">Freight</label>
                  <input type="number" value="0.00" step="0.01" style="width: 80px; margin-left: 10px;">
                </div>
              </div>
              <div class="form-group">
                <label for="accountNoD">Account No D</label>
                <input type="text" id="accountNoD" placeholder="Enter account number">
              </div>
              <div class="form-group">
                <div class="checkbox-group">
                  <input type="checkbox" id="plt" onchange="calculateTotals()">
                  <label for="plt">PLT</label>
                  <input type="number" value="0.00" step="0.01" style="width: 80px; margin-left: 10px;">
                </div>
              </div>
              <div class="form-group">
                <label for="grandTotalWords">Grand Total in word</label>
                <textarea id="grandTotalWords" readonly style="height: 40px;"></textarea>
              </div>
              <div class="form-group">
                <label for="grandTotal">Grand Total</label>
                <input type="number" id="grandTotal" value="0.00" step="0.01" readonly>
              </div>
            </div>
          </div>
          
          <!-- Invoice Logo Section -->
          <div class="form-section" style="margin-top: 24px;">
            <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Invoice Logo</h3>
            
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Upload Logo:</label>
              <input type="file" id="invoiceLogo" accept="image/*" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
              <small style="color: var(--text-muted); font-size: 12px;">Upload your company logo. Supported formats: JPG, PNG, GIF. Recommended size: 200x100px</small>
            </div>
            
            <div id="invoiceLogoPreviewContainer" style="margin-top: 16px;">
              <!-- Logo preview will be displayed here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Add Customer Page -->
      <div id="add-customer" class="page-section">
        <div class="header">
          <h1>Add Customer</h1>
          <div class="header-actions">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
            <button class="btn-secondary" onclick="showPage('dashboard', event)" style="margin-right: 16px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              Back
            </button>
            <button class="btn-primary" onclick="saveCustomer()">Save Customer</button>
          </div>
        </div>

        <!-- Status Messages -->
        <div id="customerFormStatusMessage"></div>

        <!-- Customer Form -->
        <div class="customer-form-wrapper">
          <form id="customerForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="customerId">Customer ID</label>
                <input type="text" id="customerId" class="form-control" placeholder="Enter customer ID" required>
              </div>
              <div class="form-group">
                <label for="customerName">Customer Name</label>
                <input type="text" id="customerName" class="form-control" placeholder="Enter customer name" required>
              </div>
              <div class="form-group">
                <label for="customerPhone">Phone Number</label>
                <input type="tel" id="customerPhone" class="form-control" placeholder="Enter phone number">
              </div>
              <div class="form-group">
                <label for="customerEmail">Email Address</label>
                <input type="email" id="customerEmail" class="form-control" placeholder="Enter email address">
              </div>
              <div class="form-group">
                <label for="customerAddress">Address</label>
                <textarea id="customerAddress" class="form-control" placeholder="Enter customer address" rows="3"></textarea>
              </div>
              <div class="form-group">
                <label for="customerStatus">Status</label>
                <select id="customerStatus" class="form-control">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
            </div>

            <!-- File Upload Section -->
            <div class="file-upload-section">
              <h3>Customer Documents</h3>
              <input type="file" id="customerFiles" class="form-control" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx" multiple style="display: none;">
              <button type="button" class="file-upload-btn" onclick="document.getElementById('customerFiles').click()">
                Choose Files
              </button>
              <p style="margin-top: 10px; color: var(--text-secondary); font-size: 14px;">
                Upload customer documents, contracts, or images. Supported formats: Images (JPG, PNG, GIF, WebP), Documents (PDF, DOC, DOCX, XLS, XLSX)
              </p>
              <div id="customerFileList" style="margin-top: 18px;"></div>
            </div>

            <div class="form-group">
              <label for="customerNotes">Notes</label>
              <textarea id="customerNotes" class="form-control" placeholder="Enter any additional notes" rows="3"></textarea>
            </div>
          </form>
        </div>
      </div>

      <!-- Add Item Page -->
      <div id="add-item" class="page-section">
        <div class="header">
          <h1>Add Item</h1>
          <div class="header-actions">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
            <button class="btn-primary" onclick="saveItem()">Save Item</button>
          </div>
        </div>

        <!-- Status Messages -->
        <div id="itemFormStatusMessage"></div>

        <!-- Item Form -->
        <div class="item-form-wrapper">
          <form id="itemForm">
            <div class="form-grid">
              <div class="form-group">
                <label for="itemCode">Item Code</label>
                <input type="text" id="itemCode" class="form-control" placeholder="Enter item code" required>
              </div>
              <div class="form-group">
                <label for="itemName">Item Name</label>
                <input type="text" id="itemName" class="form-control" placeholder="Enter item name" required>
              </div>
              <div class="form-group">
                <label for="itemCategory">Category</label>
                <input type="text" id="itemCategory" class="form-control" placeholder="Enter category">
              </div>
              <div class="form-group">
                <label for="itemUnit">Unit</label>
                <input type="text" id="itemUnit" class="form-control" placeholder="e.g., pcs, kg, m">
              </div>
              <div class="form-group">
                <label for="itemStock">Stock Quantity</label>
                <input type="number" id="itemStock" class="form-control" placeholder="Enter stock quantity" min="0">
              </div>
              <div class="form-group">
                <label for="itemPrice">Price</label>
                <input type="number" id="itemPrice" class="form-control" placeholder="Enter price" step="0.01" min="0">
              </div>
            </div>

            <div class="form-group">
              <label for="itemDescription">Description</label>
              <textarea id="itemDescription" class="form-control" placeholder="Enter item description" rows="3"></textarea>
            </div>

            <div class="form-group">
              <label for="itemImages">Images</label>
              <div class="image-upload-section">
                <input type="file" id="itemImages" class="form-control" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx" multiple>
                <div class="image-preview" id="imagePreview"></div>
                                  <p class="upload-hint">You can select multiple files. Supported formats: Images (JPG, PNG, GIF, WebP), Documents (PDF, DOC, DOCX, XLS, XLSX)</p>
              </div>
            </div>

            <div class="form-group">
              <label for="itemNotes">Notes</label>
              <textarea id="itemNotes" class="form-control" placeholder="Enter any additional notes" rows="3"></textarea>
            </div>
          </form>
        </div>
      </div>

      <!-- Settings Page -->
      <div id="settings" class="page-section">
        <div class="header">
          <div class="header-left">
            <button class="btn-secondary" onclick="showPage('dashboard', event)" style="margin-right: 16px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              Back to Dashboard
            </button>
            <h1>Account Settings</h1>
          </div>
          <div class="header-actions">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Status Messages -->
        <div id="settingsStatusMessage"></div>

        <!-- Settings Content -->
        <div class="settings-wrapper" style="max-width: 800px; margin: 0 auto; padding: 20px;">
          <!-- Profile Picture Section -->
          <div class="section" style="background: var(--card-bg); border-radius: 12px; padding: 32px; margin-bottom: 24px; box-shadow: var(--shadow); border: 1px solid var(--border-color);">
            <div class="profile-section" style="display: flex; align-items: center; gap: 24px; margin-bottom: 24px;">
              <img src="" alt="Profile Picture" class="profile-pic" id="profilePic" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">
              <div class="profile-info">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">Profile picture</h3>
                <p style="color: var(--text-secondary); font-size: 14px;">Upload PNG, JPEG under 15MB to change your profile picture</p>
              </div>
            </div>
            <div class="profile-actions" style="display: flex; gap: 12px;">
              <button class="btn btn-primary" id="uploadPicBtn" type="button" style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--active-color); color: white; cursor: pointer; font-size: 14px; transition: all 0.2s ease;">Change Picture</button>
              <button class="btn" id="deletePicBtn" type="button" style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); color: var(--text-primary); cursor: pointer; font-size: 14px; transition: all 0.2s ease;">Delete</button>
            </div>
          </div>

          <!-- Full Name Section -->
          <div class="section" style="background: var(--card-bg); border-radius: 12px; padding: 32px; margin-bottom: 24px; box-shadow: var(--shadow); border: 1px solid var(--border-color);">
            <h2 class="section-title" style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Full name</h2>
            <form id="nameForm">
              <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                <div class="form-group" style="margin-bottom: 20px;">
                  <label class="form-label" style="display: block; font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 6px;">First name</label>
                  <input type="text" class="form-input" id="firstName" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                  <label class="form-label" style="display: block; font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 6px;">Last name</label>
                  <input type="text" class="form-input" id="lastName" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--input-bg); color: var(--text-primary);">
                </div>
              </div>
              <button class="btn btn-primary" type="submit" style="padding: 8px 16px; border: 1px solid var(--active-color); border-radius: 6px; background: var(--active-color); color: white; cursor: pointer; font-size: 14px; transition: all 0.2s ease;">Save Name</button>
              <div class="status-msg" id="nameStatus" style="text-align: center; color: var(--success-color); font-size: 15px; margin-top: 10px; min-height: 20px;"></div>
            </form>
          </div>

          <!-- Contact Email Section -->
          <div class="section" style="background: var(--card-bg); border-radius: 12px; padding: 32px; margin-bottom: 24px; box-shadow: var(--shadow); border: 1px solid var(--border-color);">
            <h2 class="section-title" style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Contact email</h2>
            <p class="section-description" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 24px;">Manage your account's email address for the invoices.</p>
            <form id="emailForm">
              <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label" style="display: block; font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 6px;">Email</label>
                <div class="email-input" style="position: relative;">
                  <span class="email-icon" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 16px;">ðŸ“§</span>
                  <input type="email" class="form-input" id="email" required style="width: 100%; padding: 12px; padding-left: 40px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--input-bg); color: var(--text-primary);">
                </div>
              </div>
              <div id="additionalEmails"></div>
              <button class="btn btn-primary" type="submit" style="padding: 8px 16px; border: 1px solid var(--active-color); border-radius: 6px; background: var(--active-color); color: white; cursor: pointer; font-size: 14px; transition: all 0.2s ease;">Save Email</button>
              <div class="status-msg" id="emailStatus" style="text-align: center; color: var(--success-color); font-size: 15px; margin-top: 10px; min-height: 20px;"></div>
            </form>
            <button class="add-email-btn" type="button" id="addEmailBtn" style="color: var(--active-color); background: none; border: none; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; margin-top: 12px;">
              <span>âž•</span> Add another email
            </button>
          </div>

          <!-- Company Logo Section -->
          <div class="section" style="background: var(--card-bg); border-radius: 12px; padding: 32px; margin-bottom: 24px; box-shadow: var(--shadow); border: 1px solid var(--border-color);">
            <h2 class="section-title" style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Company Logo</h2>
            <p class="section-description" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 24px;">Upload your company logo to appear on invoices.</p>
            <div class="profile-section" style="display: flex; align-items: center; gap: 24px; margin-bottom: 24px;">
              <img src="" alt="Company Logo" class="profile-pic" id="companyLogo" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; max-width: 200px; max-height: 200px;">
              <div class="profile-info">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">Company logo</h3>
                <p style="color: var(--text-secondary); font-size: 14px;">PNG, JPEG under 5MB. Recommended size: 200x200px</p>
              </div>
            </div>
            <div class="profile-actions" style="display: flex; gap: 12px;">
              <button class="btn btn-primary" id="uploadLogoBtn" type="button" style="padding: 8px 16px; border: 1px solid var(--active-color); border-radius: 6px; background: var(--active-color); color: white; cursor: pointer; font-size: 14px; transition: all 0.2s ease;">Upload Logo</button>
              <button class="btn" id="deleteLogoBtn" type="button" style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); color: var(--text-primary); cursor: pointer; font-size: 14px; transition: all 0.2s ease;">Remove Logo</button>
              <button class="btn" id="resetLogoBtn" type="button" style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); color: var(--text-primary); cursor: pointer; font-size: 14px; transition: all 0.2s ease;">Reset to Default</button>
            </div>
            <div class="status-msg" id="logoStatus" style="text-align: center; color: var(--success-color); font-size: 15px; margin-top: 10px; min-height: 20px;"></div>
          </div>

          <!-- Password Section -->
          <div class="section" style="background: var(--card-bg); border-radius: 12px; padding: 32px; margin-bottom: 24px; box-shadow: var(--shadow); border: 1px solid var(--border-color);">
            <h2 class="section-title" style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Password</h2>
            <p class="section-description" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 24px;">Modify your current password.</p>
            <form id="passwordForm">
              <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                <div class="form-group" style="margin-bottom: 20px;">
                  <label class="form-label" style="display: block; font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 6px;">Current password</label>
                  <div class="password-input" style="position: relative;">
                    <input type="password" class="form-input" id="currentPassword" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--input-bg); color: var(--text-primary);">
                    <button class="password-toggle" type="button" onclick="togglePassword('currentPassword', this)" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-secondary); font-size: 14px;">ðŸ‘ï¸</button>
                  </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                  <label class="form-label" style="display: block; font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 6px;">New password</label>
                  <div class="password-input" style="position: relative;">
                    <input type="password" class="form-input" id="newPassword" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: var(--input-bg); color: var(--text-primary);">
                    <button class="password-toggle" type="button" onclick="togglePassword('newPassword', this)" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-secondary); font-size: 14px;">ðŸ‘ï¸</button>
                  </div>
                </div>
              </div>
              <button class="btn btn-primary" type="submit" style="padding: 8px 16px; border: 1px solid var(--active-color); border-radius: 6px; background: var(--active-color); color: white; cursor: pointer; font-size: 14px; transition: all 0.2s ease;">Change Password</button>
              <div class="status-msg" id="passwordStatus" style="text-align: center; color: var(--success-color); font-size: 15px; margin-top: 10px; min-height: 20px;"></div>
              <div class="error-msg" id="passwordError" style="text-align: center; color: var(--error-color); font-size: 15px; margin-top: 10px; min-height: 20px;"></div>
            </form>
          </div>
        </div>
      </div>

      <!-- Help Page -->
      <div id="help" class="page-section">
        <div class="header">
          <div class="header-left">
            <button class="btn-secondary" onclick="showPage('dashboard', event)" style="margin-right: 16px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              Back to Dashboard
            </button>
            <h1>Help & Support</h1>
          </div>
          <div class="header-actions">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
            <button class="btn-primary" onclick="contactSupport()">Contact Support</button>
          </div>
        </div>

        <!-- Help Content -->
        <div class="help-wrapper" style="max-width: 800px; margin: 0 auto; padding: 20px;">
          <div class="search-box" style="background: var(--card-bg); padding: 15px; border-radius: 8px; margin-bottom: 30px; border: 1px solid var(--border-color);">
            <input type="text" class="search-input" placeholder="Search for help topics..." style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; background: var(--input-bg); color: var(--text-primary);">
          </div>

          <div class="quick-links" style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
            <a href="#getting-started" class="quick-link" style="padding: 8px 16px; background: var(--active-color); color: white; text-decoration: none; border-radius: 4px; font-size: 14px; transition: background 0.2s;">Getting Started</a>
            <a href="#invoices" class="quick-link" style="padding: 8px 16px; background: var(--active-color); color: white; text-decoration: none; border-radius: 4px; font-size: 14px; transition: background 0.2s;">Managing Invoices</a>
            <a href="#customers" class="quick-link" style="padding: 8px 16px; background: var(--active-color); color: white; text-decoration: none; border-radius: 4px; font-size: 14px; transition: background 0.2s;">Customer Management</a>
            <a href="#payments" class="quick-link" style="padding: 8px 16px; background: var(--active-color); color: white; text-decoration: none; border-radius: 4px; font-size: 14px; transition: background 0.2s;">Payment Setup</a>
            <a href="#reports" class="quick-link" style="padding: 8px 16px; background: var(--active-color); color: white; text-decoration: none; border-radius: 4px; font-size: 14px; transition: background 0.2s;">Reports</a>
          </div>

          <div class="help-section" id="getting-started" style="margin-bottom: 40px;">
            <h2 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--active-color);">Getting Started</h2>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">Welcome to Tiger Invoice! This guide will help you get started with managing your invoices and customers effectively.</p>
            
            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Dashboard Overview</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">Your dashboard provides a quick overview of your invoice status:</p>
            <ul style="margin-left: 20px; margin-bottom: 15px;">
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;"><strong>Total Invoices:</strong> Shows the total number of invoices created</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;"><strong>Paid:</strong> Number of invoices that have been paid</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;"><strong>Pending:</strong> Invoices awaiting payment</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;"><strong>Overdue:</strong> Invoices past their due date</li>
            </ul>

            <div class="alert" style="padding: 15px; border-radius: 4px; margin: 15px 0; border-left: 4px solid var(--success-color); background: #dcfce7; color: var(--success-color);">
              <strong>Pro Tip:</strong> Check your dashboard regularly to stay on top of overdue invoices and follow up with customers.
            </div>
          </div>

          <div class="help-section" id="invoices" style="margin-bottom: 40px;">
            <h2 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--active-color);">Managing Invoices</h2>
            
            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Creating a New Invoice</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">To create a new invoice:</p>
            <ul style="margin-left: 20px; margin-bottom: 15px;">
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Click the "Create Invoice" button in the top-right corner</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Select or add a customer</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Add items or services with descriptions and amounts</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Set payment terms and due date</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Save as draft or send immediately</li>
            </ul>

            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Invoice Status</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">Understanding invoice statuses:</p>
            <div class="feature-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
              <div class="feature-card" style="background: var(--card-bg); padding: 20px; border-radius: 8px; border-left: 4px solid var(--active-color); border: 1px solid var(--border-color);">
                <h3 style="color: var(--active-color); margin-top: 0;">Draft</h3>
                <p style="line-height: 1.6; color: var(--text-secondary);">Invoice is saved but not yet sent to customer. You can edit and modify draft invoices.</p>
              </div>
              <div class="feature-card" style="background: var(--card-bg); padding: 20px; border-radius: 8px; border-left: 4px solid var(--active-color); border: 1px solid var(--border-color);">
                <h3 style="color: var(--active-color); margin-top: 0;">Sent</h3>
                <p style="line-height: 1.6; color: var(--text-secondary);">Invoice has been sent to the customer via email.</p>
              </div>
              <div class="feature-card" style="background: var(--card-bg); padding: 20px; border-radius: 8px; border-left: 4px solid var(--active-color); border: 1px solid var(--border-color);">
                <h3 style="color: var(--active-color); margin-top: 0;">Paid</h3>
                <p style="line-height: 1.6; color: var(--text-secondary);">Payment has been received and recorded.</p>
              </div>
              <div class="feature-card" style="background: var(--card-bg); padding: 20px; border-radius: 8px; border-left: 4px solid var(--active-color); border: 1px solid var(--border-color);">
                <h3 style="color: var(--active-color); margin-top: 0;">Overdue</h3>
                <p style="line-height: 1.6; color: var(--text-secondary);">Invoice payment is past the due date.</p>
              </div>
            </div>

            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Editing Invoices</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">You can edit draft invoices at any time. For sent invoices, you can:</p>
            <ul style="margin-left: 20px; margin-bottom: 15px;">
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Add payments</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Send reminders</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Create credit notes</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Duplicate for similar invoices</li>
            </ul>
          </div>

          <div class="help-section" id="customers" style="margin-bottom: 40px;">
            <h2 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--active-color);">Customer Management</h2>
            
            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Adding New Customers</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">Navigate to the Customers section to add new customers. Include:</p>
            <ul style="margin-left: 20px; margin-bottom: 15px;">
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Company name and contact person</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Email address for invoice delivery</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Billing address</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Payment terms and preferred payment method</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Tax information if applicable</li>
            </ul>

            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Customer History</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">View complete customer history including:</p>
            <ul style="margin-left: 20px; margin-bottom: 15px;">
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">All invoices sent to the customer</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Payment history</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Outstanding balances</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Communication log</li>
            </ul>

            <div class="alert warning" style="padding: 15px; border-radius: 4px; margin: 15px 0; border-left: 4px solid var(--warning-color); background: #fff3cd; color: var(--warning-color);">
              <strong>Important:</strong> Always verify customer email addresses before sending invoices to avoid delivery issues.
            </div>
          </div>

          <div class="help-section" id="payments" style="margin-bottom: 40px;">
            <h2 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--active-color);">Payment Setup</h2>
            
            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Payment Methods</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">Configure your accepted payment methods:</p>
            <ul style="margin-left: 20px; margin-bottom: 15px;">
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Bank transfer details</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Credit card processing</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">PayPal integration</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Cryptocurrency options</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Check payments</li>
            </ul>

            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Recording Payments</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">When you receive payment:</p>
            <ul style="margin-left: 20px; margin-bottom: 15px;">
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Go to the invoice and click "Record Payment"</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Enter payment amount and method</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Add payment date and reference number</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Save to update invoice status</li>
            </ul>

            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Partial Payments</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">Tiger Invoice supports partial payments. You can record multiple payments against a single invoice until the full amount is paid.</p>
          </div>

          <div class="help-section" id="reports" style="margin-bottom: 40px;">
            <h2 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--active-color);">Reports and Analytics</h2>
            
            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Available Reports</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">Access detailed reports from the Reports section:</p>
            <ul style="margin-left: 20px; margin-bottom: 15px;">
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;"><strong>Sales Report:</strong> Revenue over time</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;"><strong>Customer Report:</strong> Customer payment history</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;"><strong>Tax Report:</strong> Tax collected and owed</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;"><strong>Aging Report:</strong> Outstanding invoices by age</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;"><strong>Profit & Loss:</strong> Business profitability</li>
            </ul>

            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Exporting Data</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">Export reports in multiple formats:</p>
            <div class="code-block" style="background: var(--card-bg); padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 14px; margin: 10px 0; border-left: 4px solid var(--active-color); border: 1px solid var(--border-color);">
              PDF - For printing and sharing<br>
              Excel - For further analysis<br>
              CSV - For importing into other systems
            </div>
          </div>

          <div class="help-section" style="margin-bottom: 40px;">
            <h2 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--active-color);">Troubleshooting</h2>
            
            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Common Issues</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;"><strong>Invoice not sending:</strong> Check customer email address and your email settings.</p>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;"><strong>Payment not recording:</strong> Ensure you have the correct invoice number and payment amount.</p>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;"><strong>Dashboard not updating:</strong> Refresh the page or check your internet connection.</p>

            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 10px 0;">Getting More Help</h3>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">If you need additional assistance:</p>
            <ul style="margin-left: 20px; margin-bottom: 15px;">
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Check our FAQ section</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Contact support via email</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Schedule a training session</li>
              <li style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 8px;">Join our user community forum</li>
            </ul>

            <div class="alert" style="padding: 15px; border-radius: 4px; margin: 15px 0; border-left: 4px solid var(--success-color); background: #dcfce7; color: var(--success-color);">
              <strong>Support Hours:</strong> Monday-Friday, 9 AM - 6 PM EST. We typically respond within 24 hours.
            </div>
          </div>

          <div class="help-section" style="margin-bottom: 40px;">
            <h2 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--active-color);">Keyboard Shortcuts</h2>
            <p style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 15px;">Speed up your workflow with these keyboard shortcuts:</p>
            <div class="code-block" style="background: var(--card-bg); padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 14px; margin: 10px 0; border-left: 4px solid var(--active-color); border: 1px solid var(--border-color);">
              Ctrl + N - Create new invoice<br>
              Ctrl + S - Save current invoice<br>
              Ctrl + F - Search invoices<br>
              Ctrl + P - Print current invoice<br>
              Esc - Close modal/dialog
            </div>
          </div>
        </div>
      </div>



           <!-- Notifications Page -->
      <div id="notifications" class="page-section">
        <div class="header">
          <h1>Notifications</h1>
          <div class="header-actions">
            <button class="btn-secondary" onclick="markAllAsRead()">Mark All as Read</button>
            <button class="btn-secondary" onclick="clearAllNotifications()">Clear All</button>
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Toggle theme">
              <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Status Messages -->
        <div id="notificationStatusMessage"></div>

        <!-- Notifications Content -->
        <div class="notifications-wrapper">
          <!-- Notification Filters -->
          <div class="notification-filters">
            <button class="filter-btn active" onclick="filterNotifications('all')">All</button>
            <button class="filter-btn" onclick="filterNotifications('unread')">Unread</button>
            <button class="filter-btn" onclick="filterNotifications('overdue')">Overdue</button>
            <button class="filter-btn" onclick="filterNotifications('stock')">Low Stock</button>
            <button class="filter-btn" onclick="filterNotifications('system')">System</button>
          </div>

          <!-- Notifications List -->
          <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be loaded here -->
          </div>

          <!-- Empty State -->
          <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
              </svg>
            </div>
            <h3>No Notifications</h3>
            <p>You're all caught up! Check back later for new updates.</p>
          </div>
        </div>
      </div>

      <!-- All Invoices Page -->
      <div id="all-invoices" class="page-section">
       <div class="header">
         <h1>All Invoices</h1>
         <div class="header-actions">
           <button class="btn-secondary" onclick="showPage('dashboard')" style="margin-right: 8px;">
             <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
               <path d="M19 12H5M12 19l-7-7 7-7"/>
             </svg>
             Back to Dashboard
           </button>
           <button class="btn-primary" onclick="showPage('create-invoice')" style="margin-right: 8px;">
             <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
               <line x1="12" y1="5" x2="12" y2="19"></line>
               <line x1="5" y1="12" x2="19" y2="12"></line>
             </svg>
             Create New Invoice
           </button>
           <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
               <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
             </svg>
           </button>
         </div>
       </div>

       <!-- Status Messages -->
       <div id="allInvoicesStatusMessage"></div>

       <!-- Invoice Statistics Cards -->
       <div class="invoice-stats-grid">
         <div class="stat-card">
           <div class="stat-header">TOTAL INVOICES</div>
           <div class="stat-value" id="allTotalInvoices">0</div>
         </div>
         <div class="stat-card">
           <div class="stat-header">PAID</div>
           <div class="stat-value" id="allPaidInvoices">0</div>
         </div>
         <div class="stat-card">
           <div class="stat-header">PENDING</div>
           <div class="stat-value" id="allPendingInvoices">0</div>
         </div>
         <div class="stat-card">
           <div class="stat-header">OVERDUE</div>
           <div class="stat-value" id="allOverdueInvoices">0</div>
         </div>
       </div>

       <!-- Search and Filter Section -->
       <div class="search-filter-section">
         <div class="search-box">
           <input type="text" id="invoiceSearch" placeholder="Search invoices..." onkeyup="filterInvoices()">
           <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
             <circle cx="11" cy="11" r="8"></circle>
             <path d="m21 21-4.35-4.35"></path>
           </svg>
         </div>
         <div class="filter-buttons">
           <button class="filter-btn active" onclick="filterInvoicesByStatus('all')">All</button>
           <button class="filter-btn" onclick="filterInvoicesByStatus('paid')">Paid</button>
           <button class="filter-btn" onclick="filterInvoicesByStatus('pending')">Pending</button>
           <button class="filter-btn" onclick="filterInvoicesByStatus('overdue')">Overdue</button>
           <button class="filter-btn" onclick="filterInvoicesByStatus('draft')">Draft</button>
         </div>
       </div>

       <!-- All Invoices Table -->
       <div class="invoices-table-container">
         <table class="invoices-table">
           <thead>
             <tr>
               <th>Invoice Number</th>
               <th>Customer Name</th>
               <th>Date</th>
               <th>Status</th>
               <th>Total</th>
               <th>Actions</th>
             </tr>
           </thead>
           <tbody id="allInvoicesList">
             <!-- All invoices will be loaded here -->
           </tbody>
         </table>
       </div>

       <!-- Empty State -->
       <div class="empty-state" id="emptyInvoicesState" style="display: none;">
         <div class="empty-icon">
           <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
             <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
             <polyline points="14,2 14,8 20,8"></polyline>
             <line x1="16" y1="13" x2="8" y2="13"></line>
             <line x1="16" y1="17" x2="8" y2="17"></line>
             <polyline points="10,9 9,9 8,9"></polyline>
           </svg>
         </div>
         <h3>No Invoices Found</h3>
         <p>Create your first invoice to get started with your business</p>
         <button class="btn-primary" onclick="showPage('create-invoice')">Create Invoice</button>
       </div>
     </div>
    </div>
  </div>

      <!-- Other page sections will be added here -->
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC2vUhY8zpsS60dAaxIVXqszC5180sGobc",
      authDomain: "tigerpower-86ca1.firebaseapp.com",
      projectId: "tigerpower-86ca1",
      storageBucket: "tigerpower-86ca1.appspot.com",
      databaseURL: "https://tigerpower-86ca1-default-rtdb.asia-southeast1.firebasedatabase.app",
      messagingSenderId: "493107786425",
      appId: "1:493107786425:web:39a1448aeba5b9e619e168"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const rtdb = firebase.database();
    const storage = firebase.storage();

    // User-specific data paths and security
    function getUserDataPath(path = '') {
      const user = auth.currentUser;
      if (!user) {
        console.error('No authenticated user');
        return null;
      }
      return `users/${user.uid}/${path}`;
    }



    // Make Firebase services available globally with user isolation
    window.firebase = {
      app: app,
      auth: auth,
      rtdb: rtdb,
      storage: storage,
      // Auth providers
      GoogleAuthProvider: firebase.auth.GoogleAuthProvider,
      // User-specific data helpers
      getUserDataPath: getUserDataPath
    };

    console.log('Firebase initialized successfully with RTDB only - Authentication and Realtime Database');
    
    // Test Firebase connection
    function testFirebaseConnection() {
      const user = auth.currentUser;
      if (!user) {
        console.log('No user logged in');
        return false;
      }
      
      const testPath = `users/${user.uid}/test`;
      rtdb.ref(testPath).set({
        test: true,
        timestamp: new Date().toISOString()
      })
      .then(() => {
        console.log('Firebase connection test successful');
        rtdb.ref(testPath).remove(); // Clean up test data
      })
      .catch(err => {
        console.error('Firebase connection test failed:', err);
      });
    }
    
    // Test connection on page load
    setTimeout(testFirebaseConnection, 2000);
    
    // Test Firebase save function
    function testFirebaseSave() {
      const user = auth.currentUser;
      if (!user) {
        alert('Please log in first');
        return;
      }
      
      console.log('Testing Firebase connection for user:', user.uid);
      
      const testData = {
        test: true,
        message: 'Firebase connection test',
        timestamp: new Date().toISOString(),
        userId: user.uid,
        binaryTest: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
      };
      
      const testPath = `users/${user.uid}/test_save`;
      console.log('Test path:', testPath);
      
      rtdb.ref(testPath).set(testData)
        .then(() => {
          console.log('Test data saved successfully:', testData);
          alert('Firebase save test successful! Check console for details.');
          return rtdb.ref(testPath).once('value');
        })
        .then((snapshot) => {
          const savedData = snapshot.val();
          console.log('Retrieved test data:', savedData);
          return rtdb.ref(testPath).remove(); // Clean up
        })
        .then(() => {
          console.log('Test data cleaned up successfully');
          alert('Test data cleaned up successfully.');
        })
        .catch(err => {
          console.error('Firebase test failed:', err);
          alert('Firebase save test failed: ' + err.message);
        });
    }
  </script>
  <!-- PDF Generation Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // Theme management
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeUI(savedTheme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeUI(newTheme);
    }
    
    // Make toggleTheme globally accessible
    window.toggleTheme = toggleTheme;

    function updateThemeUI(theme) {
      const themeIcon = document.getElementById('themeIcon');
      
      if (theme === 'dark') {
        // Sun icon for light mode
        themeIcon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
      } else {
        // Moon icon for dark mode
        themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
      }
    }



    // Firebase services are available globally via window.firebase
    console.log('Firebase services loaded from global window.firebase');

    // Auth state check - moved after Firebase initialization
    auth.onAuthStateChanged(function(user) {
      console.log('Auth state changed:', user ? 'User logged in' : 'No user');
      if (!user) {
        console.log('No user found, checking if we should redirect');
        // Only redirect if we're not already on the login page
        if (window.location.pathname.indexOf('login.html') === -1) {
          console.log('Redirecting to login page');
          removeRealTimeListeners(); // Clean up listeners
          window.location.href = 'login.html';
        }
      } else {
        console.log('User authenticated, setting up real-time listeners');
        // Set up real-time listeners after a short delay to ensure Firebase is ready
        setTimeout(() => {
          setupRealTimeListeners();
        }, 1000);
        // Update sidebar user info
        updateSidebarUserInfo();
        
        // Initialize settings to load profile picture
        initializeSettings();
        
        // Initialize invoice form with default dates
        setTimeout(() => {
          const today = new Date();
          const dueDate = new Date(today.getTime() + 28 * 24 * 60 * 60 * 1000); // 30 days from now
          
          // Set default dates if elements exist
          if (document.getElementById('invoiceDate')) {
            document.getElementById('invoiceDate').valueAsDate = today;
          }
          if (document.getElementById('dateShip')) {
            document.getElementById('dateShip').valueAsDate = today;
          }
          if (document.getElementById('soDate')) {
            document.getElementById('soDate').valueAsDate = today;
          }
          if (document.getElementById('dateDue')) {
            document.getElementById('dateDue').valueAsDate = dueDate;
          }
          
          // Initialize calculations
          if (document.getElementById('itemsBody')) {
            calculateTotals();
          }
        }, 100);
      }
    });

    // Logout function
    function logout() {
      auth.signOut().then(() => {
        window.location.href = 'login.html';
      });
    }



    // Page navigation with data loading
    function showPage(pageId, event = null) {
      console.log('showPage called with:', pageId);
      
      // Debug auth state
      const user = auth.currentUser;
      console.log('Current user:', user ? user.uid : 'No user');
      
      // Check if we're already on the target page
      const currentActivePage = document.querySelector('.page-section.active');
      if (currentActivePage && currentActivePage.id === pageId) {
        console.log(`Already on page '${pageId}'`);
        return;
      }
      
      // Hide all pages
      document.querySelectorAll('.page-section').forEach(page => {
        page.classList.remove('active');
      });
      
      // Show selected page
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.add('active');
        console.log(`Page '${pageId}' activated`);
      } else {
        console.warn(`Page with id '${pageId}' not found`);
        // Fallback to dashboard if page doesn't exist
        document.getElementById('dashboard').classList.add('active');
        return;
      }
      
      // Update navigation active state
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Find and activate the clicked nav item if event is provided
      if (event && event.target) {
        event.target.classList.add('active');
      }



      // Load data for specific pages
      if (pageId === 'create-invoice') {
        initializeInvoiceForm();
      }
      if (pageId === 'add-customer') {
        initializeCustomerForm();
      }
      if (pageId === 'add-item') {
        initializeItemForm();
      }
      if (pageId === 'settings') {
        initializeSettings();
      }
              if (pageId === 'dashboard') {
          loadDashboardStats();
        }
        
        if (pageId === 'notifications') {
          loadNotifications();
        }
        
        if (pageId === 'create-invoice') {
        // Add a small delay to ensure the form is fully loaded
        setTimeout(() => {
          loadEditInvoiceData();
          loadCustomerAndItemInfo(); // Load customer and item information
        }, 100);
      }
      if (pageId === 'all-invoices') {
        loadAllInvoices();
      }
    }

    // Invoice form functions
    async function initializeInvoiceForm() {
      try {
        // Check if user is authenticated
        const user = auth.currentUser;
        if (!user) {
          console.log('User not authenticated, initializing form without data loading');
          // Still set default dates even if not authenticated
          const today = new Date().toISOString().split('T')[0];
          const dueDate = new Date();
          dueDate.setDate(dueDate.getDate() + 30);
          const dueDateStr = dueDate.toISOString().split('T')[0];
          
          const invoiceDateElement = document.getElementById('invoiceDate');
          if (invoiceDateElement) {
            invoiceDateElement.value = today;
          }
          
          const dateDueElement = document.getElementById('dateDue');
          if (dateDueElement) {
            dateDueElement.value = dueDateStr;
          }
          return;
        }
        
        // Set default dates
        const today = new Date().toISOString().split('T')[0];
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 30);
        const dueDateStr = dueDate.toISOString().split('T')[0];
        
        const invoiceDateElement = document.getElementById('invoiceDate');
        if (invoiceDateElement) {
          invoiceDateElement.value = today;
        }
        
        const dateDueElement = document.getElementById('dateDue');
        if (dateDueElement) {
          dateDueElement.value = dueDateStr;
        }
        
        // Load customers and items for dropdowns
        await loadCustomersForInvoice();
        await loadItemsForInvoice();
        
        // Load customer and item information for display
        await loadCustomerAndItemInfo();
        
        // Initialize logo upload handler
        handleInvoiceLogoUpload();
      } catch (error) {
        console.error('Error initializing invoice form:', error);
      }
    }

    async function loadCustomersForInvoice() {
      const user = auth.currentUser;
      if (!user) {
        console.log('No user found for loading customers');
        return;
      }
      
      try {
        const userPath = window.firebase.getUserDataPath('customers');
        if (!userPath) return;
        const snapshot = await window.firebase.rtdb.ref(userPath).once('value');
        const customers = snapshot.val();
        const customerSelect = document.getElementById('customerSelect');
        
        if (customerSelect) {
          customerSelect.innerHTML = '<option value="">Select Customer</option>';
          
          if (customers) {
            Object.values(customers).forEach(customer => {
              const option = document.createElement('option');
              option.value = customer.id || customer.name;
              option.textContent = `${customer.name || 'N/A'} (${customer.id || 'N/A'})`;
              customerSelect.appendChild(option);
            });
          }
        }
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    async function loadItemsForInvoice() {
      const user = auth.currentUser;
      if (!user) {
        console.log('No user found for loading items');
        return;
      }
      
      try {
        console.log('=== LOAD ITEMS FOR INVOICE START ===');
        
        // Test different possible paths (same as customers and recent items)
        console.log('=== INVOICE ITEM SELECT - TESTING DATABASE PATHS ===');
        
        // Test 1: Try user-specific path
        const snapshot = await rtdb.ref(`users/${user.uid}/items`).once('value');
        const items = snapshot.val();
        console.log('Path 1 - users/${user.uid}/items:', items);
        console.log('Path 1 item count:', items ? Object.keys(items).length : 0);
        
        // Test 2: Try without user path
        const snapshot2 = await rtdb.ref('items').once('value');
        const items2 = snapshot2.val();
        console.log('Path 2 - items:', items2);
        console.log('Path 2 item count:', items2 ? Object.keys(items2).length : 0);
        
        // Test 3: Try with different user path structure
        const snapshot3 = await rtdb.ref(`items/${user.uid}`).once('value');
        const items3 = snapshot3.val();
        console.log('Path 3 - items/${user.uid}:', items3);
        console.log('Path 3 item count:', items3 ? Object.keys(items3).length : 0);
        
        // Use the path with the most items (same logic as customers)
        let finalItems = items;
        let itemCount = items ? Object.keys(items).length : 0;
        
        if (items2 && Object.keys(items2).length > itemCount) {
          finalItems = items2;
          itemCount = Object.keys(items2).length;
          console.log('Using Path 2 (items) - found more items');
        }
        
        if (items3 && Object.keys(items3).length > itemCount) {
          finalItems = items3;
          itemCount = Object.keys(items3).length;
          console.log('Using Path 3 (items/${user.uid}) - found more items');
        }
        
        console.log('Final items data for invoice:', finalItems);
        console.log('Final item count for invoice:', itemCount);
        
        const itemSelects = document.querySelectorAll('.item-select');
        
        if (itemSelects.length > 0 && finalItems) {
          console.log('=== INVOICE ITEM SELECT DATA ANALYSIS ===');
          console.log('Invoice select items - Raw data:', finalItems);
          console.log('Total items in database:', Object.keys(finalItems).length);
          console.log('Item keys:', Object.keys(finalItems));
          
          const allItems = Object.entries(finalItems);
          console.log('All item entries:', allItems.length);
          console.log('Item entries details:', allItems.map(([id, item]) => ({ id, item: item ? 'exists' : 'null/undefined' })));
          
          const filteredItems = allItems.filter(([id, item]) => {
            const isValid = item && item !== null && item !== undefined;
            if (!isValid) {
              console.log('Filtering out item:', id, 'because item is:', item);
            }
            return isValid;
          });
          console.log('Items after filtering null/undefined:', filteredItems.length);
          
          console.log('=== INVOICE ITEM SELECT MAPPING ===');
          const mappedItems = filteredItems.map(([id, item]) => ({ id, ...item }));
          console.log('Mapped items count:', mappedItems.length);
          console.log('Mapped items with details:', mappedItems.map(i => ({ 
            id: i.id, 
            name: i.name || i.itemName, 
            code: i.code || i.itemCode,
            price: i.sellingPrice || i.price,
            hasData: !!(i.name || i.itemName)
          })));
          
          console.log('=== PROCESSING ITEMS FOR INVOICE SELECT ===');
          itemSelects.forEach((select, selectIndex) => {
            console.log(`Processing select ${selectIndex + 1}:`, select);
            
            select.innerHTML = '<option value="">Select Item</option>';
            
            mappedItems.forEach((item, index) => {
              console.log(`Processing item ${index + 1} for invoice select:`, item);
              
              const option = document.createElement('option');
              const itemCode = item.code || item.itemCode || item.id || '';
              const itemName = item.name || item.itemName || 'N/A';
              const itemPrice = item.sellingPrice || item.price || 0;
              
              option.value = itemCode;
              option.textContent = `${itemName} (${itemCode})`;
              option.dataset.price = itemPrice;
              option.dataset.description = itemName;
              
              console.log('Invoice item select data:', { itemCode, itemName, itemPrice });
              
              select.appendChild(option);
              console.log(`Item ${index + 1} option added to invoice select ${selectIndex + 1}`);
            });
            
            console.log(`Invoice select ${selectIndex + 1} - Total options:`, select.options.length);
          });
          
          console.log('=== FINAL INVOICE SELECT ITEMS ===');
          console.log('Total selects processed:', itemSelects.length);
          console.log('Invoice select items - Processed data:', mappedItems);
        } else {
          console.log('=== NO ITEMS FOUND FOR INVOICE SELECT ===');
          console.log('No items found for invoice select dropdowns');
          if (itemSelects.length > 0) {
            itemSelects.forEach(select => {
              select.innerHTML = '<option value="">Select Item</option>';
            });
          }
        }
        
        console.log('=== LOAD ITEMS FOR INVOICE END ===');
      } catch (error) {
        console.error('Error loading items:', error);
      }
    }

    function updateItemDetails(selectElement) {
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      const row = selectElement.closest('tr');
      const descriptionInput = row.querySelector('.item-description');
      const priceInput = row.querySelector('.item-price');
      
      if (selectedOption.value) {
        descriptionInput.value = selectedOption.dataset.description || '';
        priceInput.value = selectedOption.dataset.price || '0.00';
        calculateRowAmount(priceInput);
      }
    }









    async function saveInvoice() {
      const user = auth.currentUser;
      if (!user) {
        alert('You must be logged in to save invoices.');
        return;
      }

      // Check if we're editing an existing invoice
      const editData = sessionStorage.getItem('editInvoiceData');
      let isEditMode = false;
      let editInvoiceId = null;
      
      if (editData) {
        try {
          const invoice = JSON.parse(editData);
          isEditMode = true;
          editInvoiceId = invoice.id;
        } catch (error) {
          console.error('Error parsing edit data:', error);
        }
      }

      // Validate required fields
      const requiredFields = ['customer', 'customerName', 'invoiceNo', 'invoiceDate'];
      const missingFields = [];
      
      requiredFields.forEach(field => {
        const value = document.getElementById(field).value.trim();
        if (!value) {
          missingFields.push(field.replace(/([A-Z])/g, ' $1').toLowerCase());
        }
      });
      
      if (missingFields.length > 0) {
        alert('Please fill in the following required fields:\n' + missingFields.join('\n'));
        return;
      }
      
      // Check if at least one item is added
      const rows = document.querySelectorAll('#itemsBody tr');
      let hasItems = false;
      rows.forEach(row => {
        const itemCode = row.cells[0].querySelector('input').value.trim();
        const itemDesc = row.cells[1].querySelector('input').value.trim();
        if (itemCode && itemDesc) {
          hasItems = true;
        }
      });
      
      if (!hasItems) {
        alert('Please add at least one item to the invoice.');
        return;
      }

      // Show loading state
      const saveBtn = document.querySelector('button[onclick="saveInvoice()"]');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12,6 12,12 16,14"></polyline></svg>Saving...';
      saveBtn.disabled = true;

      // Upload logo first
      const logoData = await uploadInvoiceLogoToStorage();

      const invoiceData = {
        customer: {
          code: document.getElementById('customer').value,
          name: document.getElementById('customerName').value,
          contact: document.getElementById('contact').value,
          address: document.getElementById('address').value,
          phone: document.getElementById('phone').value,
          group: document.getElementById('customerGroup').value,
          taxNumber: document.getElementById('taxNumber').value
        },
        invoice: {
          type: document.getElementById('invoiceType').value,
          number: document.getElementById('invoiceNo').value,
          date: document.getElementById('invoiceDate').value,
          status: document.getElementById('status').value
        },
        items: [],
        financial: {
          subTotal: parseFloat(document.getElementById('subTotal').value) || 0,
          cashAccount: document.getElementById('cashAccount').value,
          promotionPercent: parseFloat(document.getElementById('promotionPercent').value) || 0,
          promotionAmount: parseFloat(document.getElementById('promotionAmount').value) || 0,
          proAmount: parseFloat(document.getElementById('proAmount').value) || 0,
          netDue: parseFloat(document.getElementById('netDue').value) || 0,
          discountPercent: parseFloat(document.getElementById('discountPercent').value) || 0,
          discountAmount: parseFloat(document.getElementById('discountAmount').value) || 0,
          reference2: document.getElementById('reference2').value,
          vatPercent: parseFloat(document.getElementById('vatPercent').value) || 0,
          deAccount: document.getElementById('deAccount').value,
          accountNoD: document.getElementById('accountNoD').value,
          grandTotal: parseFloat(document.getElementById('grandTotal').value) || 0,
          grandTotalWords: document.getElementById('grandTotalWords').value
        },
        settings: {
          warehouse: document.getElementById('warehouse').value,
          sale: document.getElementById('sale').value,
          paymentTerm: document.getElementById('paymentTerm').value,
          currency: document.getElementById('currency').value,
          refNumber: document.getElementById('refNumber').value,
          dateDue: document.getElementById('dateDue').value,
          shipping: document.getElementById('shipping').value,
          dateShip: document.getElementById('dateShip').value,
          note: document.getElementById('note').value,
          shipAddress: document.getElementById('shipAddress').value,
          soNumber: document.getElementById('soNumber').value,
          soDate: document.getElementById('soDate').value,
          reference: document.getElementById('reference').value
        },
        logo: logoData,
        createdAt: new Date().toISOString(),
        userId: user.uid,
        userEmail: user.email
      };
      
      // Collect items data
      rows.forEach(row => {
        const itemCodeInput = row.querySelector('input[placeholder="Enter item code"]');
        const itemDescriptionInput = row.querySelector('.item-description');
        const warehouseInput = row.querySelector('input[readonly]');
        const qtyInput = row.querySelector('.item-qty');
        const priceInput = row.querySelector('.item-price');
        const discountPercentInput = row.querySelector('.item-discount-percent');
        const discountAmountInput = row.querySelector('.item-discount-amount');
        const amountInput = row.querySelector('.item-total');
        
        const item = {
          code: itemCodeInput ? itemCodeInput.value : '',
          description: itemDescriptionInput ? itemDescriptionInput.value : '',
          warehouse: warehouseInput ? warehouseInput.value : '',
          qty: parseFloat(qtyInput ? qtyInput.value : 0) || 0,
          price: parseFloat(priceInput ? priceInput.value : 0) || 0,
          discountPercent: parseFloat(discountPercentInput ? discountPercentInput.value : 0) || 0,
          discountAmount: parseFloat(discountAmountInput ? discountAmountInput.value : 0) || 0,
          amount: parseFloat(amountInput ? amountInput.value : 0) || 0
        };
        if (item.code && item.description) {
          invoiceData.items.push(item);
        }
      });
      
      console.log('Invoice data:', invoiceData);
      
      // Save to Firebase under user-specific path
      const invoiceNumber = isEditMode ? editInvoiceId : invoiceData.invoice.number;
      const userPath = window.firebase.getUserDataPath(`invoices/${invoiceNumber}`);
      console.log('Saving to Firebase path:', userPath);
      
      if (!userPath) {
        console.error('Authentication error - no user path');
        alert('Authentication error. Please log in again.');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
        return;
      }

      // Test Firebase connection first
      const testRef = window.firebase.rtdb.ref('test');
      testRef.set({ timestamp: new Date().toISOString() })
        .then(() => {
          console.log('Firebase connection verified');
          return testRef.remove(); // Clean up test
        })
        .then(() => {
          // Now save the actual invoice
          console.log('Saving invoice data to path:', userPath);
          console.log('Invoice data being saved:', invoiceData);
          return window.firebase.rtdb.ref(userPath).set(invoiceData);
        })
        .then(() => {
          console.log('Invoice saved successfully to RTDB');
          const message = isEditMode ? 'Invoice updated successfully!' : 'Invoice saved successfully!';
          showStatusMessage(message, 'success');
          
          // Clear edit data if in edit mode
          if (isEditMode) {
            sessionStorage.removeItem('editInvoiceData');
          }
          
          // Return to dashboard after successful save
          setTimeout(() => {
            console.log('Returning to dashboard after save...');
            showPage('dashboard');
            loadDashboardStats();
          }, 1500);
        })
        .catch(err => {
          console.error('Error saving invoice:', err);
          showStatusMessage('Failed to save invoice: ' + err.message, 'error');
        })
        .finally(() => {
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = false;
        });
    }

    function showStatusMessage(message, type) {
      const statusDiv = document.getElementById('invoiceFormStatusMessage');
      const bgColor = type === 'success' ? 'var(--success-color)' : 'var(--error-color)';
      statusDiv.innerHTML = `<div style="padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-weight: 600; background: ${bgColor}; color: white;">${message}</div>`;
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 5000);
    }

    function newInvoice() {
      // Clear any edit data
      sessionStorage.removeItem('editInvoiceData');
      
      // Reset page title
      const headerTitle = document.querySelector('#create-invoice .header h1');
      if (headerTitle) {
        headerTitle.textContent = 'Sale Invoice';
      }
      
      // Clear all form inputs without confirmation
      document.querySelectorAll('input, textarea, select').forEach(el => { 
        if (el.type !== 'date' && el.type !== 'button' && el.type !== 'submit' && el.type !== 'checkbox') {
          el.value = ''; 
        } else if (el.type === 'checkbox') {
          el.checked = false;
        }
      });
      
      // Reset status to Draft
      const statusElement = document.getElementById('status');
      if (statusElement) {
        statusElement.value = 'Draft';
      }
      
      // Reset items table
      const itemsBody = document.getElementById('itemsBody');
      if (itemsBody) {
        itemsBody.innerHTML = `
          <tr>
            <td><input type="text" placeholder="Enter item code" onchange="updateRow(this)"></td>
            <td><input type="text" placeholder="Enter item description" onchange="updateRow(this)"></td>
            <td><input type="text" value="WH-01 | Tiger Power (Main)" readonly></td>
            <td><input type="number" value="1" min="1" onchange="calculateRowAmount(this)"></td>
            <td><input type="number" value="0.00" step="0.01" min="0" onchange="calculateRowAmount(this)"></td>
            <td><input type="number" value="0.00" step="0.01" min="0" onchange="calculateRowAmount(this)"></td>
            <td><input type="number" value="0.0000" step="0.01" readonly></td>
            <td><input type="number" value="0.0000" step="0.01" readonly></td>
          </tr>
        `;
      }
      
      // Reset financial calculations
      calculateTotals();
      
      // Set default dates
      const today = new Date();
      const dueDate = new Date(today.getTime() + 28 * 24 * 60 * 60 * 1000); // 30 days from now
      
      const invoiceDateElement = document.getElementById('invoiceDate');
      if (invoiceDateElement) {
        invoiceDateElement.valueAsDate = today;
      }
      
      const dateShipElement = document.getElementById('dateShip');
      if (dateShipElement) {
        dateShipElement.valueAsDate = today;
      }
      
      const soDateElement = document.getElementById('soDate');
      if (soDateElement) {
        soDateElement.valueAsDate = today;
      }
      
      const dateDueElement = document.getElementById('dateDue');
      if (dateDueElement) {
        dateDueElement.valueAsDate = dueDate;
      }
      
      console.log('New invoice form cleared');
    }

    function clearInvoice() {
      if (confirm('Clear all fields?')) {
        newInvoice(); // Use the same logic as newInvoice
      }
    }

    // Modal functions for adding customers and items
    function showAddCustomerModal() {
      const customerName = prompt('Enter customer name:');
      if (customerName) {
        document.getElementById('customer').value = customerName;
        // You can add more customer fields here if needed
      }
    }

    function showAddItemModal() {
      const itemName = prompt('Enter item name:');
      if (itemName) {
        // Add the item to the current row or create a new row
        const currentRow = document.querySelector('#items-tbody tr:last-child');
        if (currentRow) {
          currentRow.cells[0].querySelector('input').value = itemName;
        }
      }
    }

    function showInvoiceFormStatus(message, type) {
      const statusDiv = document.getElementById('invoiceFormStatusMessage');
      statusDiv.innerHTML = `<div style="padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-weight: 600; background: ${type === 'success' ? '#dcfce7' : '#fef2f2'}; color: ${type === 'success' ? 'var(--success-color)' : 'var(--error-color)'}; border: 1px solid ${type === 'success' ? '#bbf7d0' : '#fecaca'};">${message}</div>`;
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 5000);
    }

    // Invoice management functions

    // New comprehensive invoice functions
    function toggleInvoiceMenu() {
      const menu = document.getElementById('invoiceMenu');
      menu.classList.toggle('show');
    }

    function switchTab(tabName) {
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Add active class to clicked tab
      event.target.classList.add('active');
      
      // Handle tab switching logic here
      console.log('Switched to tab:', tabName);
    }

    function calculateRowAmount(element) {
      const row = element.closest('tr');
      const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
      const price = parseFloat(row.querySelector('.item-price').value) || 0;
      const discountPercent = parseFloat(row.querySelector('.item-discount-percent').value) || 0;
      
      const subtotal = qty * price;
      const discountAmount = subtotal * (discountPercent / 100);
      const amount = subtotal - discountAmount;
      
      row.querySelector('.item-discount-amount').value = discountAmount.toFixed(4);
      row.querySelector('.item-total').value = amount.toFixed(4);
      
      calculateTotals();
    }
    
    function calculateTotals() {
      const rows = document.querySelectorAll('#itemsBody tr');
      let subTotal = 0;
      
      rows.forEach(row => {
        const amount = parseFloat(row.cells[7].querySelector('input').value) || 0;
        subTotal += amount;
      });
      
      const promotionPercent = parseFloat(document.getElementById('promotionPercent').value) || 0;
      const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
      const vatPercent = parseFloat(document.getElementById('vatPercent').value) || 0;
      const freight = document.getElementById('freight').checked ? parseFloat(document.querySelector('#freight + input').value) || 0 : 0;
      const plt = document.getElementById('plt').checked ? parseFloat(document.querySelector('#plt + input').value) || 0 : 0;
      
      const promotionAmount = subTotal * (promotionPercent / 100);
      const discountAmount = subTotal * (discountPercent / 100);
      const netDue = subTotal - promotionAmount - discountAmount;
      const vatAmount = netDue * (vatPercent / 100);
      const grandTotal = netDue + vatAmount + freight + plt;
      
      document.getElementById('subTotal').value = subTotal.toFixed(4);
      document.getElementById('promotionAmount').value = promotionAmount.toFixed(4);
      document.getElementById('proAmount').value = promotionAmount.toFixed(4);
      document.getElementById('netDue').value = netDue.toFixed(1);
      document.getElementById('discountAmount').value = discountAmount.toFixed(4);
      document.getElementById('grandTotal').value = grandTotal.toFixed(4);
      
      // Update total in words
      updateTotalInWords(grandTotal);
    }
    
    function updateTotalInWords(amount) {
      if (amount === 0) {
        document.getElementById('grandTotalWords').value = '';
        return;
      }
      
      const words = numberToWords(amount);
      document.getElementById('grandTotalWords').value = words + ' ážŠáž»áž›áŸ’áž›áž¶ážšáž¢áž¶áž˜áŸážšáž·áž€';
    }
    
    function numberToWords(num) {
      const ones = ['', 'áž˜áž½áž™', 'áž–áž¸ážš', 'áž”áž¸', 'áž”áŸ’ážšáž¶áŸ†', 'áž”áŸ’ážšáž¶áŸ†áž˜áž½áž™', 'áž”áŸ’ážšáž¶áŸ†áž–áž¸ážš', 'áž”áŸ’ážšáž¶áŸ†áž”áž¸', 'áž”áŸ’ážšáž¶áŸ†áž”áž½áž“'];
      const tens = ['', 'ážŠáž”áŸ‹', 'áž˜áŸ’áž—áŸƒ', 'ážŸáž¶áž˜ážŸáž·áž”', 'ážŸáŸ‚ážŸáž·áž”', 'áž áž¶ážŸáž·áž”', 'áž áž»áž€ážŸáž·áž”', 'áž…áž·ážážŸáž·áž”', 'áž”áŸ‰áŸ‚ážážŸáž·áž”', 'áž€áŸ…ážŸáž·áž”'];
      
      if (num === 0) return 'ážŸáž¼áž“áŸ’áž™';
      if (num < 10) return ones[Math.floor(num)];
      if (num < 100) {
        const ten = Math.floor(num / 10);
        const one = num % 10;
        return tens[ten] + (one > 0 ? ' ' + ones[one] : '');
      }
      if (num < 1000) {
        const hundred = Math.floor(num / 100);
        const remainder = num % 100;
        return ones[hundred] + 'ážšáž™' + (remainder > 0 ? ' ' + numberToWords(remainder) : '');
      }
      return 'áž”áŸ’ážšáž¶áŸ†áž”áž¸ážšáž™áž áž¶ážŸáž·áž”áž˜áž½áž™'; // Simplified for demo
    }
    
    function addItemRow() {
      const tbody = document.getElementById('itemsBody');
      const newRow = tbody.insertRow();
      newRow.innerHTML = `
        <td>
          <div style="display: flex; gap: 5px;">
            <select class="item-select" onchange="autoFillItem(this)" style="flex: 1;">
              <option value="">Select Item</option>
            </select>
            <input type="text" placeholder="Enter item code" onchange="searchItem(this.value, this)" style="flex: 1;">
          </div>
        </td>
        <td><input type="text" class="item-description" placeholder="Enter item description" onchange="updateRow(this)"></td>
        <td><input type="text" value="WH-01 | Tiger Power (Main)" readonly></td>
        <td><input type="number" class="item-qty" value="1" min="1" onchange="calculateRowAmount(this)"></td>
        <td><input type="number" class="item-price" value="0.00" step="0.01" min="0" onchange="calculateRowAmount(this)"></td>
        <td><input type="number" class="item-discount-percent" value="0.00" step="0.01" min="0" onchange="calculateRowAmount(this)"></td>
        <td><input type="number" class="item-discount-amount" value="0.0000" step="0.01" readonly></td>
        <td><input type="number" class="item-total" value="0.0000" step="0.01" readonly></td>
      `;
      
      // Load items for this new row
      loadItemsForRow(newRow);
    }
    
    function updateRow(element) {
      // This function can be used to update item details when item code changes
      console.log('Row updated:', element.value);
    }
    
    // Auto-fill functions for customer and item selection
    async function autoFillCustomer(customerId) {
      if (!customerId) return;
      
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        const userPath = window.firebase.getUserDataPath('customers');
        if (!userPath) return;
        
        const snapshot = await window.firebase.rtdb.ref(userPath).once('value');
        const customers = snapshot.val();
        
        if (customers) {
          const customer = Object.values(customers).find(c => c.id === customerId);
          if (customer) {
            document.getElementById('customer').value = customer.id || '';
            document.getElementById('customerName').value = customer.name || '';
            document.getElementById('contact').value = customer.contactName || '';
            document.getElementById('address').value = customer.address || '';
            document.getElementById('phone').value = customer.phone || '';
            document.getElementById('customerGroup').value = customer.customerGroup || '';
            document.getElementById('taxNumber').value = customer.vattin || '';
          }
        }
      } catch (error) {
        console.error('Error auto-filling customer:', error);
      }
    }
    
    async function searchCustomer(customerCode) {
      if (!customerCode) return;
      
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        const userPath = window.firebase.getUserDataPath('customers');
        if (!userPath) return;
        
        const snapshot = await window.firebase.rtdb.ref(userPath).once('value');
        const customers = snapshot.val();
        
        if (customers) {
          const customer = Object.values(customers).find(c => 
            c.id && c.id.toLowerCase().includes(customerCode.toLowerCase()) ||
            c.name && c.name.toLowerCase().includes(customerCode.toLowerCase())
          );
          
          if (customer) {
            document.getElementById('customerSelect').value = customer.id;
            autoFillCustomer(customer.id);
          }
        }
      } catch (error) {
        console.error('Error searching customer:', error);
      }
    }
    
    async function autoFillItem(selectElement) {
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      const row = selectElement.closest('tr');
      
      if (!selectedOption.value) return;
      
      const itemCode = selectedOption.value;
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        const userPath = window.firebase.getUserDataPath('items');
        if (!userPath) return;
        
        const snapshot = await window.firebase.rtdb.ref(userPath).once('value');
        const items = snapshot.val();
        
        if (items) {
          const item = Object.values(items).find(i => i.code === itemCode);
          if (item) {
            const descriptionInput = row.querySelector('.item-description');
            const priceInput = row.querySelector('.item-price');
            const qtyInput = row.querySelector('.item-qty');
            
            if (descriptionInput) descriptionInput.value = item.name || '';
            if (priceInput) priceInput.value = item.sellingPrice || 0;
            if (qtyInput) qtyInput.value = 1;
            
            // Update the item code input
            const itemCodeInput = row.querySelector('input[placeholder="Enter item code"]');
            if (itemCodeInput) itemCodeInput.value = item.code || '';
            
            calculateRowAmount(priceInput);
          }
        }
      } catch (error) {
        console.error('Error auto-filling item:', error);
      }
    }
    
    async function searchItem(itemCode, inputElement) {
      if (!itemCode) return;
      
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        const userPath = window.firebase.getUserDataPath('items');
        if (!userPath) return;
        
        const snapshot = await window.firebase.rtdb.ref(userPath).once('value');
        const items = snapshot.val();
        
        if (items) {
          const item = Object.values(items).find(i => 
            i.code && i.code.toLowerCase().includes(itemCode.toLowerCase()) ||
            i.name && i.name.toLowerCase().includes(itemCode.toLowerCase())
          );
          
          if (item) {
            const row = inputElement.closest('tr');
            const selectElement = row.querySelector('.item-select');
            if (selectElement) {
              selectElement.value = item.code;
              autoFillItem(selectElement);
            }
          }
        }
      } catch (error) {
        console.error('Error searching item:', error);
      }
    }
    
    async function loadItems() {
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        console.log('=== LOAD ITEMS START ===');
        
        // Test different possible paths (same as customers and recent items)
        console.log('=== ITEMS PAGE - TESTING DATABASE PATHS ===');
        
        // Test 1: Try user-specific path
        const snapshot = await rtdb.ref(`users/${user.uid}/items`).once('value');
        const items = snapshot.val();
        console.log('Path 1 - users/${user.uid}/items:', items);
        console.log('Path 1 item count:', items ? Object.keys(items).length : 0);
        
        // Test 2: Try without user path
        const snapshot2 = await rtdb.ref('items').once('value');
        const items2 = snapshot2.val();
        console.log('Path 2 - items:', items2);
        console.log('Path 2 item count:', items2 ? Object.keys(items2).length : 0);
        
        // Test 3: Try with different user path structure
        const snapshot3 = await rtdb.ref(`items/${user.uid}`).once('value');
        const items3 = snapshot3.val();
        console.log('Path 3 - items/${user.uid}:', items3);
        console.log('Path 3 item count:', items3 ? Object.keys(items3).length : 0);
        
        // Use the path with the most items (same logic as customers)
        let finalItems = items;
        let itemCount = items ? Object.keys(items).length : 0;
        
        if (items2 && Object.keys(items2).length > itemCount) {
          finalItems = items2;
          itemCount = Object.keys(items2).length;
          console.log('Using Path 2 (items) - found more items');
        }
        
        if (items3 && Object.keys(items3).length > itemCount) {
          finalItems = items3;
          itemCount = Object.keys(items3).length;
          console.log('Using Path 3 (items/${user.uid}) - found more items');
        }
        
        console.log('Final items data for items page:', finalItems);
        console.log('Final item count for items page:', itemCount);
        
        if (finalItems) {
          console.log('=== ITEMS PAGE DATA ANALYSIS ===');
          console.log('Items page - Raw data:', finalItems);
          console.log('Total items in database:', Object.keys(finalItems).length);
          console.log('Item keys:', Object.keys(finalItems));
          
          const allItems = Object.entries(finalItems);
          console.log('All item entries:', allItems.length);
          console.log('Item entries details:', allItems.map(([id, item]) => ({ id, item: item ? 'exists' : 'null/undefined' })));
          
          const filteredItems = allItems.filter(([id, item]) => {
            const isValid = item && item !== null && item !== undefined;
            if (!isValid) {
              console.log('Filtering out item:', id, 'because item is:', item);
            }
            return isValid;
          });
          console.log('Items after filtering null/undefined:', filteredItems.length);
          
          console.log('=== ITEMS PAGE MAPPING ===');
          const mappedItems = filteredItems.map(([id, item]) => ({ id, ...item }));
          console.log('Mapped items count:', mappedItems.length);
          console.log('Mapped items with details:', mappedItems.map(i => ({ 
            id: i.id, 
            name: i.name || i.itemName, 
            code: i.code || i.itemCode,
            price: i.sellingPrice || i.price,
            hasData: !!(i.name || i.itemName)
          })));
          
          console.log('=== FINAL ITEMS PAGE DATA ===');
          console.log('Items page - Processed data:', mappedItems);
          console.log('Total items for display:', mappedItems.length);
        } else {
          console.log('=== NO ITEMS FOUND FOR ITEMS PAGE ===');
          console.log('No items found for items page');
        }
        
        console.log('=== LOAD ITEMS END ===');
      } catch (error) {
        console.error('Error loading items:', error);
      }
    }
    
    async function loadItemsForRow(row) {
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        console.log('=== LOAD ITEMS FOR ROW START ===');
        console.log('Loading items for row:', row);
        
        // Test different possible paths (same as customers and recent items)
        console.log('=== SELECT ITEM - TESTING DATABASE PATHS ===');
        
        // Test 1: Try user-specific path
        const snapshot = await rtdb.ref(`users/${user.uid}/items`).once('value');
        const items = snapshot.val();
        console.log('Path 1 - users/${user.uid}/items:', items);
        console.log('Path 1 item count:', items ? Object.keys(items).length : 0);
        
        // Test 2: Try without user path
        const snapshot2 = await rtdb.ref('items').once('value');
        const items2 = snapshot2.val();
        console.log('Path 2 - items:', items2);
        console.log('Path 2 item count:', items2 ? Object.keys(items2).length : 0);
        
        // Test 3: Try with different user path structure
        const snapshot3 = await rtdb.ref(`items/${user.uid}`).once('value');
        const items3 = snapshot3.val();
        console.log('Path 3 - items/${user.uid}:', items3);
        console.log('Path 3 item count:', items3 ? Object.keys(items3).length : 0);
        
        // Use the path with the most items (same logic as customers)
        let finalItems = items;
        let itemCount = items ? Object.keys(items).length : 0;
        
        if (items2 && Object.keys(items2).length > itemCount) {
          finalItems = items2;
          itemCount = Object.keys(items2).length;
          console.log('Using Path 2 (items) - found more items');
        }
        
        if (items3 && Object.keys(items3).length > itemCount) {
          finalItems = items3;
          itemCount = Object.keys(items3).length;
          console.log('Using Path 3 (items/${user.uid}) - found more items');
        }
        
        console.log('Final items data for select:', finalItems);
        console.log('Final item count for select:', itemCount);
        
        const selectElement = row.querySelector('.item-select');
        
        if (selectElement && finalItems) {
          console.log('=== ITEM SELECT DATA ANALYSIS ===');
          console.log('Select items - Raw data:', finalItems);
          console.log('Total items in database:', Object.keys(finalItems).length);
          console.log('Item keys:', Object.keys(finalItems));
          
          const allItems = Object.entries(finalItems);
          console.log('All item entries:', allItems.length);
          console.log('Item entries details:', allItems.map(([id, item]) => ({ id, item: item ? 'exists' : 'null/undefined' })));
          
          const filteredItems = allItems.filter(([id, item]) => {
            const isValid = item && item !== null && item !== undefined;
            if (!isValid) {
              console.log('Filtering out item:', id, 'because item is:', item);
            }
            return isValid;
          });
          console.log('Items after filtering null/undefined:', filteredItems.length);
          
          console.log('=== ITEM SELECT MAPPING ===');
          const mappedItems = filteredItems.map(([id, item]) => ({ id, ...item }));
          console.log('Mapped items count:', mappedItems.length);
          console.log('Mapped items with details:', mappedItems.map(i => ({ 
            id: i.id, 
            name: i.name || i.itemName, 
            code: i.code || i.itemCode,
            price: i.sellingPrice || i.price,
            hasData: !!(i.name || i.itemName)
          })));
          
          selectElement.innerHTML = '<option value="">Select Item</option>';
          
          console.log('=== PROCESSING ITEMS FOR SELECT ===');
          mappedItems.forEach((item, index) => {
            console.log(`Processing item ${index + 1} for select:`, item);
            
            const option = document.createElement('option');
            const itemCode = item.code || item.itemCode || item.id || '';
            const itemName = item.name || item.itemName || 'N/A';
            const itemPrice = item.sellingPrice || item.price || 0;
            
            option.value = itemCode;
            option.textContent = `${itemName} (${itemCode})`;
            option.dataset.price = itemPrice;
            option.dataset.description = itemName;
            
            console.log('Item select data:', { itemCode, itemName, itemPrice });
            
            selectElement.appendChild(option);
            console.log(`Item ${index + 1} option added to select`);
          });
          
          console.log('=== FINAL SELECT ITEMS ===');
          console.log('Total options in select:', selectElement.options.length);
          console.log('Select items - Processed data:', mappedItems);
        } else {
          console.log('=== NO ITEMS FOUND FOR SELECT ===');
          console.log('No items found for select dropdown');
          if (selectElement) {
            selectElement.innerHTML = '<option value="">Select Item</option>';
          }
        }
        
        console.log('=== LOAD ITEMS FOR ROW END ===');
      } catch (error) {
        console.error('Error loading items for row:', error);
      }
    }
    
    function showCustomerSelector() {
      const user = auth.currentUser;
      if (!user) {
        alert('Please log in to select customers.');
        return;
      }
      
      // Create modal for customer selection
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;
      
      modal.innerHTML = `
        <div style="
          background: var(--card-bg);
          border-radius: 16px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          width: 90%;
          max-width: 800px;
          max-height: 80vh;
          overflow-y: auto;
          padding: 24px;
          display: flex;
          flex-direction: column;
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: var(--text-primary); margin: 0;">Select Customer</h2>
            <button onclick="closeCustomerModal()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: var(--text-secondary);
            ">&times;</button>
          </div>
          
          <div style="margin-bottom: 20px;">
            <input type="text" id="customerSearch" placeholder="Search customers..." style="
              width: 100%;
              padding: 12px;
              border: 1px solid var(--border-color);
              border-radius: 8px;
              background: var(--input-bg);
              color: var(--text-primary);
            " onkeyup="filterCustomers(this.value)">
          </div>
          
          <div id="customerList" style="
            max-height: 400px; 
            overflow-y: auto; 
            flex: 1; 
            min-height: 200px;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
          ">
            <!-- Customer list will be populated here -->
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Load and display customers
      loadCustomersForSelector();
    }
    
    async function loadCustomersForSelector() {
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        console.log('=== SELECT CUSTOMER - TESTING DATABASE PATHS ===');
        
        // Test different possible paths
        const snapshot = await rtdb.ref(`users/${user.uid}/customers`).once('value');
        const customers = snapshot.val();
        console.log('Path 1 - users/${user.uid}/customers:', customers);
        console.log('Path 1 customer count:', customers ? Object.keys(customers).length : 0);
        
        // Test 2: Try without user path
        const snapshot2 = await rtdb.ref('customers').once('value');
        const customers2 = snapshot2.val();
        console.log('Path 2 - customers:', customers2);
        console.log('Path 2 customer count:', customers2 ? Object.keys(customers2).length : 0);
        
        // Test 3: Try with different user path structure
        const snapshot3 = await rtdb.ref(`customers/${user.uid}`).once('value');
        const customers3 = snapshot3.val();
        console.log('Path 3 - customers/${user.uid}:', customers3);
        console.log('Path 3 customer count:', customers3 ? Object.keys(customers3).length : 0);
        
        // Use the path with the most customers
        let finalCustomers = customers;
        let customerCount = customers ? Object.keys(customers).length : 0;
        
        if (customers2 && Object.keys(customers2).length > customerCount) {
          finalCustomers = customers2;
          customerCount = Object.keys(customers2).length;
          console.log('Using Path 2 (customers) - found more customers');
        }
        
        if (customers3 && Object.keys(customers3).length > customerCount) {
          finalCustomers = customers3;
          customerCount = Object.keys(customers3).length;
          console.log('Using Path 3 (customers/${user.uid}) - found more customers');
        }
        
        console.log('Final customers data:', finalCustomers);
        console.log('Final customer count:', customerCount);
        
        const customerList = document.getElementById('customerList');
        
        if (customerList && finalCustomers) {
          customerList.innerHTML = '';
          
          console.log('Total customers found:', Object.keys(finalCustomers).length);
          console.log('Customers object structure:', JSON.stringify(finalCustomers, null, 2));
          let displayedCount = 0;
          
          Object.entries(finalCustomers).forEach(([customerId, customer]) => {
            console.log('Processing customer:', customerId, customer);
            console.log('Customer type:', typeof customer);
            console.log('Customer is null/undefined:', customer === null || customer === undefined);
            
            // Skip null or undefined customers
            if (!customer) {
              console.log('Skipping null/undefined customer:', customerId);
              return;
            }
            
            console.log('Adding customer to display:', customerId);
            displayedCount++;
            const customerDiv = document.createElement('div');
            customerDiv.style.cssText = `
              padding: 12px;
              border: 1px solid var(--border-color);
              border-radius: 8px;
              margin-bottom: 8px;
              cursor: pointer;
              transition: background-color 0.2s;
            `;
            customerDiv.onmouseover = () => customerDiv.style.background = 'var(--hover-bg)';
            customerDiv.onmouseout = () => customerDiv.style.background = 'transparent';
            customerDiv.onclick = () => selectCustomer({ id: customerId, ...customer });
            
                        customerDiv.innerHTML = `
              <div style="font-weight: 600; color: var(--text-primary);">${customer.name || customer.customerName || 'N/A'}</div>
              <div style="font-size: 12px; color: var(--text-secondary);">ID: ${customer.id || customer.customerId || customerId}</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Phone: ${customer.phone || 'N/A'}</div>
            `;
            
            customerList.appendChild(customerDiv);
            console.log('Customer div added to DOM:', customerId);
          });
          
          console.log('Total customers displayed:', displayedCount);
          console.log('Actual DOM elements:', customerList.children.length);
          
          if (displayedCount === 0) {
            customerList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No customers found</div>';
          }
        }
      } catch (error) {
        console.error('Error loading customers for selector:', error);
      }
    }
    
    function selectCustomer(customer) {
      // Auto-fill customer information
      document.getElementById('customerSelect').value = customer.id || '';
      document.getElementById('customer').value = customer.id || '';
      document.getElementById('customerName').value = customer.name || customer.customerName || '';
      document.getElementById('contact').value = customer.contactName || customer.contact || '';
      document.getElementById('address').value = customer.address || '';
      document.getElementById('phone').value = customer.phone || '';
      document.getElementById('customerGroup').value = customer.customerGroup || customer.group || '';
      document.getElementById('taxNumber').value = customer.vattin || customer.taxNumber || '';
      
      // Close modal
      closeCustomerModal();
    }
    
    function filterCustomers(searchTerm) {
      const customerDivs = document.querySelectorAll('#customerList > div');
      const searchLower = searchTerm.toLowerCase();
      
      customerDivs.forEach(div => {
        const customerName = div.querySelector('div').textContent.toLowerCase();
        const customerId = div.querySelectorAll('div')[1].textContent.toLowerCase();
        
        if (customerName.includes(searchLower) || customerId.includes(searchLower)) {
          div.style.display = 'block';
        } else {
          div.style.display = 'none';
        }
      });
    }
    
    function closeCustomerModal() {
      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) modal.remove();
    }
    
    function newInvoice() {
      if (confirm('Create new invoice? All current data will be cleared.')) {
        location.reload();
      }
    }
    
    function printInvoice() {
      window.print();
    }
    
    function exportInvoice() {
      // Implement PDF export functionality
      alert('PDF export functionality will be implemented here.');
    }
    



    // Download invoice as PDF
    async function downloadInvoice(invoiceNo) {
      const user = auth.currentUser;
      if (!user) return;

      try {
        showInvoiceStatus('Generating PDF...', 'success');
        
        // Get invoice data
        const userPath = window.firebase.getUserDataPath(`invoices/${invoiceNo}`);
        if (!userPath) {
          showInvoiceStatus('Authentication error', 'error');
          return;
        }
        const snapshot = await window.firebase.rtdb.ref(userPath).once('value');
        const invoice = snapshot.val();
        
        if (!invoice) {
          showInvoiceStatus('Invoice not found', 'error');
          return;
        }

        // Create PDF content
        const pdfContent = createInvoicePDF(invoice);
        
        // Generate PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add content to PDF
        doc.setFontSize(20);
        doc.text('INVOICE', 105, 20, { align: 'center' });
        
        doc.setFontSize(12);
        doc.text(`Invoice No: ${invoice.invoiceNo}`, 20, 40);
        doc.text(`Date: ${invoice.invoiceDate}`, 20, 50);
        doc.text(`Due Date: ${invoice.dueDate}`, 20, 60);
        doc.text(`Customer: ${invoice.customer}`, 20, 70);
        
        // Add items table
        let yPos = 90;
        doc.setFontSize(10);
        doc.text('Item', 20, yPos);
        doc.text('Qty', 80, yPos);
        doc.text('Price', 110, yPos);
        doc.text('Total', 140, yPos);
        
        yPos += 10;
        doc.line(20, yPos, 190, yPos);
        yPos += 5;
        
        if (invoice.items) {
          invoice.items.forEach(item => {
            doc.text(item.itemCode || 'N/A', 20, yPos);
            doc.text(item.quantity || '1', 80, yPos);
            doc.text(`$${item.price || '0.00'}`, 110, yPos);
            doc.text(`$${item.total || '0.00'}`, 140, yPos);
            yPos += 8;
          });
        }
        
        yPos += 5;
        doc.line(20, yPos, 190, yPos);
        yPos += 10;
        
        // Add totals
        doc.setFontSize(12);
        doc.text(`Subtotal: $${invoice.subtotal || '0.00'}`, 140, yPos);
        yPos += 8;
        doc.text(`Tax: $${invoice.taxAmount || '0.00'}`, 140, yPos);
        yPos += 8;
        doc.setFontSize(14);
        doc.text(`Total: $${invoice.grandTotal || '0.00'}`, 140, yPos);
        
        // Add notes if any
        if (invoice.notes) {
          yPos += 20;
          doc.setFontSize(10);
          doc.text('Notes:', 20, yPos);
          yPos += 8;
          doc.setFontSize(9);
          const notes = doc.splitTextToSize(invoice.notes, 170);
          doc.text(notes, 20, yPos);
        }
        
        // Save PDF
        doc.save(`invoice-${invoice.invoiceNo}.pdf`);
        showInvoiceStatus('PDF generated successfully!', 'success');
        
      } catch (error) {
        showInvoiceStatus('Error generating PDF: ' + error.message, 'error');
      }
    }

    // Create invoice PDF content (helper function)
    function createInvoicePDF(invoice) {
      return `
        <div style="font-family: Arial, sans-serif; padding: 20px;">
          <h1 style="text-align: center; color: #333;">INVOICE</h1>
          <div style="margin-bottom: 20px;">
            <p><strong>Invoice No:</strong> ${invoice.invoiceNo}</p>
            <p><strong>Date:</strong> ${invoice.invoiceDate}</p>
            <p><strong>Due Date:</strong> ${invoice.dueDate}</p>
            <p><strong>Customer:</strong> ${invoice.customer}</p>
          </div>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
              <tr style="background-color: #f5f5f5;">
                <th style="border: 1px solid #ddd; padding: 8px;">Item</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Qty</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Price</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Total</th>
              </tr>
            </thead>
            <tbody>
              ${invoice.items ? invoice.items.map(item => `
                <tr>
                  <td style="border: 1px solid #ddd; padding: 8px;">${item.itemCode || 'N/A'}</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">${item.quantity || '1'}</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">$${item.price || '0.00'}</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">$${item.total || '0.00'}</td>
                </tr>
              `).join('') : ''}
            </tbody>
          </table>
          <div style="text-align: right;">
            <p><strong>Subtotal:</strong> $${invoice.subtotal || '0.00'}</p>
            <p><strong>Tax:</strong> $${invoice.taxAmount || '0.00'}</p>
            <p><strong>Total:</strong> $${invoice.grandTotal || '0.00'}</p>
          </div>
          ${invoice.notes ? `<div style="margin-top: 20px;"><strong>Notes:</strong><br>${invoice.notes}</div>` : ''}
        </div>
      `;
    }

    // Show invoice status message
    function showInvoiceStatus(message, type) {
      const statusDiv = document.getElementById('invoiceStatusMessage');
      statusDiv.innerHTML = `<div style="padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-weight: 600; background: ${type === 'success' ? '#dcfce7' : '#fef2f2'}; color: ${type === 'success' ? 'var(--success-color)' : 'var(--error-color)'}; border: 1px solid ${type === 'success' ? '#bbf7d0' : '#fecaca'};">${message}</div>`;
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 5000);
    }



    // Customer form functions
    function initializeCustomerForm() {
      // Clear form fields
      document.getElementById('customerForm').reset();
      
      // Set default status
      document.getElementById('customerStatus').value = 'active';
      
      // Auto-generate customer ID
      autoGenerateCustomerId();
      
      // Clear file list
      document.getElementById('customerFileList').innerHTML = '';
      
      // Clear uploaded files
      window.uploadedCustomerFiles = [];
      
      // Add event listener for file upload
      const fileInput = document.getElementById('customerFiles');
      if (fileInput) {
        fileInput.addEventListener('change', handleCustomerFileUpload);
      }
    }

    // Handle customer file upload
    async function handleCustomerFileUpload(event) {
      const files = event.target.files;
      const fileList = document.getElementById('customerFileList');
      
      if (!window.uploadedCustomerFiles) {
        window.uploadedCustomerFiles = [];
      }
      
      for (let file of files) {
        try {
          // Convert file to base64
          const base64 = await fileToBase64(file);
          
          const fileData = {
            name: file.name,
            size: file.size,
            type: file.type,
            data: base64,
            uploadedAt: new Date().toISOString()
          };
          
          window.uploadedCustomerFiles.push(fileData);
          
          // Display file in list
          const fileElement = document.createElement('div');
          fileElement.className = 'uploaded-file';
          fileElement.innerHTML = `
            <div class="file-info">
              <span class="file-name">${file.name}</span>
              <span class="file-size">${formatFileSize(file.size)}</span>
            </div>
            <button class="remove-file" onclick="removeCustomerFile('${file.name}')">Remove</button>
          `;
          
          fileList.appendChild(fileElement);
          
        } catch (error) {
          console.error('Error processing file:', error);
          showCustomerFormStatus('Error processing file: ' + file.name, 'error');
        }
      }
    }

    function removeCustomerFile(fileName) {
      if (window.uploadedCustomerFiles) {
        window.uploadedCustomerFiles = window.uploadedCustomerFiles.filter(file => file.name !== fileName);
      }
      
      // Remove from display
      const fileElements = document.querySelectorAll('#customerFileList .uploaded-file');
      fileElements.forEach(element => {
        if (element.querySelector('.file-name').textContent === fileName) {
          element.remove();
        }
      });
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // Generate customer ID
    function generateCustomerId() {
      return 'C' + Date.now().toString().slice(-6);
    }

    // Auto-generate customer ID when form is initialized
    function autoGenerateCustomerId() {
      const customerIdField = document.getElementById('customerId');
      if (customerIdField && !customerIdField.value) {
        customerIdField.value = generateCustomerId();
      }
    }

    async function saveCustomer() {
      const user = auth.currentUser;
      if (!user) {
        showCustomerFormStatus('User not authenticated. Please log in again.', 'error');
        return;
      }

      console.log('Saving customer - User:', user.uid);

      const customerData = {
        id: document.getElementById('customerId').value.trim(),
        name: document.getElementById('customerName').value.trim(),
        phone: document.getElementById('customerPhone').value.trim(),
        email: document.getElementById('customerEmail').value.trim(),
        address: document.getElementById('customerAddress').value.trim(),
        status: document.getElementById('customerStatus').value,
        notes: document.getElementById('customerNotes').value.trim(),
        files: window.uploadedCustomerFiles || [],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      console.log('Customer data to save:', customerData);

      if (!customerData.id || !customerData.name) {
        showCustomerFormStatus('Please fill in Customer ID and Customer Name', 'error');
        return;
      }

      try {
        const userPath = window.firebase.getUserDataPath(`customers/${customerData.id}`);
        console.log('Saving to Firebase path:', userPath);
        
        if (!userPath) {
          showCustomerFormStatus('Authentication error. Please log in again.', 'error');
          return;
        }

        // Test Firebase connection first
        const testRef = window.firebase.rtdb.ref('test');
        await testRef.set({ timestamp: new Date().toISOString() });
        await testRef.remove(); // Clean up test
        console.log('Firebase connection verified');

        // Save customer data with files
        await window.firebase.rtdb.ref(userPath).set(customerData);
        console.log('Customer saved successfully to RTDB with files');
        
        showCustomerFormStatus('Customer saved successfully!', 'success');
        
        // Clear form after successful save
        setTimeout(() => {
          showPage('customers');
        }, 2000);
      } catch (error) {
        console.error('Error saving customer:', error);
        showCustomerFormStatus('Error saving customer: ' + error.message, 'error');
      }
    }

    function showCustomerFormStatus(message, type) {
      const statusDiv = document.getElementById('customerFormStatusMessage');
      statusDiv.innerHTML = `<div style="padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-weight: 600; background: ${type === 'success' ? '#dcfce7' : '#fef2f2'}; color: ${type === 'success' ? 'var(--success-color)' : 'var(--error-color)'}; border: 1px solid ${type === 'success' ? '#bbf7d0' : '#fecaca'};">${message}</div>`;
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 5000);
    }

    // Item form functions
    function initializeItemForm() {
      // Clear form fields
      document.getElementById('itemForm').reset();
      
      // Set default values
      document.getElementById('itemUnit').value = 'pcs';
      document.getElementById('itemStock').value = '0';
      document.getElementById('itemPrice').value = '0.00';
      
      // Clear image preview
      document.getElementById('imagePreview').innerHTML = '';
      
      // Clear uploaded files
      window.uploadedItemFiles = [];
      
      // Add event listener for file upload
      document.getElementById('itemImages').addEventListener('change', handleImageUpload);
    }

    // Enhanced file upload handler for binary data
    async function handleImageUpload(event) {
      const files = event.target.files;
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = '';
      
      const user = auth.currentUser;
      if (!user) {
        showItemFormStatus('User not authenticated', 'error');
        return;
      }

      // Supported file types
      const supportedTypes = {
        'image/': ['jpg', 'jpeg', 'png', 'gif', 'webp'],
        'application/pdf': ['pdf'],
        'application/msword': ['doc'],
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['docx'],
        'application/vnd.ms-excel': ['xls'],
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['xlsx']
      };

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        let isSupported = false;
        
        // Check if file type is supported
        for (const [mimeType, extensions] of Object.entries(supportedTypes)) {
          if (file.type.startsWith(mimeType) || extensions.some(ext => file.name.toLowerCase().endsWith(ext))) {
            isSupported = true;
            break;
          }
        }

        if (!isSupported) {
          showItemFormStatus(`File type not supported: ${file.name}`, 'error');
          continue;
        }

        try {
          // Show preview for images
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.alt = 'Item Image';
              img.style.maxWidth = '100px';
              img.style.maxHeight = '100px';
              img.style.margin = '5px';
              img.style.borderRadius = '4px';
              preview.appendChild(img);
            };
            reader.readAsDataURL(file);
          } else {
            // Show file info for non-image files
            const fileInfo = document.createElement('div');
            fileInfo.style.cssText = 'padding: 8px; margin: 5px; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--border-color);';
            fileInfo.innerHTML = `
              <div style="font-weight: 600; color: var(--text-primary);">${file.name}</div>
              <div style="font-size: 12px; color: var(--text-secondary);">${(file.size / 1024).toFixed(1)} KB</div>
            `;
            preview.appendChild(fileInfo);
          }

          // Convert file to base64 and store in RTDB
          const reader = new FileReader();
          reader.onload = function(e) {
            const base64Data = e.target.result;
            
            // Store file metadata for later use
            const fileData = {
              name: file.name,
              data: base64Data,
              size: file.size,
              type: file.type,
              uploadedAt: new Date().toISOString(),
              isImage: file.type.startsWith('image/')
            };
            
            // Add to uploaded files array
            if (!window.uploadedItemFiles) window.uploadedItemFiles = [];
            window.uploadedItemFiles.push(fileData);
            
            showItemFormStatus(`File "${file.name}" processed successfully`, 'success');
          };
          
          reader.onerror = function() {
            showItemFormStatus(`Error processing "${file.name}"`, 'error');
          };
          
          reader.readAsDataURL(file);
        } catch (error) {
          showItemFormStatus(`Error uploading "${file.name}": ${error.message}`, 'error');
        }
      }
    }

    async function saveItem() {
      const user = auth.currentUser;
      if (!user) {
        showItemFormStatus('User not authenticated. Please log in again.', 'error');
        return;
      }

      console.log('Saving item - User:', user.uid);

      const itemData = {
        code: document.getElementById('itemCode').value.trim(),
        name: document.getElementById('itemName').value.trim(),
        category: document.getElementById('itemCategory').value.trim(),
        unit: document.getElementById('itemUnit').value.trim(),
        stock: parseInt(document.getElementById('itemStock').value) || 0,
        price: parseFloat(document.getElementById('itemPrice').value) || 0,
        description: document.getElementById('itemDescription').value.trim(),
        notes: document.getElementById('itemNotes').value.trim(),
        // Store both images and other files
        files: window.uploadedItemFiles || [],
        images: (window.uploadedItemFiles || []).filter(file => file.isImage),
        documents: (window.uploadedItemFiles || []).filter(file => !file.isImage),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      console.log('Item data to save:', itemData);

      if (!itemData.code || !itemData.name) {
        showItemFormStatus('Please fill in Item Code and Item Name', 'error');
        return;
      }

      try {
        // Test Firebase connection first
        const testRef = window.firebase.rtdb.ref('test');
        await testRef.set({ timestamp: new Date().toISOString() });
        await testRef.remove(); // Clean up test
        console.log('Firebase connection verified');

        // Store text data in Firebase Realtime Database
        const userPath = window.firebase.getUserDataPath(`items/${itemData.code}`);
        console.log('Saving to Firebase path:', userPath);
        
        if (!userPath) {
          showItemFormStatus('Authentication error. Please log in again.', 'error');
          return;
        }
        
        await window.firebase.rtdb.ref(userPath).set(itemData);
        console.log('Item saved successfully to RTDB');
        
        // Store file metadata in a separate node for better organization
        if (window.uploadedItemFiles && window.uploadedItemFiles.length > 0) {
          const filePath = window.firebase.getUserDataPath(`item_files/${itemData.code}`);
          if (filePath) {
            await window.firebase.rtdb.ref(filePath).set({
              files: window.uploadedItemFiles,
              lastUpdated: new Date().toISOString()
            });
            console.log('Item files metadata saved to RTDB');
          }
        }
        
        showItemFormStatus('Item saved successfully!', 'success');
        
        // Clear form after successful save
        setTimeout(() => {
          showPage('items');
        }, 2000);
      } catch (error) {
        console.error('Error saving item:', error);
        showItemFormStatus('Error saving item: ' + error.message, 'error');
      }
    }

    function showItemFormStatus(message, type) {
      const statusDiv = document.getElementById('itemFormStatusMessage');
      let bgColor, textColor, borderColor;
      
      switch(type) {
        case 'success':
          bgColor = '#dcfce7';
          textColor = 'var(--success-color)';
          borderColor = '#bbf7d0';
          break;
        case 'error':
          bgColor = '#fef2f2';
          textColor = 'var(--error-color)';
          borderColor = '#fecaca';
          break;
        case 'info':
          bgColor = '#dbeafe';
          textColor = 'var(--active-color)';
          borderColor = '#bfdbfe';
          break;
        default:
          bgColor = '#fef2f2';
          textColor = 'var(--error-color)';
          borderColor = '#fecaca';
      }
      
      statusDiv.innerHTML = `<div style="padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-weight: 600; background: ${bgColor}; color: ${textColor}; border: 1px solid ${borderColor};">${message}</div>`;
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 5000);
    }

    // Update sidebar user information
    function updateSidebarUserInfo() {
      const user = auth.currentUser;
      if (user) {
        const userName = document.getElementById('sidebarUserName');
        const userEmail = document.getElementById('sidebarUserEmail');
        
        if (userName) {
          userName.textContent = user.displayName || 'User';
        }
        
        if (userEmail) {
          userEmail.textContent = user.email || '';
        }
      }
    }
    
    // Account Settings functions
    async function initializeSettings() {
      const user = auth.currentUser;
      if (!user) return;

      // Fill profile picture - try to load from RTDB first and sync all displays
      const userPath = window.firebase.getUserDataPath('profile');
      if (userPath) {
        window.firebase.rtdb.ref(userPath).once('value')
          .then((snapshot) => {
            const profileData = snapshot.val();
            if (profileData && profileData.photoURL) {
              // Update all profile picture displays with synchronized image
              const profilePic = document.getElementById('profilePic');
              if (profilePic) {
                profilePic.src = profileData.photoURL;
                // Add error handling for image loading
                profilePic.onerror = function() {
                  console.error('Failed to load profile picture from database');
                  this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjM0I4MkY2Ii8+Cjx0ZXh0IHg9IjY0IiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkY8L3RleHQ+Cjwvc3ZnPgo=';
                };
              }
              
              // Update user info display if it exists
              const userInfoPic = document.querySelector('.user-info img');
              if (userInfoPic) {
                userInfoPic.src = profileData.photoURL;
              }
              
              // Update sidebar profile picture specifically
              const sidebarProfilePic = document.getElementById('sidebarProfilePic');
              if (sidebarProfilePic) {
                sidebarProfilePic.src = profileData.photoURL;
                sidebarProfilePic.onerror = function() {
                  console.error('Failed to load sidebar profile picture from database');
                  this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjM0I4MkY2Ii8+Cjx0ZXh0IHg9IjY0IiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkY8L3RleHQ+Cjwvc3ZnPgo=';
                };
              }
              
              // Update any other profile picture displays
              const allProfilePics = document.querySelectorAll('img[src*="ui-avatars.com"]');
              allProfilePics.forEach(img => {
                if (img.alt && img.alt.toLowerCase().includes('profile')) {
                  img.src = profileData.photoURL;
                }
              });
              
              // Also update Firebase Auth profile photo to keep in sync (only if it's a valid URL)
              if (user.photoURL !== profileData.photoURL && profileData.photoURL && profileData.photoURL.startsWith('http')) {
                try {
                  user.updateProfile({
                    photoURL: profileData.photoURL
                  }).catch(error => {
                    console.log('Could not update Firebase Auth photo URL:', error);
                  });
                } catch (error) {
                  console.log('Could not update Firebase Auth photo URL:', error);
                }
              }
            } else {
              // Use default avatar and sync to all displays
              const defaultAvatar = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || user.email || 'U') + '&background=3b82f6&color=fff&size=128';
              const profilePic = document.getElementById('profilePic');
              if (profilePic) {
                profilePic.src = defaultAvatar;
              }
              
              // Update user info display if it exists
              const userInfoPic = document.querySelector('.user-info img');
              if (userInfoPic) {
                userInfoPic.src = defaultAvatar;
              }
              
              // Update sidebar profile picture specifically
              const sidebarProfilePic = document.getElementById('sidebarProfilePic');
              if (sidebarProfilePic) {
                sidebarProfilePic.src = defaultAvatar;
              }
            }
          })
          .catch((error) => {
            console.error('Error loading profile picture:', error);
            const defaultAvatar = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || user.email || 'U') + '&background=3b82f6&color=fff&size=128';
            const profilePic = document.getElementById('profilePic');
            if (profilePic) {
              profilePic.src = defaultAvatar;
            }
            
            // Update sidebar profile picture specifically
            const sidebarProfilePic = document.getElementById('sidebarProfilePic');
            if (sidebarProfilePic) {
              sidebarProfilePic.src = defaultAvatar;
            }
          });
      } else {
        // Use default avatar and sync to all displays
        const defaultAvatar = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || user.email || 'U') + '&background=3b82f6&color=fff&size=128';
        const profilePic = document.getElementById('profilePic');
        if (profilePic) {
          profilePic.src = defaultAvatar;
        }
        
        // Update sidebar profile picture specifically
        const sidebarProfilePic = document.getElementById('sidebarProfilePic');
        if (sidebarProfilePic) {
          sidebarProfilePic.src = defaultAvatar;
        }
      }
      
      // Fill name fields
      let displayName = user.displayName || '';
      let first = '', last = '';
      if (displayName.includes(' ')) {
        first = displayName.split(' ')[0];
        last = displayName.split(' ').slice(1).join(' ');
      } else {
        first = displayName;
        last = '';
      }
      document.getElementById('firstName').value = first;
      document.getElementById('lastName').value = last;
      
      // Fill email
      document.getElementById('email').value = user.email || '';
      
      // Load additional emails from RTDB
      loadAdditionalEmails();
    }

    // Load additional emails from RTDB
    function loadAdditionalEmails() {
      const user = auth.currentUser;
      if (!user) return;

      const userPath = window.firebase.getUserDataPath('settings');
      if (userPath) {
        window.firebase.rtdb.ref(userPath).once('value')
          .then((snapshot) => {
            const settingsData = snapshot.val();
            if (settingsData && settingsData.additionalEmails) {
              // Populate additional emails if needed
              console.log('Additional emails loaded from RTDB:', settingsData.additionalEmails);
            }
          })
          .catch((error) => {
            console.error('Error loading additional emails:', error);
          });
      }
      
      // Load company logo
      loadCompanyLogo();
    }

    // Profile picture upload to update Gmail photo and sync both images
    document.addEventListener('DOMContentLoaded', function() {
      const uploadPicBtn = document.getElementById('uploadPicBtn');
      if (uploadPicBtn) {
        uploadPicBtn.onclick = async function() {
          const user = auth.currentUser;
          if (!user) {
            alert('Please log in to upload profile picture');
            return;
          }

          // Allow file upload for all users
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/png, image/jpeg';
          input.onchange = async function(event) {
            const file = event.target.files[0];
            if (file) {
              if (file.size > 15 * 1024 * 1024) {
                alert('File size must be under 15MB');
                return;
              }
              
                                try {
                    // Convert file to base64 for simple display
                    const reader = new FileReader();
                    reader.onload = function(e) {
                      const imageData = e.target.result;
                      
                      // Update all profile picture displays with the same image
                      const profilePic = document.getElementById('profilePic');
                      if (profilePic) {
                        profilePic.src = imageData;
                        // Add error handling for image loading
                        profilePic.onerror = function() {
                          console.error('Failed to load profile picture');
                          this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjM0I4MkY2Ii8+Cjx0ZXh0IHg9IjY0IiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkY8L3RleHQ+Cjwvc3ZnPgo=';
                        };
                      }
                      
                      // Update user info display if it exists
                      const userInfoPic = document.querySelector('.user-info img');
                      if (userInfoPic) {
                        userInfoPic.src = imageData;
                        userInfoPic.onerror = function() {
                          console.error('Failed to load user info picture');
                          this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjM0I4MkY2Ii8+Cjx0ZXh0IHg9IjY0IiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkY8L3RleHQ+Cjwvc3ZnPgo=';
                        };
                      }
                      
                      // Update sidebar profile picture specifically
                      const sidebarProfilePic = document.getElementById('sidebarProfilePic');
                      if (sidebarProfilePic) {
                        sidebarProfilePic.src = imageData;
                        sidebarProfilePic.onerror = function() {
                          console.error('Failed to load sidebar profile picture');
                          this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjM0I4MkY2Ii8+Cjx0ZXh0IHg9IjY0IiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkY8L3RleHQ+Cjwvc3ZnPgo=';
                        };
                      }
                      
                      // Update any other profile picture displays
                      const allProfilePics = document.querySelectorAll('img[src*="ui-avatars.com"]');
                      allProfilePics.forEach(img => {
                        if (img.alt && img.alt.toLowerCase().includes('profile')) {
                          img.src = imageData;
                          img.onerror = function() {
                            console.error('Failed to load profile picture in other displays');
                            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjM0I4MkY2Ii8+Cjx0ZXh0IHg9IjY0IiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkY8L3RleHQ+Cjwvc3ZnPgo=';
                          };
                        }
                      });
                      
                      // Store in RTDB for backup
                      const userPath = window.firebase.getUserDataPath('profile');
                      if (userPath) {
                        window.firebase.rtdb.ref(userPath).set({
                          photoURL: imageData,
                          updatedAt: new Date().toISOString()
                        }).then(() => {
                          console.log('Profile picture saved to database successfully');
                        }).catch((error) => {
                          console.error('Failed to save profile picture to database:', error);
                        });
                      }
                      
                      alert('Profile picture updated! All displays now show the same image.');
                    };
                    
                    reader.onerror = function() {
                      console.error('Failed to read file');
                      alert('Failed to read the image file. Please try again.');
                    };
                    
                    reader.readAsDataURL(file);
                    
                  } catch (error) {
                    console.error('Error updating profile picture:', error);
                    alert('Failed to update profile picture. Please try again.');
                  }
            }
          };
          input.click();
        };
      }

      // Profile picture delete
      const deletePicBtn = document.getElementById('deletePicBtn');
      if (deletePicBtn) {
        deletePicBtn.onclick = async function() {
          if (confirm('Are you sure you want to delete your profile picture?')) {
            // Remove from RTDB
            const user = auth.currentUser;
            if (user) {
              const userPath = window.firebase.getUserDataPath('profile');
              if (userPath) {
                await window.firebase.rtdb.ref(userPath).remove();
                console.log('Profile picture removed from RTDB');
              }
            }
            
            await auth.currentUser.updateProfile({ photoURL: '' });
            document.getElementById('profilePic').src = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(auth.currentUser.displayName || auth.currentUser.email || 'U') + '&background=3b82f6&color=fff&size=128';
          }
        };
      }

      // Company logo upload
      const uploadLogoBtn = document.getElementById('uploadLogoBtn');
      if (uploadLogoBtn) {
        uploadLogoBtn.onclick = function() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/png, image/jpeg';
          input.onchange = async function(event) {
            const file = event.target.files[0];
            if (file) {
              if (file.size > 5 * 1024 * 1024) {
                alert('File size must be under 5MB');
                return;
              }
              const reader = new FileReader();
              reader.onload = async function(e) {
                const base64Data = e.target.result;
                document.getElementById('companyLogo').src = base64Data;
                
                // Store company logo in RTDB
                const user = auth.currentUser;
                if (user) {
                  const userPath = window.firebase.getUserDataPath('settings');
                  if (userPath) {
                    await window.firebase.rtdb.ref(userPath).set({
                      companyLogo: base64Data,
                      updatedAt: new Date().toISOString()
                    });
                    console.log('Company logo saved to RTDB');
                  }
                }
                
                document.getElementById('logoStatus').textContent = 'Logo uploaded successfully!';
              };
              reader.readAsDataURL(file);
            }
          };
          input.click();
        };
      }

              // Company logo delete
        const deleteLogoBtn = document.getElementById('deleteLogoBtn');
        if (deleteLogoBtn) {
          deleteLogoBtn.onclick = async function() {
            if (confirm('Are you sure you want to remove the company logo?')) {
              // Remove from RTDB
              const user = auth.currentUser;
              if (user) {
                const userPath = window.firebase.getUserDataPath('settings');
                if (userPath) {
                  await window.firebase.rtdb.ref(userPath).update({
                    companyLogo: null
                  });
                  console.log('Company logo removed from RTDB');
                }
              }
              
              document.getElementById('companyLogo').src = '';
              document.getElementById('logoStatus').textContent = 'Logo removed successfully!';
            }
          };
        }

              // Company logo reset to default
        const resetLogoBtn = document.getElementById('resetLogoBtn');
        if (resetLogoBtn) {
          resetLogoBtn.onclick = async function() {
            if (confirm('Reset to default Tiger Power logo?')) {
              // Remove from RTDB
              const user = auth.currentUser;
              if (user) {
                const userPath = window.firebase.getUserDataPath('settings');
                if (userPath) {
                  await window.firebase.rtdb.ref(userPath).update({
                    companyLogo: null
                  });
                  console.log('Company logo reset in RTDB');
                }
              }
              
              document.getElementById('companyLogo').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjM0I4MkY2Ii8+Cjx0ZXh0IHg9IjY0IiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkY8L3RleHQ+Cjwvc3ZnPgo=';
              document.getElementById('logoStatus').textContent = 'Logo reset to default!';
            }
          };
        }

      // Name update
      const nameForm = document.getElementById('nameForm');
      if (nameForm) {
        nameForm.onsubmit = async function(e) {
          e.preventDefault();
          const first = document.getElementById('firstName').value.trim();
          const last = document.getElementById('lastName').value.trim();
          const nameStatus = document.getElementById('nameStatus');
          nameStatus.textContent = '';
          if (!first) {
            nameStatus.textContent = 'First name required.';
            return;
          }
          const displayName = last ? first + ' ' + last : first;
          try {
            await auth.currentUser.updateProfile({ displayName });
            nameStatus.textContent = 'Name updated!';
          } catch (err) {
            nameStatus.textContent = err.message;
          }
        };
      }

      // Email update
      const emailForm = document.getElementById('emailForm');
      if (emailForm) {
        emailForm.onsubmit = async function(e) {
          e.preventDefault();
          const email = document.getElementById('email').value.trim();
          const emailStatus = document.getElementById('emailStatus');
          emailStatus.textContent = '';
          if (!email) {
            emailStatus.textContent = 'Email required.';
            return;
          }
          try {
            await auth.currentUser.updateEmail(email);
            await saveAdditionalEmails();
            emailStatus.textContent = 'Email updated!';
          } catch (err) {
            emailStatus.textContent = err.message;
          }
        };
      }

      // Password change
      const passwordForm = document.getElementById('passwordForm');
      if (passwordForm) {
        passwordForm.onsubmit = async function(e) {
          e.preventDefault();
          const currentPassword = document.getElementById('currentPassword').value;
          const newPassword = document.getElementById('newPassword').value;
          const passwordStatus = document.getElementById('passwordStatus');
          const passwordError = document.getElementById('passwordError');
          passwordStatus.textContent = '';
          passwordError.textContent = '';
          if (!currentPassword || !newPassword) {
            passwordError.textContent = 'Both fields required.';
            return;
          }
          // Re-authenticate
          const user = auth.currentUser;
          const cred = window.firebase.EmailAuthProvider.credential(user.email, currentPassword);
          try {
            await user.reauthenticateWithCredential(cred);
            await user.updatePassword(newPassword);
            passwordStatus.textContent = 'Password updated!';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
          } catch (err) {
            passwordError.textContent = err.message;
          }
        };
      }

      // Password toggle
      window.togglePassword = function(fieldId, btn) {
        const field = document.getElementById(fieldId);
        if (field.type === 'password') {
          field.type = 'text';
          btn.textContent = 'ðŸ™ˆ';
        } else {
          field.type = 'password';
          btn.textContent = 'ðŸ‘ï¸';
        }
      };
    });

    // Load company logo from RTDB
    function loadCompanyLogo() {
      const companyLogo = document.getElementById('companyLogo');
      if (!companyLogo) return;
      
      const user = auth.currentUser;
      if (user) {
        const userPath = window.firebase.getUserDataPath('settings');
        if (userPath) {
          window.firebase.rtdb.ref(userPath).once('value')
            .then((snapshot) => {
              const settingsData = snapshot.val();
              if (settingsData && settingsData.companyLogo) {
                companyLogo.src = settingsData.companyLogo;
              } else {
                companyLogo.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjM0I4MkY2Ii8+Cjx0ZXh0IHg9IjY0IiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkY8L3RleHQ+Cjwvc3ZnPgo=';
              }
            })
            .catch((error) => {
              console.error('Error loading company logo:', error);
              companyLogo.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjM0I4MkY2Ii8+Cjx0ZXh0IHg9IjY0IiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkY8L3RleHQ+Cjwvc3ZnPgo=';
            });
        } else {
          companyLogo.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjM0I4MkY2Ii8+Cjx0ZXh0IHg9IjY0IiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkY8L3RleHQ+Cjwvc3ZnPgo=';
        }
      } else {
        companyLogo.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjM0I4MkY2Ii8+Cjx0ZXh0IHg9IjY0IiB5PSI3MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkY8L3RleHQ+Cjwvc3ZnPgo=';
      }
      
      // Add error handling for image loading
      companyLogo.onerror = function() {
        this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2QjcyODAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5UaWdlciBQb3dlcjwvdGV4dD4KPC9zdmc+';
      };
    }



    async function exportData() {
      const user = auth.currentUser;
      if (!user) return;

      try {
        showSettingsStatus('Preparing data for export...', 'success');
        
        // Get all user data from Firebase Realtime Database
        const [customersSnapshot, itemsSnapshot, invoicesSnapshot, settingsSnapshot, profileSnapshot] = await Promise.all([
          rtdb.ref(`users/${user.uid}/customers`).once('value'),
          rtdb.ref(`users/${user.uid}/items`).once('value'),
          rtdb.ref(`users/${user.uid}/invoices`).once('value'),
          rtdb.ref(`users/${user.uid}/settings`).once('value'),
          rtdb.ref(`users/${user.uid}/profile`).once('value')
        ]);

        const exportData = {
          exportDate: new Date().toISOString(),
          version: '1.2',
          user: {
            email: user.email,
            displayName: user.displayName
          },
          data: {
            customers: customersSnapshot.val() || {},
            items: itemsSnapshot.val() || {},
            invoices: invoicesSnapshot.val() || {},
            settings: settingsSnapshot.val() || {},
            profile: profileSnapshot.val() || {}
          },
          includesBinaryData: true,
          storageType: 'RTDB'
        };

        // Create and download JSON file
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `tiger-invoice-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showSettingsStatus('Data exported successfully!', 'success');
      } catch (error) {
        showSettingsStatus('Error exporting data: ' + error.message, 'error');
      }
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
          showSettingsStatus('Reading import file...', 'success');
          
          const text = await file.text();
          const importData = JSON.parse(text);
          
          // Validate import data structure
          if (!importData.data || !importData.version) {
            throw new Error('Invalid backup file format');
          }

          if (!confirm(`This will replace all your current data. Are you sure you want to import the backup from ${importData.exportDate ? new Date(importData.exportDate).toLocaleDateString() : 'unknown date'}?`)) {
            return;
          }

          const user = auth.currentUser;
          if (!user) return;

          showSettingsStatus('Importing data...', 'success');

          // Import data to Firebase Realtime Database
          const updates = {};
          if (importData.data.customers) updates[`users/${user.uid}/customers`] = importData.data.customers;
          if (importData.data.items) updates[`users/${user.uid}/items`] = importData.data.items;
          if (importData.data.invoices) updates[`users/${user.uid}/invoices`] = importData.data.invoices;
          if (importData.data.settings) updates[`users/${user.uid}/settings`] = importData.data.settings;
          if (importData.data.profile) updates[`users/${user.uid}/profile`] = importData.data.profile;

          await rtdb.ref().update(updates);

          showSettingsStatus('Data imported successfully! Please refresh the page to see your data.', 'success');
          
          // Refresh data after import
          setTimeout(() => {
            if (document.querySelector('#customers.active')) loadCustomers();
            if (document.querySelector('#items.active')) loadItems();
            if (document.querySelector('#invoices.active')) loadInvoices();
            if (document.querySelector('#settings.active')) initializeSettings();
          }, 2000);

        } catch (error) {
          showSettingsStatus('Error importing data: ' + error.message, 'error');
        }
      };
      input.click();
    }

    async function clearAllData() {
      if (!confirm('Are you sure you want to delete all your data? This action cannot be undone.')) {
        return;
      }

      const user = auth.currentUser;
      if (!user) return;

      try {
        await rtdb.ref(`users/${user.uid}`).remove();
        showSettingsStatus('All data cleared successfully', 'success');
      } catch (error) {
        showSettingsStatus('Error clearing data: ' + error.message, 'error');
      }
    }

    function changePassword() {
      // Create and show password change modal
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>Change Password</h3>
            <button class="modal-close" onclick="closeModal(this)">&times;</button>
          </div>
          <div class="modal-body">
            <form id="passwordChangeForm">
              <div class="form-group">
                <label for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" class="form-control" required minlength="6">
              </div>
              <div class="form-group">
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" id="confirmPassword" class="form-control" required minlength="6">
              </div>
              <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeModal(this)">Cancel</button>
                <button type="submit" class="btn-primary">Change Password</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Add event listener for form submission
      document.getElementById('passwordChangeForm').addEventListener('submit', handlePasswordChange);
    }

    async function handlePasswordChange(event) {
      event.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (newPassword !== confirmPassword) {
        alert('New passwords do not match');
        return;
      }
      
      if (newPassword.length < 6) {
        alert('New password must be at least 6 characters long');
        return;
      }
      
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        // Re-authenticate user before changing password
        const credential = window.firebase.EmailAuthProvider.credential(user.email, currentPassword);
        await user.reauthenticateWithCredential(credential);
        
        // Change password
        await user.updatePassword(newPassword);
        
        showSettingsStatus('Password changed successfully!', 'success');
        closeModal(document.querySelector('.modal-close'));
      } catch (error) {
        if (error.code === 'auth/wrong-password') {
          alert('Current password is incorrect');
        } else {
          alert('Error changing password: ' + error.message);
        }
      }
    }

    function closeModal(element) {
      const modal = element.closest('.modal-overlay');
      if (modal) {
        modal.remove();
      }
    }

    async function deleteAccount() {
      if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        return;
      }

      const user = auth.currentUser;
      if (!user) return;

      try {
        await rtdb.ref(`users/${user.uid}`).remove();
        await user.delete();
        window.location.href = 'login.html';
      } catch (error) {
        showSettingsStatus('Error deleting account: ' + error.message, 'error');
      }
    }

    function showSettingsStatus(message, type) {
      const statusDiv = document.getElementById('settingsStatusMessage');
      statusDiv.innerHTML = `<div style="padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-weight: 600; background: ${type === 'success' ? '#dcfce7' : '#fef2f2'}; color: ${type === 'success' ? 'var(--success-color)' : 'var(--error-color)'}; border: 1px solid ${type === 'success' ? '#bbf7d0' : '#fecaca'};">${message}</div>`;
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 5000);
    }

    // Help page functions
    function toggleFAQ(element) {
      const faqItem = element.parentElement;
      const isActive = faqItem.classList.contains('active');
      
      // Close all FAQ items
      document.querySelectorAll('.faq-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Open clicked item if it wasn't active
      if (!isActive) {
        faqItem.classList.add('active');
      }
    }

    function contactSupport() {
      // This would open a contact form or redirect to support
      alert('Contact support at support@tigerinvoice.com or call us during business hours.');
    }

    // Help page search functionality
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.querySelector('.search-input');
      if (searchInput) {
        searchInput.addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase();
          const sections = document.querySelectorAll('.help-section');
          
          sections.forEach(section => {
            const content = section.textContent.toLowerCase();
            if (content.includes(searchTerm) || searchTerm === '') {
              section.style.display = 'block';
            } else {
              section.style.display = 'none';
            }
          });
        });
      }

      // Smooth scrolling for quick links
      const quickLinks = document.querySelectorAll('.quick-link');
      quickLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({ behavior: 'smooth' });
          }
        });
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey) {
        switch(event.key) {
          case 'n':
            event.preventDefault();
            showPage('create-invoice');
            break;
          case 'c':
            event.preventDefault();
            showPage('customers');
            break;
          case 'i':
            event.preventDefault();
            showPage('items');
            break;
          case 's':
            event.preventDefault();
            // Save current form based on active page
            const activePage = document.querySelector('.page-section.active');
            if (activePage) {
              const pageId = activePage.id;
              if (pageId === 'create-invoice') saveInvoice();
              else if (pageId === 'add-customer') saveCustomer();
              else if (pageId === 'add-item') saveItem();
              else if (pageId === 'settings') saveSettings();
            }
            break;
          case 't':
            event.preventDefault();
            toggleTheme();
            break;
          case 'h':
            event.preventDefault();
            showPage('help');
            break;
        }
      }
    });



    // Real-time Firebase listeners
    let invoicesListener = null;
    let customersListener = null;
    let itemsListener = null;

    function setupRealTimeListeners() {
      const user = auth.currentUser;
      if (!user) return;

      console.log('Setting up real-time Firebase listeners...');

      // Remove existing listeners if any
      if (invoicesListener) {
        rtdb.ref(`users/${user.uid}/invoices`).off('value', invoicesListener);
      }
      if (customersListener) {
        rtdb.ref(`users/${user.uid}/customers`).off('value', customersListener);
      }
      if (itemsListener) {
        rtdb.ref(`users/${user.uid}/items`).off('value', itemsListener);
      }

      // Set up real-time invoice listener
      invoicesListener = (snapshot) => {
        const invoices = snapshot.val() || {};
        console.log('Real-time invoices update:', invoices);
        console.log('Number of invoices:', Object.keys(invoices).length);
        updateDashboardStats(invoices);
        updateRecentInvoices(invoices);
      };

      // Set up real-time customer listener
      customersListener = (snapshot) => {
        const customers = snapshot.val() || {};
        console.log('Real-time customers update:', customers);
        // Customer stats are now handled in updateDashboardStats
      };

      // Set up real-time item listener
      itemsListener = (snapshot) => {
        const items = snapshot.val() || {};
        console.log('Real-time items update:', items);
        // Item stats are now handled in updateDashboardStats
      };

      // Attach listeners
      rtdb.ref(`users/${user.uid}/invoices`).on('value', invoicesListener);
      rtdb.ref(`users/${user.uid}/customers`).on('value', customersListener);
      rtdb.ref(`users/${user.uid}/items`).on('value', itemsListener);

      console.log('Real-time listeners set up successfully');
    }

    function removeRealTimeListeners() {
      const user = auth.currentUser;
      if (!user) return;

      console.log('Removing real-time Firebase listeners...');

      if (invoicesListener) {
        rtdb.ref(`users/${user.uid}/invoices`).off('value', invoicesListener);
        invoicesListener = null;
      }
      if (customersListener) {
        rtdb.ref(`users/${user.uid}/customers`).off('value', customersListener);
        customersListener = null;
      }
      if (itemsListener) {
        rtdb.ref(`users/${user.uid}/items`).off('value', itemsListener);
        itemsListener = null;
      }

      console.log('Real-time listeners removed');
    }

    function updateDashboardStats(invoices) {
      let total = 0, paid = 0, pending = 0, overdue = 0;
      let totalRevenue = 0, paidRevenue = 0, overdueRevenue = 0;

      Object.values(invoices).forEach(invoice => {
        total++;
        const status = (invoice.invoice?.status || invoice.status || '').toLowerCase();
        const amount = parseFloat(invoice.financial?.grandTotal || invoice.grandTotal) || 0;
        
        if (status === 'paid') {
          paid++;
          paidRevenue += amount;
        } else if (status === 'pending') {
          pending++;
        }
        
        // Check if overdue
        const dueDate = invoice.settings?.dateDue || invoice.dueDate;
        if (dueDate && status !== 'paid') {
          const dueDateObj = new Date(dueDate);
          const today = new Date();
          if (dueDateObj < today) {
            overdue++;
            overdueRevenue += amount;
          }
        }
        
        totalRevenue += amount;
      });

      // Update dashboard stats
      const statTotal = document.getElementById('statTotal');
      const statPaid = document.getElementById('statPaid');
      const statPending = document.getElementById('statPending');
      const statOverdue = document.getElementById('statOverdue');

      if (statTotal) statTotal.textContent = total;
      if (statPaid) statPaid.textContent = paid;
      if (statPending) statPending.textContent = pending;
      if (statOverdue) statOverdue.textContent = overdue;

      console.log('Dashboard stats updated:', { total, paid, pending, overdue });
    }

    function updateCustomerStats(customers) {
      const totalCustomers = Object.keys(customers).length;
      console.log('Customer stats updated:', { totalCustomers });
      
      // Also update the dashboard if we're on the dashboard page
      const dashboardStats = document.getElementById('statsGrid');
      if (dashboardStats) {
        console.log('Dashboard stats should be updated with customer count:', totalCustomers);
      }
    }

    function updateItemStats(items) {
      const totalItems = Object.keys(items).length;
      console.log('Item stats updated:', { totalItems });
    }

    // Enhanced dashboard statistics (for initial load)
    async function loadDashboardStats() {
      const user = auth.currentUser;
      if (!user) return;

      try {
        const [customersSnapshot, itemsSnapshot, invoicesSnapshot] = await Promise.all([
          rtdb.ref(`users/${user.uid}/customers`).once('value'),
          rtdb.ref(`users/${user.uid}/items`).once('value'),
          rtdb.ref(`users/${user.uid}/invoices`).once('value')
        ]);

        const customers = customersSnapshot.val() || {};
        const items = itemsSnapshot.val() || {};
        const invoices = invoicesSnapshot.val() || {};

        // Ensure all data is valid objects
        if (!customers || typeof customers !== 'object') {
          console.warn('Invalid customers data:', customers);
        }
        if (!items || typeof items !== 'object') {
          console.warn('Invalid items data:', items);
        }
        if (!invoices || typeof invoices !== 'object') {
          console.warn('Invalid invoices data:', invoices);
        }

        updateDashboardStats(customers, items, invoices);
        updateRecentInvoices(invoices);

        // Set up real-time listeners after initial load
        setupRealTimeListeners();

      } catch (error) {
        console.error('Error loading dashboard stats:', error);
        // Set default empty data to prevent further errors
        updateDashboardStats({}, {}, {});
        updateRecentInvoices({});
      }
    }

    function updateDashboardStats(customers, items, invoices) {
      // Ensure we have valid objects
      customers = customers || {};
      items = items || {};
      invoices = invoices || {};

      // Update customer stats
      const customerCount = Object.keys(customers).length;
      const activeCustomers = Object.values(customers).filter(c => c && c.status === 'active').length;
      
      document.getElementById('statCustomers').textContent = customerCount;
      document.getElementById('statActiveCustomers').textContent = activeCustomers;

      // Update item stats
      const itemCount = Object.keys(items).length;
      const inStockItems = Object.values(items).filter(item => {
        if (!item) return false;
        const stock = parseInt(item.stock) || 0;
        const minStock = parseInt(item.minStock) || 0;
        return stock > minStock;
      }).length;
      const lowStockItems = Object.values(items).filter(item => {
        if (!item) return false;
        const stock = parseInt(item.stock) || 0;
        const minStock = parseInt(item.minStock) || 0;
        return stock > 0 && stock <= minStock;
      }).length;
      const outOfStockItems = Object.values(items).filter(item => {
        if (!item) return false;
        const stock = parseInt(item.stock) || 0;
        return stock === 0;
      }).length;

      document.getElementById('statItems').textContent = itemCount;
      document.getElementById('statInStock').textContent = inStockItems;
      document.getElementById('statLowStock').textContent = lowStockItems;
      document.getElementById('statOutOfStock').textContent = outOfStockItems;

      // Update invoice stats
      const invoiceCount = Object.keys(invoices).length;
      const paidInvoices = Object.values(invoices).filter(invoice => 
        invoice && (invoice.invoice?.status || 'draft').toLowerCase() === 'paid'
      ).length;
      const pendingInvoices = Object.values(invoices).filter(invoice => 
        invoice && (invoice.invoice?.status || 'draft').toLowerCase() === 'pending'
      ).length;
      const overdueInvoices = Object.values(invoices).filter(invoice => 
        invoice && (invoice.invoice?.status || 'draft').toLowerCase() === 'overdue'
      ).length;

      // Update the stats display if elements exist
      const statTotal = document.getElementById('statTotal');
      const statPaid = document.getElementById('statPaid');
      const statPending = document.getElementById('statPending');
      const statOverdue = document.getElementById('statOverdue');

      if (statTotal) statTotal.textContent = invoiceCount;
      if (statPaid) statPaid.textContent = paidInvoices;
      if (statPending) statPending.textContent = pendingInvoices;
      if (statOverdue) statOverdue.textContent = overdueInvoices;
    }

    function updateRecentCustomers(customers) {
      const container = document.getElementById('recentCustomersList');
      if (!container) return;
      
      container.innerHTML = '';

      // Ensure we have a valid object
      customers = customers || {};

      if (Object.keys(customers).length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No customers found. Add your first customer to see it here.</div>';
        return;
      }

      // Convert to array and sort by creation date
      const customerArray = Object.entries(customers)
        .filter(([id, customer]) => customer) // Filter out null/undefined customers
        .map(([id, customer]) => ({ id, ...customer }));
      customerArray.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

      // Show recent 5 customers
      customerArray.slice(0, 5).forEach(customer => {
        const customerDiv = document.createElement('div');
        customerDiv.className = 'list-item';
        
        const initials = (customer.name || 'C').charAt(0).toUpperCase();
        const status = customer.status || 'active';
        const statusClass = status === 'active' ? 'status-active' : 'status-inactive';
        
        customerDiv.innerHTML = `
          <div class="list-item-info">
            <div class="list-item-avatar">${initials}</div>
            <div class="list-item-details">
              <h4>${customer.name || 'N/A'}</h4>
              <p>${customer.phone || 'No phone'}</p>
            </div>
          </div>
          <div class="list-item-status">
            <span class="status-badge ${statusClass}">${status}</span>
            <div class="list-item-actions">
              <button class="action-btn action-btn-edit" onclick="editCustomer('${customer.id}')">Edit</button>
              <button class="action-btn action-btn-delete" onclick="deleteCustomer('${customer.id}')">Delete</button>
            </div>
          </div>
        `;
        
        container.appendChild(customerDiv);
      });
    }

    function updateRecentItems(items) {
      const container = document.getElementById('recentItemsList');
      if (!container) return;
      
      container.innerHTML = '';

      // Ensure we have a valid object
      items = items || {};

      if (Object.keys(items).length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No items found. Add your first item to see it here.</div>';
        return;
      }

      // Convert to array and sort by creation date
      const itemArray = Object.entries(items)
        .filter(([id, item]) => item) // Filter out null/undefined items
        .map(([id, item]) => ({ id, ...item }));
      itemArray.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

      // Show recent 5 items
      itemArray.slice(0, 5).forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'list-item';
        
        const initials = (item.name || 'I').charAt(0).toUpperCase();
        const stock = parseInt(item.stock) || 0;
        const minStock = parseInt(item.minStock) || 0;
        
        let status, statusClass;
        if (stock === 0) {
          status = 'Out of Stock';
          statusClass = 'status-outofstock';
        } else if (stock <= minStock) {
          status = 'Low Stock';
          statusClass = 'status-lowstock';
        } else {
          status = 'In Stock';
          statusClass = 'status-instock';
        }
        
        itemDiv.innerHTML = `
          <div class="list-item-info">
            <div class="list-item-avatar">${initials}</div>
            <div class="list-item-details">
              <h4>${item.name || 'N/A'}</h4>
              <p>Stock: ${stock} | Price: $${parseFloat(item.sellingPrice || 0).toFixed(2)}</p>
            </div>
          </div>
          <div class="list-item-status">
            <span class="status-badge ${statusClass}">${status}</span>
            <div class="list-item-actions">
              <button class="action-btn action-btn-edit" onclick="editItem('${item.code}')">Edit</button>
              <button class="action-btn action-btn-delete" onclick="deleteItem('${item.code}')">Delete</button>
            </div>
          </div>
        `;
        
        container.appendChild(itemDiv);
      });
    }

    function updateRecentInvoices(invoices) {
      const container = document.getElementById('recentInvoicesList');
      if (!container) return;
      
      container.innerHTML = '';
      
      // Ensure we have a valid object
      invoices = invoices || {};

      if (Object.keys(invoices).length === 0) {
        container.innerHTML = `
          <div class="empty-invoices">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
            <h3>No Invoices Yet</h3>
            <p>Create your first invoice to get started with your business</p>
          </div>`;
        return;
      }

      // Convert to array and sort by creation date
      const invoiceArray = Object.entries(invoices)
        .filter(([id, invoice]) => invoice) // Filter out null/undefined invoices
        .map(([id, invoice]) => ({ id, ...invoice }));
      invoiceArray.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

              // Update statistics
        const totalInvoices = invoiceArray.length;
        const paidInvoices = invoiceArray.filter(inv => (inv.invoice?.status || 'Draft').toLowerCase() === 'paid').length;
        const pendingInvoices = invoiceArray.filter(inv => (inv.invoice?.status || 'Draft').toLowerCase() === 'pending').length;
        const overdueInvoices = invoiceArray.filter(inv => (inv.invoice?.status || 'Draft').toLowerCase() === 'overdue').length;

        document.getElementById('totalInvoices').textContent = totalInvoices;
        document.getElementById('paidInvoices').textContent = paidInvoices;
        document.getElementById('pendingInvoices').textContent = pendingInvoices;
        document.getElementById('overdueInvoices').textContent = overdueInvoices;

        // Show recent 5 invoices
        invoiceArray.slice(0, 5).forEach(invoice => {
          const row = document.createElement('tr');
          
          const invoiceNumber = invoice.invoice?.number || '';
          const customerName = invoice.customer?.name || '';
          const totalAmount = parseFloat(invoice.financial?.grandTotal || 0).toFixed(2);
          const status = invoice.invoice?.status || 'Draft';
          const statusClass = getInvoiceStatusClass(status);
          const createdAt = invoice.createdAt ? new Date(invoice.createdAt).toLocaleDateString() : '';
          
          row.innerHTML = `
            <td>${invoiceNumber}</td>
            <td>${customerName}</td>
            <td>${createdAt}</td>
            <td><span class="status-badge ${statusClass}">${status}</span></td>
            <td class="total-amount">${totalAmount} US$</td>
            <td>
              <div class="action-buttons">
                <button class="btn-view" onclick="viewInvoice('${invoice.id}')">View</button>
                <button class="btn-edit" onclick="editInvoice('${invoice.id}')">Edit</button>
                <button class="btn-delete" onclick="deleteInvoice('${invoice.id}')">Delete</button>
              </div>
            </td>
          `;
          
          container.appendChild(row);
        });
    }

    // Helper functions for dashboard actions
    function editCustomer(customerId) {
      window.location.href = `customer.html?edit=${customerId}`;
    }

    function deleteCustomer(customerId) {
      if (confirm('Are you sure you want to delete this customer?')) {
        const user = auth.currentUser;
        if (!user) return;

        rtdb.ref(`users/${user.uid}/customers/${customerId}`).remove()
          .then(() => {
            console.log('Customer deleted successfully');
            loadDashboardStats(); // Refresh dashboard
          })
          .catch(error => {
            console.error('Error deleting customer:', error);
            alert('Error deleting customer: ' + error.message);
          });
      }
    }

    function editItem(itemCode) {
      window.location.href = `item.html?edit=${itemCode}`;
    }

    function deleteItem(itemCode) {
      if (confirm('Are you sure you want to delete this item?')) {
        const user = auth.currentUser;
        if (!user) return;

        rtdb.ref(`users/${user.uid}/items/${itemCode}`).remove()
          .then(() => {
            console.log('Item deleted successfully');
            loadDashboardStats(); // Refresh dashboard
          })
          .catch(error => {
            console.error('Error deleting item:', error);
            alert('Error deleting item: ' + error.message);
          });
      }
    }

    function viewInvoice(invoiceId) {
      // Find the invoice data and show details in a modal
      const user = auth.currentUser;
      if (!user) return;

      rtdb.ref(`users/${user.uid}/invoices/${invoiceId}`).once('value')
        .then(snapshot => {
          const invoice = snapshot.val();
          if (invoice) {
            viewInvoiceDetails({ id: invoiceId, ...invoice });
          } else {
            alert('Invoice not found');
          }
        })
        .catch(error => {
          console.error('Error loading invoice:', error);
          alert('Error loading invoice details');
        });
    }



    // Notification functions
    let currentFilter = 'all';
    let allNotifications = [];

    async function loadNotifications() {
      const user = auth.currentUser;
      if (!user) return;

      try {
        const snapshot = await rtdb.ref(`users/${user.uid}/notifications`).once('value');
        const notifications = snapshot.val();
        
        if (notifications) {
          allNotifications = Object.values(notifications).sort((a, b) => 
            new Date(b.timestamp) - new Date(a.timestamp)
          );
        } else {
          // Create sample notifications for demonstration
          allNotifications = createSampleNotifications();
        }
        
        displayNotifications(allNotifications);
      } catch (error) {
        console.error('Error loading notifications:', error);
        allNotifications = createSampleNotifications();
        displayNotifications(allNotifications);
      }
    }

    function createSampleNotifications() {
      return [];
    }

    function displayNotifications(notifications) {
      const container = document.getElementById('notificationsList');
      const emptyState = document.getElementById('emptyState');
      
      if (notifications.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      container.innerHTML = '';
      
      notifications.forEach(notification => {
        const notificationElement = createNotificationElement(notification);
        container.appendChild(notificationElement);
      });
    }

    function createNotificationElement(notification) {
      const div = document.createElement('div');
      div.className = `notification-item ${notification.read ? '' : 'unread'}`;
      div.onclick = () => handleNotificationClick(notification);
      
      const iconClass = getNotificationIconClass(notification.type);
      const timeAgo = getTimeAgo(notification.timestamp);
      
      div.innerHTML = `
        <div class="notification-icon ${iconClass}">
          ${getNotificationIcon(notification.type)}
        </div>
        <div class="notification-content">
          <div class="notification-header">
            <div>
              <div class="notification-title">${notification.title}</div>
              <div class="notification-time">${timeAgo}</div>
            </div>
          </div>
          <div class="notification-message">${notification.message}</div>
          <div class="notification-actions">
            ${notification.action !== 'none' ? `<button class="notification-btn btn-view" onclick="event.stopPropagation(); handleNotificationAction('${notification.action}', ${JSON.stringify(notification.actionData)})">View</button>` : ''}
            <button class="notification-btn btn-dismiss" onclick="event.stopPropagation(); dismissNotification('${notification.id}')">Dismiss</button>
          </div>
        </div>
      `;
      
      return div;
    }

    function getNotificationIconClass(type) {
      switch (type) {
        case 'overdue': return 'icon-overdue';
        case 'stock': return 'icon-stock';
        case 'system': return 'icon-system';
        case 'success': return 'icon-success';
        default: return 'icon-system';
      }
    }

    function getNotificationIcon(type) {
      switch (type) {
        case 'overdue': return 'âš ï¸';
        case 'stock': return 'ðŸ“¦';
        case 'system': return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>';
        case 'success': return 'âœ…';
        default: return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>';
      }
    }

    function getTimeAgo(timestamp) {
      const now = new Date();
      const time = new Date(timestamp);
      const diffInMinutes = Math.floor((now - time) / (1000 * 60));
      
      if (diffInMinutes < 1) return 'Just now';
      if (diffInMinutes < 60) return `${diffInMinutes} minutes ago`;
      if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)} hours ago`;
      return `${Math.floor(diffInMinutes / 1440)} days ago`;
    }

    function handleNotificationClick(notification) {
      if (!notification.read) {
        markNotificationAsRead(notification.id);
      }
      handleNotificationAction(notification.action, notification.actionData);
    }

    function handleNotificationAction(action, data) {
      switch (action) {
        case 'view_invoice':
          showPage('dashboard');
          // Could scroll to specific invoice
          break;
        case 'view_item':
          showPage('dashboard');
          // Could scroll to specific item
          break;
        case 'none':
        default:
          // No action needed
          break;
      }
    }

    function markNotificationAsRead(notificationId) {
      const notification = allNotifications.find(n => n.id === notificationId);
      if (notification) {
        notification.read = true;
        displayNotifications(allNotifications);
      }
    }

    function dismissNotification(notificationId) {
      allNotifications = allNotifications.filter(n => n.id !== notificationId);
      displayNotifications(allNotifications);
    }

    function markAllAsRead() {
      allNotifications.forEach(notification => {
        notification.read = true;
      });
      displayNotifications(allNotifications);
      showNotificationStatus('All notifications marked as read', 'success');
    }

    function clearAllNotifications() {
      allNotifications = [];
      displayNotifications(allNotifications);
      showNotificationStatus('All notifications cleared', 'success');
    }

    function filterNotifications(filter) {
      currentFilter = filter;
      
      // Update active filter button
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      let filteredNotifications = allNotifications;
      
      switch (filter) {
        case 'unread':
          filteredNotifications = allNotifications.filter(n => !n.read);
          break;
        case 'overdue':
          filteredNotifications = allNotifications.filter(n => n.type === 'overdue');
          break;
        case 'stock':
          filteredNotifications = allNotifications.filter(n => n.type === 'stock');
          break;
        case 'system':
          filteredNotifications = allNotifications.filter(n => n.type === 'system');
          break;
        case 'all':
        default:
          filteredNotifications = allNotifications;
          break;
      }
      
      displayNotifications(filteredNotifications);
    }

    function showNotificationStatus(message, type) {
      const statusDiv = document.getElementById('notificationStatusMessage');
      statusDiv.innerHTML = `<div style="padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-weight: 600; background: ${type === 'success' ? '#dcfce7' : '#fef2f2'}; color: ${type === 'success' ? 'var(--success-color)' : 'var(--error-color)'}; border: 1px solid ${type === 'success' ? '#bbf7d0' : '#fecaca'};">${message}</div>`;
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 3000);
    }

    // All Invoices functionality
    let allInvoicesData = [];
    let currentInvoiceFilter = 'all';
    let currentInvoiceSearch = '';

    function showAllInvoices() {
      console.log('showAllInvoices called');
      alert('View All clicked - navigating to all invoices page');
      showPage('all-invoices');
    }

    // Make showAllInvoices available globally
    window.showAllInvoices = showAllInvoices;
    
    // Also make loadAllInvoices available globally for debugging
    window.loadAllInvoices = loadAllInvoices;

    // Load customer and item information for create invoice page
    async function loadCustomerAndItemInfo() {
      console.log('=== LOAD CUSTOMER AND ITEM INFO START ===');
      const user = auth.currentUser;
      if (!user) {
        console.log('No user found, returning early');
        return;
      }
      console.log('User found:', user.uid);

      try {
        // Load customers using the same logic as Select Customer
        console.log('=== RECENT CUSTOMERS - TESTING DATABASE PATHS ===');
        
        // Test different possible paths (same as Select Customer)
        const snapshot = await rtdb.ref(`users/${user.uid}/customers`).once('value');
        const customers = snapshot.val();
        console.log('Path 1 - users/${user.uid}/customers:', customers);
        console.log('Path 1 customer count:', customers ? Object.keys(customers).length : 0);
        
        // Test 2: Try without user path
        const snapshot2 = await rtdb.ref('customers').once('value');
        const customers2 = snapshot2.val();
        console.log('Path 2 - customers:', customers2);
        console.log('Path 2 customer count:', customers2 ? Object.keys(customers2).length : 0);
        
        // Test 3: Try with different user path structure
        const snapshot3 = await rtdb.ref(`customers/${user.uid}`).once('value');
        const customers3 = snapshot3.val();
        console.log('Path 3 - customers/${user.uid}:', customers3);
        console.log('Path 3 customer count:', customers3 ? Object.keys(customers3).length : 0);
        
        // Use the path with the most customers (same logic as Select Customer)
        let finalCustomers = customers;
        let customerCount = customers ? Object.keys(customers).length : 0;
        
        if (customers2 && Object.keys(customers2).length > customerCount) {
          finalCustomers = customers2;
          customerCount = Object.keys(customers2).length;
          console.log('Using Path 2 (customers) - found more customers');
        }
        
        if (customers3 && Object.keys(customers3).length > customerCount) {
          finalCustomers = customers3;
          customerCount = Object.keys(customers3).length;
          console.log('Using Path 3 (customers/${user.uid}) - found more customers');
        }
        
        console.log('Final customers data for recent display:', finalCustomers);
        console.log('Final customer count for recent display:', customerCount);
        
                  if (finalCustomers) {
            console.log('=== CUSTOMER DATA ANALYSIS ===');
            console.log('Recent customers - Raw data:', finalCustomers);
            console.log('Total customers in database:', Object.keys(finalCustomers).length);
            console.log('Customer keys:', Object.keys(finalCustomers));
            
            const allCustomers = Object.entries(finalCustomers);
            console.log('All customer entries:', allCustomers.length);
            console.log('Customer entries details:', allCustomers.map(([id, customer]) => ({ id, customer: customer ? 'exists' : 'null/undefined' })));
            
            const filteredCustomers = allCustomers.filter(([id, customer]) => {
              const isValid = customer && customer !== null && customer !== undefined;
              if (!isValid) {
                console.log('Filtering out customer:', id, 'because customer is:', customer);
              }
              return isValid;
            });
            console.log('Customers after filtering null/undefined:', filteredCustomers.length);
          
                      console.log('=== CUSTOMER MAPPING ===');
            const mappedCustomers = filteredCustomers.map(([id, customer]) => ({ id, ...customer }));
            console.log('Mapped customers count:', mappedCustomers.length);
            console.log('Mapped customers with dates:', mappedCustomers.map(c => ({ 
              id: c.id, 
              name: c.name || c.customerName, 
              createdAt: c.createdAt, 
              timestamp: c.timestamp,
              hasDate: !!(c.createdAt || c.timestamp)
            })));
          
          console.log('=== CUSTOMER SORTING ===');
          const customerArray = mappedCustomers
            .sort((a, b) => {
              const dateA = new Date(b.createdAt || b.timestamp || 0);
              const dateB = new Date(a.createdAt || a.timestamp || 0);
              console.log('Sorting:', a.id, 'date:', dateA, 'vs', b.id, 'date:', dateB);
              return dateA - dateB;
            })
            .slice(0, 10); // Show 10 most recent instead of 5

          console.log('=== FINAL CUSTOMER ARRAY ===');
          console.log('Recent customers - Processed data:', customerArray);
          console.log('Final customer count:', customerArray.length);
          updateRecentCustomersDisplay(customerArray);
        } else {
          console.log('=== NO CUSTOMERS FOUND ===');
          console.log('No customers found for recent display');
          updateRecentCustomersDisplay([]);
        }

        // Load items using the same logic as customers
        console.log('=== RECENT ITEMS - TESTING DATABASE PATHS ===');
        
        // Test different possible paths (same as customers)
        const itemsSnapshot = await rtdb.ref(`users/${user.uid}/items`).once('value');
        const items = itemsSnapshot.val();
        console.log('Path 1 - users/${user.uid}/items:', items);
        console.log('Path 1 item count:', items ? Object.keys(items).length : 0);
        
        // Test 2: Try without user path
        const itemsSnapshot2 = await rtdb.ref('items').once('value');
        const items2 = itemsSnapshot2.val();
        console.log('Path 2 - items:', items2);
        console.log('Path 2 item count:', items2 ? Object.keys(items2).length : 0);
        
        // Test 3: Try with different user path structure
        const itemsSnapshot3 = await rtdb.ref(`items/${user.uid}`).once('value');
        const items3 = itemsSnapshot3.val();
        console.log('Path 3 - items/${user.uid}:', items3);
        console.log('Path 3 item count:', items3 ? Object.keys(items3).length : 0);
        
        // Use the path with the most items (same logic as customers)
        let finalItems = items;
        let itemCount = items ? Object.keys(items).length : 0;
        
        if (items2 && Object.keys(items2).length > itemCount) {
          finalItems = items2;
          itemCount = Object.keys(items2).length;
          console.log('Using Path 2 (items) - found more items');
        }
        
        if (items3 && Object.keys(items3).length > itemCount) {
          finalItems = items3;
          itemCount = Object.keys(items3).length;
          console.log('Using Path 3 (items/${user.uid}) - found more items');
        }
        
        console.log('Final items data for recent display:', finalItems);
        console.log('Final item count for recent display:', itemCount);
        
        if (finalItems) {
          console.log('=== ITEM DATA ANALYSIS ===');
          console.log('Recent items - Raw data:', finalItems);
          console.log('Total items in database:', Object.keys(finalItems).length);
          console.log('Item keys:', Object.keys(finalItems));
          
          const allItems = Object.entries(finalItems);
          console.log('All item entries:', allItems.length);
          console.log('Item entries details:', allItems.map(([id, item]) => ({ id, item: item ? 'exists' : 'null/undefined' })));
          
          const filteredItems = allItems.filter(([id, item]) => {
            const isValid = item && item !== null && item !== undefined;
            if (!isValid) {
              console.log('Filtering out item:', id, 'because item is:', item);
            }
            return isValid;
          });
          console.log('Items after filtering null/undefined:', filteredItems.length);
          
          console.log('=== ITEM MAPPING ===');
          const mappedItems = filteredItems.map(([id, item]) => ({ id, ...item }));
          console.log('Mapped items count:', mappedItems.length);
          console.log('Mapped items with dates:', mappedItems.map(i => ({ 
            id: i.id, 
            name: i.name || i.itemName, 
            createdAt: i.createdAt, 
            timestamp: i.timestamp,
            hasDate: !!(i.createdAt || i.timestamp)
          })));
          
          console.log('=== ITEM SORTING ===');
          const itemArray = mappedItems
            .sort((a, b) => {
              const dateA = new Date(b.createdAt || b.timestamp || 0);
              const dateB = new Date(a.createdAt || a.timestamp || 0);
              console.log('Sorting:', a.id, 'date:', dateA, 'vs', b.id, 'date:', dateB);
              return dateA - dateB;
            })
            .slice(0, 10); // Show 10 most recent instead of 5
          
          console.log('=== FINAL ITEM ARRAY ===');
          console.log('Recent items - Processed data:', itemArray);
          console.log('Final item count:', itemArray.length);
          updateRecentItemsDisplay(itemArray);
        } else {
          console.log('=== NO ITEMS FOUND ===');
          console.log('No items found for recent display');
          updateRecentItemsDisplay([]);
        }

      } catch (error) {
        console.log('=== ERROR OCCURRED ===');
        console.error('Error loading customer and item info:', error);
        updateRecentCustomersDisplay([]);
        updateRecentItemsDisplay([]);
      }
      
      console.log('=== LOAD CUSTOMER AND ITEM INFO END ===');
    }

    function updateRecentCustomersDisplay(customers) {
      console.log('=== UPDATE RECENT CUSTOMERS DISPLAY START ===');
      console.log('updateRecentCustomersDisplay called with:', customers);
      console.log('Customers array length:', customers.length);
      
      const container = document.getElementById('recentCustomersList');
      const countElement = document.getElementById('customerCount');
      
      console.log('Container found:', !!container);
      console.log('Count element found:', !!countElement);
      
      if (!container) {
        console.log('Recent customers container not found');
        return;
      }
      
      countElement.textContent = customers.length;
      
      if (customers.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No customers found</div>';
        return;
      }
      
      container.innerHTML = '';
      
      console.log('=== PROCESSING CUSTOMERS FOR DISPLAY ===');
      customers.forEach((customer, index) => {
        console.log(`Processing customer ${index + 1}:`, customer);
        const div = document.createElement('div');
        div.className = 'info-item';
        
        const customerName = customer.name || customer.customerName || 'N/A';
        const customerId = customer.code || customer.customerId || customer.id || '';
        const customerPhone = customer.phone || '';
        const status = customer.status || 'Active';
        const statusClass = status.toLowerCase() === 'active' ? 'status-active' : 'status-inactive';
        
        console.log('Customer display data:', { customerName, customerId, customerPhone, status });
        
        div.innerHTML = `
          <div>
            <div class="info-item-name">${customerName}</div>
            <div class="info-item-details">${customerId} â€¢ ${customerPhone}</div>
          </div>
          <span class="info-item-status ${statusClass}">${status}</span>
        `;
        
        container.appendChild(div);
        console.log(`Customer ${index + 1} div added to DOM`);
      });
      
      console.log('=== UPDATE RECENT CUSTOMERS DISPLAY END ===');
    }

    function updateRecentItemsDisplay(items) {
      console.log('=== UPDATE RECENT ITEMS DISPLAY START ===');
      console.log('updateRecentItemsDisplay called with:', items);
      console.log('Items array length:', items.length);
      
      const container = document.getElementById('recentItemsList');
      const countElement = document.getElementById('itemCount');
      
      console.log('Container found:', !!container);
      console.log('Count element found:', !!countElement);
      
      if (!container) {
        console.log('Recent items container not found');
        return;
      }
      
      countElement.textContent = items.length;
      
      if (items.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No items found</div>';
        return;
      }
      
      container.innerHTML = '';
      
      console.log('=== PROCESSING ITEMS FOR DISPLAY ===');
      items.forEach((item, index) => {
        console.log(`Processing item ${index + 1}:`, item);
        const div = document.createElement('div');
        div.className = 'info-item';
        
        const itemName = item.name || item.itemName || 'N/A';
        const itemCode = item.code || item.itemCode || item.id || '';
        const itemQuantity = item.quantity || 0;
        const status = itemQuantity > 0 ? 'In Stock' : 'Out of Stock';
        const statusClass = itemQuantity > 0 ? 'status-active' : 'status-inactive';
        
        console.log('Item display data:', { itemName, itemCode, itemQuantity, status });
        
        div.innerHTML = `
          <div>
            <div class="info-item-name">${itemName}</div>
            <div class="info-item-details">${itemCode} â€¢ Qty: ${itemQuantity}</div>
          </div>
          <span class="info-item-status ${statusClass}">${status}</span>
        `;
        
        container.appendChild(div);
        console.log(`Item ${index + 1} div added to DOM`);
      });
      
      console.log('=== UPDATE RECENT ITEMS DISPLAY END ===');
    }

    async function loadAllInvoices() {
      console.log('loadAllInvoices called');
      const user = auth.currentUser;
      if (!user) {
        console.log('No user found');
        return;
      }

      try {
        const snapshot = await rtdb.ref(`users/${user.uid}/invoices`).once('value');
        const invoices = snapshot.val();
        
        if (invoices) {
          console.log('Invoices found:', invoices);
          allInvoicesData = Object.entries(invoices)
            .filter(([id, invoice]) => invoice)
            .map(([id, invoice]) => ({ id, ...invoice }))
            .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
          console.log('Processed invoices:', allInvoicesData);
        } else {
          console.log('No invoices found');
          allInvoicesData = [];
        }
        
        updateAllInvoicesDisplay();
        updateAllInvoicesStats();
      } catch (error) {
        console.error('Error loading all invoices:', error);
        allInvoicesData = [];
        updateAllInvoicesDisplay();
        updateAllInvoicesStats();
      }
    }

    function updateAllInvoicesDisplay() {
      console.log('updateAllInvoicesDisplay called');
      const container = document.getElementById('allInvoicesList');
      const emptyState = document.getElementById('emptyInvoicesState');
      
      if (!container) {
        console.log('Container not found');
        return;
      }
      
      // Filter invoices based on current filter and search
      let filteredInvoices = allInvoicesData;
      
      // Apply status filter
      if (currentInvoiceFilter !== 'all') {
        filteredInvoices = filteredInvoices.filter(invoice => {
          const status = (invoice.invoice?.status || 'Draft').toLowerCase();
          return status === currentInvoiceFilter.toLowerCase();
        });
      }
      
      // Apply search filter
      if (currentInvoiceSearch) {
        const searchTerm = currentInvoiceSearch.toLowerCase();
        filteredInvoices = filteredInvoices.filter(invoice => {
          const invoiceNumber = invoice.invoice?.number || '';
          const customerName = invoice.customer?.name || '';
          const customerCode = invoice.customer?.code || '';
          return invoiceNumber.toLowerCase().includes(searchTerm) ||
                 customerName.toLowerCase().includes(searchTerm) ||
                 customerCode.toLowerCase().includes(searchTerm);
        });
      }
      
      if (filteredInvoices.length === 0) {
        container.innerHTML = '';
        if (emptyState) emptyState.style.display = 'block';
        return;
      }

      if (emptyState) emptyState.style.display = 'none';
      container.innerHTML = '';

      console.log('Displaying', filteredInvoices.length, 'invoices');
      filteredInvoices.forEach(invoice => {
        const row = document.createElement('tr');
        
        const invoiceNumber = invoice.invoice?.number || '';
        const customerName = invoice.customer?.name || '';
        const totalAmount = parseFloat(invoice.financial?.grandTotal || 0).toFixed(2);
        const status = invoice.invoice?.status || 'Draft';
        const statusClass = getInvoiceStatusClass(status);
        const createdAt = invoice.createdAt ? new Date(invoice.createdAt).toLocaleDateString() : '';
        
        console.log('Adding invoice:', invoiceNumber, customerName, totalAmount);
        
        row.innerHTML = `
          <td>${invoiceNumber}</td>
          <td>${customerName}</td>
          <td>${createdAt}</td>
          <td><span class="status-badge ${statusClass}">${status}</span></td>
          <td class="total-amount">${totalAmount} US$</td>
          <td>
            <div class="action-buttons">
              <button class="btn-view" onclick="viewInvoice('${invoice.id}')">View</button>
              <button class="btn-edit" onclick="editInvoice('${invoice.id}')">Edit</button>
              <button class="btn-delete" onclick="deleteInvoice('${invoice.id}')">Delete</button>
            </div>
          </td>
        `;
        
        container.appendChild(row);
      });
    }

    function updateAllInvoicesStats() {
      const totalInvoices = allInvoicesData.length;
      const paidInvoices = allInvoicesData.filter(inv => (inv.invoice?.status || 'Draft').toLowerCase() === 'paid').length;
      const pendingInvoices = allInvoicesData.filter(inv => (inv.invoice?.status || 'Draft').toLowerCase() === 'pending').length;
      const overdueInvoices = allInvoicesData.filter(inv => (inv.invoice?.status || 'Draft').toLowerCase() === 'overdue').length;

      document.getElementById('allTotalInvoices').textContent = totalInvoices;
      document.getElementById('allPaidInvoices').textContent = paidInvoices;
      document.getElementById('allPendingInvoices').textContent = pendingInvoices;
      document.getElementById('allOverdueInvoices').textContent = overdueInvoices;
    }

    function filterInvoices() {
      currentInvoiceSearch = document.getElementById('invoiceSearch').value;
      updateAllInvoicesDisplay();
    }

    function filterInvoicesByStatus(status) {
      currentInvoiceFilter = status;
      
      // Update active filter button
      document.querySelectorAll('.filter-buttons .filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      updateAllInvoicesDisplay();
    }

    function loadEditInvoiceData() {
      const editData = sessionStorage.getItem('editInvoiceData');
      if (editData) {
        try {
          const invoice = JSON.parse(editData);
          
          // Update the page title to indicate editing mode
          const headerTitle = document.querySelector('#create-invoice .header h1');
          if (headerTitle) {
            headerTitle.textContent = `Edit Invoice - ${invoice.invoice?.number || invoice.invoiceNo || 'N/A'}`;
          }
          
          // Populate customer information
          if (invoice.customer) {
            document.getElementById('customer').value = invoice.customer.code || '';
            document.getElementById('customerName').value = invoice.customer.name || '';
            document.getElementById('contact').value = invoice.customer.contact || '';
            document.getElementById('address').value = invoice.customer.address || '';
            document.getElementById('phone').value = invoice.customer.phone || '';
            document.getElementById('customerGroup').value = invoice.customer.group || '';
            document.getElementById('taxNumber').value = invoice.customer.taxNumber || '';
          }
          
          // Populate invoice information
          if (invoice.invoice) {
            document.getElementById('invoiceType').value = invoice.invoice.type || '';
            document.getElementById('invoiceNo').value = invoice.invoice.number || '';
            document.getElementById('invoiceDate').value = invoice.invoice.date || '';
            document.getElementById('status').value = invoice.invoice.status || 'Draft';
          }
          
          // Populate settings information
          if (invoice.settings) {
            document.getElementById('warehouse').value = invoice.settings.warehouse || '';
            document.getElementById('sale').value = invoice.settings.sale || '';
            document.getElementById('paymentTerm').value = invoice.settings.paymentTerm || '';
            document.getElementById('currency').value = invoice.settings.currency || '';
            document.getElementById('refNumber').value = invoice.settings.refNumber || '';
            document.getElementById('dateDue').value = invoice.settings.dateDue || '';
            document.getElementById('shipping').value = invoice.settings.shipping || '';
            document.getElementById('dateShip').value = invoice.settings.dateShip || '';
            document.getElementById('note').value = invoice.settings.note || '';
            document.getElementById('shipAddress').value = invoice.settings.shipAddress || '';
            document.getElementById('soNumber').value = invoice.settings.soNumber || '';
            document.getElementById('soDate').value = invoice.settings.soDate || '';
            document.getElementById('reference').value = invoice.settings.reference || '';
          }
          
          // Populate financial information
          if (invoice.financial) {
            document.getElementById('subTotal').value = invoice.financial.subTotal || '0.00';
            document.getElementById('cashAccount').value = invoice.financial.cashAccount || '';
            document.getElementById('promotionPercent').value = invoice.financial.promotionPercent || '0';
            document.getElementById('promotionAmount').value = invoice.financial.promotionAmount || '0.00';
            document.getElementById('proAmount').value = invoice.financial.proAmount || '0.00';
            document.getElementById('netDue').value = invoice.financial.netDue || '0.00';
            document.getElementById('discountPercent').value = invoice.financial.discountPercent || '0';
            document.getElementById('discountAmount').value = invoice.financial.discountAmount || '0.00';
            document.getElementById('reference2').value = invoice.financial.reference2 || '';
            document.getElementById('vatPercent').value = invoice.financial.vatPercent || '0';
            document.getElementById('deAccount').value = invoice.financial.deAccount || '';
            document.getElementById('accountNoD').value = invoice.financial.accountNoD || '';
            document.getElementById('grandTotal').value = invoice.financial.grandTotal || '0.00';
            document.getElementById('grandTotalWords').value = invoice.financial.grandTotalWords || '';
          }
          
          // Populate items
          if (invoice.items && Array.isArray(invoice.items)) {
            // Clear existing items
            const itemsBody = document.getElementById('itemsBody');
            if (itemsBody) {
              itemsBody.innerHTML = '';
              
              // Add each item
              invoice.items.forEach((item, index) => {
                addItemRow();
                const lastRow = itemsBody.lastElementChild;
                
                // Populate item fields
                const itemCodeInput = lastRow.querySelector('input[placeholder="Enter item code"]');
                const itemDescriptionInput = lastRow.querySelector('.item-description');
                const warehouseInput = lastRow.querySelector('input[readonly]');
                const qtyInput = lastRow.querySelector('.item-qty');
                const priceInput = lastRow.querySelector('.item-price');
                const discountPercentInput = lastRow.querySelector('.item-discount-percent');
                const discountAmountInput = lastRow.querySelector('.item-discount-amount');
                const amountInput = lastRow.querySelector('.item-total');
                
                if (itemCodeInput) itemCodeInput.value = item.code || '';
                if (itemDescriptionInput) itemDescriptionInput.value = item.description || '';
                if (warehouseInput) warehouseInput.value = item.warehouse || '';
                if (qtyInput) qtyInput.value = item.qty || '';
                if (priceInput) priceInput.value = item.price || '';
                if (discountPercentInput) discountPercentInput.value = item.discountPercent || '';
                if (discountAmountInput) discountAmountInput.value = item.discountAmount || '';
                if (amountInput) amountInput.value = item.amount || '';
                
                // Trigger calculation for this row
                calculateRowAmount(lastRow);
              });
            }
          }
          
          // Handle logo if exists
          if (invoice.logo) {
            const logoPreview = document.getElementById('logoPreview');
            if (logoPreview) {
              logoPreview.src = invoice.logo;
              logoPreview.style.display = 'block';
            }
            const logoStatus = document.getElementById('logoStatus');
            if (logoStatus) {
              logoStatus.textContent = 'Logo loaded from saved invoice';
            }
          }
          
          // Calculate totals
          calculateTotals();
          
          // Clear the session storage
          sessionStorage.removeItem('editInvoiceData');
          
        } catch (error) {
          console.error('Error loading edit invoice data:', error);
        }
      }
    }

    function editInvoice(invoiceId) {
      // Navigate to create invoice page with the invoice data for editing
      const user = auth.currentUser;
      if (!user) return;

      rtdb.ref(`users/${user.uid}/invoices/${invoiceId}`).once('value')
        .then(snapshot => {
          const invoice = snapshot.val();
          if (invoice) {
            // Store the invoice data in sessionStorage for editing
            sessionStorage.setItem('editInvoiceData', JSON.stringify({ id: invoiceId, ...invoice }));
            showPage('create-invoice');
            // The create invoice page will load the data from sessionStorage
          } else {
            alert('Invoice not found');
          }
        })
        .catch(error => {
          console.error('Error loading invoice for editing:', error);
          alert('Error loading invoice for editing');
        });
    }

    function deleteInvoice(invoiceId) {
      if (confirm('Are you sure you want to delete this invoice?')) {
        const user = auth.currentUser;
        if (!user) return;

        rtdb.ref(`users/${user.uid}/invoices/${invoiceId}`).remove()
          .then(() => {
            console.log('Invoice deleted successfully');
            loadDashboardStats(); // Refresh dashboard
          })
          .catch(error => {
            console.error('Error deleting invoice:', error);
            alert('Error deleting invoice: ' + error.message);
          });
      }
    }

    function getInvoiceStatusClass(status) {
      const statusLower = (status || '').toLowerCase();
      switch (statusLower) {
        case 'paid':
          return 'status-paid';
        case 'pending':
          return 'status-pending';
        case 'overdue':
          return 'status-overdue';
        default:
          return 'status-draft';
      }
    }

    function formatDate(dateString) {
      if (!dateString || dateString === 'N/A') return 'N/A';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString();
      } catch (error) {
        return dateString;
      }
    }

    function formatCurrency(amount) {
      if (!amount || isNaN(amount)) return '$0.00';
      return `$${parseFloat(amount).toFixed(2)}`;
    }

    function getInvoiceStatusClass(status) {
      const statusLower = (status || '').toLowerCase();
      switch (statusLower) {
        case 'paid':
          return 'status-paid';
        case 'pending':
          return 'status-pending';
        case 'overdue':
          return 'status-overdue';
        case 'draft':
        default:
          return 'status-draft';
      }
    }

    function viewInvoiceDetails(invoice) {
      // Create a modal to show invoice details
      const modal = document.createElement('div');
      modal.id = 'invoiceDetailsModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;
      
      const content = document.createElement('div');
      content.style.cssText = `
        background: var(--card-bg);
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      `;
      
      const invoiceNumber = invoice.invoice?.number || invoice.invoiceNo || 'N/A';
      const customerName = invoice.customer?.name || invoice.customer || 'N/A';
      const grandTotal = invoice.financial?.grandTotal || invoice.grandTotal || 0;
      const status = invoice.invoice?.status || invoice.status || 'Draft';
      
      content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0; color: var(--text-primary);">Invoice Details</h3>
          <button onclick="closeInvoiceModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
        </div>
        <div style="margin-bottom: 15px;">
          <strong>Invoice Number:</strong> ${invoiceNumber}
        </div>
        <div style="margin-bottom: 15px;">
          <strong>Customer:</strong> ${customerName}
        </div>
        <div style="margin-bottom: 15px;">
          <strong>Status:</strong> <span class="status-badge ${getInvoiceStatusClass(status)}">${status}</span>
        </div>
        <div style="margin-bottom: 15px;">
          <strong>Total Amount:</strong> ${formatCurrency(grandTotal)}
        </div>
        <div style="margin-bottom: 15px;">
          <strong>Created:</strong> ${formatDate(invoice.createdAt)}
        </div>
        <div style="margin-top: 20px;">
          <button onclick="editInvoiceFromModal('${invoiceNumber}')" style="padding: 8px 16px; background: var(--active-color); color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">Edit Invoice</button>
          <button onclick="printInvoiceFromModal('${invoiceNumber}')" style="padding: 8px 16px; background: var(--text-secondary); color: white; border: none; border-radius: 6px; cursor: pointer;">Print Invoice</button>
        </div>
      `;
      
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      // Add click outside to close functionality
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeInvoiceModal();
        }
      });
      
      // Add escape key to close functionality
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeInvoiceModal();
        }
      });
    }

    function closeInvoiceModal() {
      const modal = document.getElementById('invoiceDetailsModal');
      if (modal) {
        modal.remove();
      }
    }

    function editInvoiceFromModal(invoiceNumber) {
      // Close modal and navigate to create invoice page
      closeInvoiceModal();
      showPage('create-invoice');
      
      // Load invoice data into form
      loadInvoiceForEditing(invoiceNumber);
    }

    async function loadInvoiceForEditing(invoiceNumber) {
      const user = auth.currentUser;
      if (!user) return;

      try {
        console.log('Loading invoice for editing:', invoiceNumber);
        
        // First, try to find the invoice in the invoices collection
        const userPath = window.firebase.getUserDataPath('invoices');
        const snapshot = await window.firebase.rtdb.ref(userPath).once('value');
        const invoices = snapshot.val();
        
        let invoiceData = null;
        
        if (invoices) {
          // Search through all invoices to find the one with matching number
          for (const key in invoices) {
            const invoice = invoices[key];
            if (invoice.invoice?.number === invoiceNumber || 
                invoice.invoiceNo === invoiceNumber || 
                key === invoiceNumber) {
              invoiceData = invoice;
              break;
            }
          }
        }
        
        if (invoiceData) {
          console.log('Invoice data loaded for editing:', invoiceData);
          populateInvoiceForm(invoiceData);
        } else {
          console.error('Invoice not found:', invoiceNumber);
          alert('Invoice not found. Please try again.');
        }
      } catch (error) {
        console.error('Error loading invoice for editing:', error);
        alert('Error loading invoice data. Please try again.');
      }
    }

    function populateInvoiceForm(invoiceData) {
      console.log('Populating invoice form with data:', invoiceData);
      
      try {
        // Populate customer information
        if (invoiceData.customer) {
          const customerElement = document.getElementById('customer');
          const customerNameElement = document.getElementById('customerName');
          const contactElement = document.getElementById('contact');
          const addressElement = document.getElementById('address');
          const phoneElement = document.getElementById('phone');
          const customerGroupElement = document.getElementById('customerGroup');
          const taxNumberElement = document.getElementById('taxNumber');
          
          if (customerElement) customerElement.value = invoiceData.customer.code || '';
          if (customerNameElement) customerNameElement.value = invoiceData.customer.name || '';
          if (contactElement) contactElement.value = invoiceData.customer.contact || '';
          if (addressElement) addressElement.value = invoiceData.customer.address || '';
          if (phoneElement) phoneElement.value = invoiceData.customer.phone || '';
          if (customerGroupElement) customerGroupElement.value = invoiceData.customer.group || '';
          if (taxNumberElement) taxNumberElement.value = invoiceData.customer.taxNumber || '';
        }

        // Populate invoice information
        if (invoiceData.invoice) {
          const invoiceTypeElement = document.getElementById('invoiceType');
          const invoiceNoElement = document.getElementById('invoiceNo');
          const invoiceDateElement = document.getElementById('invoiceDate');
          const statusElement = document.getElementById('status');
          
          if (invoiceTypeElement) invoiceTypeElement.value = invoiceData.invoice.type || '';
          if (invoiceNoElement) invoiceNoElement.value = invoiceData.invoice.number || '';
          if (invoiceDateElement) invoiceDateElement.value = invoiceData.invoice.date || '';
          if (statusElement) statusElement.value = invoiceData.invoice.status || 'Draft';
        }

        // Populate settings
        if (invoiceData.settings) {
          const warehouseElement = document.getElementById('warehouse');
          const saleElement = document.getElementById('sale');
          const paymentTermElement = document.getElementById('paymentTerm');
          const currencyElement = document.getElementById('currency');
          const refNumberElement = document.getElementById('refNumber');
          const dateDueElement = document.getElementById('dateDue');
          const shippingElement = document.getElementById('shipping');
          const dateShipElement = document.getElementById('dateShip');
          const noteElement = document.getElementById('note');
          const shipAddressElement = document.getElementById('shipAddress');
          const soNumberElement = document.getElementById('soNumber');
          const soDateElement = document.getElementById('soDate');
          const referenceElement = document.getElementById('reference');
          
          if (warehouseElement) warehouseElement.value = invoiceData.settings.warehouse || '';
          if (saleElement) saleElement.value = invoiceData.settings.sale || '';
          if (paymentTermElement) paymentTermElement.value = invoiceData.settings.paymentTerm || '';
          if (currencyElement) currencyElement.value = invoiceData.settings.currency || '';
          if (refNumberElement) refNumberElement.value = invoiceData.settings.refNumber || '';
          if (dateDueElement) dateDueElement.value = invoiceData.settings.dateDue || '';
          if (shippingElement) shippingElement.value = invoiceData.settings.shipping || '';
          if (dateShipElement) dateShipElement.value = invoiceData.settings.dateShip || '';
          if (noteElement) noteElement.value = invoiceData.settings.note || '';
          if (shipAddressElement) shipAddressElement.value = invoiceData.settings.shipAddress || '';
          if (soNumberElement) soNumberElement.value = invoiceData.settings.soNumber || '';
          if (soDateElement) soDateElement.value = invoiceData.settings.soDate || '';
          if (referenceElement) referenceElement.value = invoiceData.settings.reference || '';
        }

        // Populate items table
        if (invoiceData.items && invoiceData.items.length > 0) {
          populateItemsTable(invoiceData.items);
        }

        // Populate financial information
        if (invoiceData.financial) {
          const subTotalElement = document.getElementById('subTotal');
          const grandTotalElement = document.getElementById('grandTotal');
          
          if (subTotalElement) subTotalElement.value = invoiceData.financial.subTotal || '0.00';
          if (grandTotalElement) grandTotalElement.value = invoiceData.financial.grandTotal || '0.00';
        }

        console.log('Invoice form populated successfully');
      } catch (error) {
        console.error('Error populating invoice form:', error);
        alert('Error loading invoice data. Some fields may not be populated correctly.');
      }
    }

    function populateItemsTable(items) {
      const tbody = document.getElementById('itemsBody');
      if (!tbody) return;

      tbody.innerHTML = ''; // Clear existing items

      items.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="text" value="${item.code || ''}" onchange="updateRow(this)"></td>
          <td><input type="text" value="${item.description || ''}" onchange="updateRow(this)"></td>
          <td><input type="text" value="${item.warehouse || ''}" readonly></td>
          <td><input type="number" value="${item.qty || 1}" min="1" onchange="calculateRowAmount(this)"></td>
          <td><input type="number" value="${item.price || '0.00'}" step="0.01" min="0" onchange="calculateRowAmount(this)"></td>
          <td><input type="number" value="${item.discountPercent || '0.00'}" step="0.01" min="0" onchange="calculateRowAmount(this)"></td>
          <td><input type="number" value="${item.discountAmount || '0.0000'}" step="0.01" readonly></td>
          <td><input type="number" value="${item.amount || '0.0000'}" step="0.01" readonly></td>
        `;
        tbody.appendChild(row);
      });

      // Recalculate totals
      calculateTotals();
    }

    function printInvoiceFromModal(invoiceNumber) {
      // Close modal and trigger print
      closeInvoiceModal();
      printInvoice();
    }

        // Initialize theme on page load
    initTheme();
    
    // Initialize dashboard stats on page load
    if (document.getElementById('dashboard').classList.contains('active')) {
      loadDashboardStats();
    }

    // Debug function to manually load data
    function debugLoadData() {
      console.log('=== DEBUG: Loading Data ===');
      const user = auth.currentUser;
      if (!user) {
        console.log('No user logged in');
        return;
      }
      
      console.log('User:', user.uid);
      
      // Test loading customers
      rtdb.ref(`users/${user.uid}/customers`).once('value')
        .then((snapshot) => {
          const customers = snapshot.val();
          console.log('Customers in database:', customers);
        })
        .catch(err => {
          console.error('Error loading customers:', err);
        });
      
      // Test loading items
      rtdb.ref(`users/${user.uid}/items`).once('value')
        .then((snapshot) => {
          const items = snapshot.val();
          console.log('Items in database:', items);
        })
        .catch(err => {
          console.error('Error loading items:', err);
        });
      
      // Test loading invoices
      rtdb.ref(`users/${user.uid}/invoices`).once('value')
        .then((snapshot) => {
          const invoices = snapshot.val();
          console.log('Invoices in database:', invoices);
        })
        .catch(err => {
          console.error('Error loading invoices:', err);
        });
    }

    // Make debug function available globally
    window.debugLoadData = debugLoadData;

    // Function to manually refresh dashboard
    function refreshDashboard() {
      console.log('Manually refreshing dashboard...');
      loadDashboardStats();
    }

    // Make refresh function available globally
    window.refreshDashboard = refreshDashboard;



    // Function to check auth state without redirecting
    function checkAuthState() {
      const user = auth.currentUser;
      console.log('Auth state check - User:', user ? user.uid : 'No user');
      return user;
    }

    // Make auth check available globally
    window.checkAuthState = checkAuthState;

    // Test navigation function
    function testNavigation(pageId) {
      console.log('Testing navigation to:', pageId);
      showPage(pageId);
    }

    // Make test navigation available globally
    window.testNavigation = testNavigation;

    // Logo upload handling for invoices
    let uploadedInvoiceLogo = null;

    function handleInvoiceLogoUpload() {
      const fileInput = document.getElementById('invoiceLogo');
      const previewContainer = document.getElementById('invoiceLogoPreviewContainer');
      
      if (fileInput && previewContainer) {
        fileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          previewContainer.innerHTML = '';
          uploadedInvoiceLogo = null;
          
          if (file && file.type.startsWith('image/')) {
            // Create preview
            const reader = new FileReader();
            reader.onload = function(e) {
              const previewDiv = document.createElement('div');
              previewDiv.style.cssText = `
                position: relative;
                border-radius: 8px;
                overflow: hidden;
                border: 1px solid var(--border-color);
                background: var(--card-bg);
                max-width: 300px;
              `;
              
              previewDiv.innerHTML = 
                '<img src="' + e.target.result + '" style="width: 100%; height: 100px; object-fit: contain; background: white;">' +
                '<button onclick="removeInvoiceLogo()" style="' +
                  'position: absolute;' +
                  'top: 4px;' +
                  'right: 4px;' +
                  'background: var(--error-color);' +
                  'color: white;' +
                  'border: none;' +
                  'border-radius: 50%;' +
                  'width: 24px;' +
                  'height: 24px;' +
                  'cursor: pointer;' +
                  'font-size: 12px;' +
                  'display: flex;' +
                  'align-items: center;' +
                  'justify-content: center;' +
                '">Ã—</button>' +
                '<div style="padding: 8px; font-size: 11px; color: var(--text-secondary); text-align: center;">' +
                  (file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name) +
                '</div>';
              
              previewContainer.appendChild(previewDiv);
              uploadedInvoiceLogo = file;
            };
            reader.readAsDataURL(file);
          }
        });
      }
    }

    function removeInvoiceLogo() {
      uploadedInvoiceLogo = null;
      const previewContainer = document.getElementById('invoiceLogoPreviewContainer');
      if (previewContainer) {
        previewContainer.innerHTML = '';
      }
      const fileInput = document.getElementById('invoiceLogo');
      if (fileInput) {
        fileInput.value = '';
      }
    }

    function updateInvoiceLogoPreview() {
      const previewContainer = document.getElementById('invoiceLogoPreviewContainer');
      if (previewContainer && uploadedInvoiceLogo) {
        previewContainer.innerHTML = '';
        const reader = new FileReader();
        reader.onload = function(e) {
          const previewDiv = document.createElement('div');
          previewDiv.style.cssText = 
            'position: relative;' +
            'border-radius: 8px;' +
            'overflow: hidden;' +
            'border: 1px solid var(--border-color);' +
            'background: var(--card-bg);' +
            'max-width: 300px;';
          
          previewDiv.innerHTML = 
            '<img src="' + e.target.result + '" style="width: 100%; height: 100px; object-fit: contain; background: white;">' +
            '<button onclick="removeInvoiceLogo()" style="' +
              'position: absolute;' +
              'top: 4px;' +
              'right: 4px;' +
              'background: var(--error-color);' +
              'color: white;' +
              'border: none;' +
              'border-radius: 50%;' +
              'width: 24px;' +
              'height: 24px;' +
              'cursor: pointer;' +
              'font-size: 12px;' +
              'display: flex;' +
              'align-items: center;' +
              'justify-content: center;' +
            '">Ã—</button>' +
            '<div style="padding: 8px; font-size: 11px; color: var(--text-secondary); text-align: center;">' +
              (uploadedInvoiceLogo.name.length > 20 ? uploadedInvoiceLogo.name.substring(0, 17) + '...' : uploadedInvoiceLogo.name) +
            '</div>';
          
          previewContainer.appendChild(previewDiv);
        };
        reader.readAsDataURL(uploadedInvoiceLogo);
      }
    }

    async function uploadInvoiceLogoToStorage() {
      const user = auth.currentUser;
      if (!user || !uploadedInvoiceLogo) return null;
      
      try {
        const timestamp = Date.now();
        const fileName = `invoice_logo_${user.uid}_${timestamp}_${uploadedInvoiceLogo.name}`;
        const storageRef = window.firebase.storage.ref(`invoice_logos/${user.uid}/${fileName}`);
        
        const snapshot = await storageRef.put(uploadedInvoiceLogo);
        const downloadURL = await snapshot.ref.getDownloadURL();
        
        return {
          url: downloadURL,
          name: uploadedInvoiceLogo.name,
          path: `invoice_logos/${user.uid}/${fileName}`,
          size: uploadedInvoiceLogo.size,
          type: uploadedInvoiceLogo.type
        };
      } catch (error) {
        console.error('Error uploading logo:', error);
        showStatusMessage(`Error uploading logo: ${error.message}`, 'error');
        return null;
      }
    }
  </script>
</body>
</html> 