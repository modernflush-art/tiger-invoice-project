<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customers - Tiger Invoice</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Segoe+UI:400,600&display=swap">
  <style>
    /* CSS Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #fafbfc;
      --bg-secondary: #ffffff;
      --bg-sidebar: #ffffff;
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --border-color: #e2e8f0;
      --border-light: #f7fafc;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --hover-bg: #f7fafc;
      --active-bg: #ebf8ff;
      --active-color: #f97316;
      --success-color: #38a169;
      --warning-color: #d69e2e;
      --error-color: #e53e3e;
      --card-bg: #ffffff;
      --input-bg: #ffffff;
      --input-border: #e2e8f0;
      --gradient-primary: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
    }

    [data-theme="dark"] {
      --bg-primary: #0f1419;
      --bg-secondary: #1a202c;
      --bg-sidebar: #1a202c;
      --text-primary: #f7fafc;
      --text-secondary: #cbd5e0;
      --text-muted: #718096;
      --border-color: #2d3748;
      --border-light: #4a5568;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
      --hover-bg: #2d3748;
      --active-bg: #2c5282;
      --active-color: #fb923c;
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --error-color: #f56565;
      --card-bg: #1a202c;
      --input-bg: #2d3748;
      --input-border: #4a5568;
      --gradient-primary: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      margin-right: 16px;
    }

    .back-btn:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .back-btn svg {
      width: 16px;
      height: 16px;
      transition: transform 0.2s ease;
    }

    .back-btn:hover svg {
      transform: translateX(-2px);
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      font-family: inherit;
      letter-spacing: 0.3px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow);
      font-family: inherit;
    }

    .btn-secondary:hover {
      background: var(--hover-bg);
      border-color: var(--active-color);
      transform: translateY(-1px);
    }

    .theme-toggle {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
      padding: 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      position: relative;
      overflow: hidden;
    }

    .theme-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .theme-toggle:hover {
      background: var(--hover-bg);
      border-color: var(--active-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .theme-toggle:hover::before {
      left: 100%;
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .theme-toggle:hover svg {
      transform: rotate(180deg);
    }

    .stats-section {
      margin-bottom: 24px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card h3 {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 4px;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .customer-table-wrapper {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }

    .customer-table {
      width: 100%;
      border-collapse: collapse;
    }

    .customer-table th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      border-bottom: 1px solid var(--border-color);
    }

    .customer-table td {
      padding: 16px 12px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .customer-table tbody tr:hover {
      background: var(--hover-bg);
    }

    .loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 40px;
      font-style: italic;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-active {
      background: var(--success-color);
      color: white;
    }

    .status-inactive {
      background: var(--error-color);
      color: white;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-edit {
      background: var(--active-color);
      color: white;
    }

    .btn-delete {
      background: var(--error-color);
      color: white;
    }

    .btn-small:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .customer-table {
        font-size: 14px;
      }
      
      .customer-table th,
      .customer-table td {
        padding: 12px 8px;
      }
    }
  </style>
</head>
<body>
      <div class="container">
      <div class="header">
        <div class="header-left">
          <div style="display: flex; align-items: center; gap: 16px;">
            <button class="back-btn" onclick="window.location.href='index.html'">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              <span>Back</span>
            </button>
            <h1>Customers</h1>
          </div>
        </div>
        <div class="header-actions">
          <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>
          <button class="btn-primary" onclick="showAddCustomerModal()">Add Customer</button>

        </div>
      </div>

    <!-- Status Messages -->
    <div id="customerStatusMessage"></div>

    <!-- Stats Section -->
    <div class="stats-section">
      <div class="stats-grid" id="customerStatsGrid">
        <div class="stat-card">
          <h3>Total Customers</h3>
          <div class="stat-value" id="customerStatTotal">0</div>
        </div>
        <div class="stat-card">
          <h3>Active</h3>
          <div class="stat-value" id="customerStatActive">0</div>
        </div>
        <div class="stat-card">
          <h3>Inactive</h3>
          <div class="stat-value" id="customerStatInactive">0</div>
        </div>
        <div class="stat-card">
          <h3>New This Month</h3>
          <div class="stat-value" id="customerStatNew">0</div>
        </div>
      </div>
    </div>

    <!-- Customer Table -->
    <div class="customer-table-wrapper">
      <table class="customer-table">
        <thead>
          <tr>
            <th>Customer Code</th>
            <th>Customer Name</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="customerTableBody">
          <tr><td colspan="6" class="loading">Loading customers...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC2vUhY8zpsS60dAaxIVXqszC5180sGobc",
      authDomain: "tigerpower-86ca1.firebaseapp.com",
      projectId: "tigerpower-86ca1",
      storageBucket: "tigerpower-86ca1.appspot.com",
      messagingSenderId: "493107786425",
      appId: "1:493107786425:web:39a1448aeba5b9e619e168",
      measurementId: "G-RSSQPCLEDZ",
      databaseURL: "https://tigerpower-86ca1-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    // Initialize Firebase with better error handling
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const rtdb = firebase.database();
    const storage = firebase.storage();

    // Global variables
    let uploadedImages = [];

    // Theme management
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeUI(savedTheme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeUI(newTheme);
    }
    
    // Make toggleTheme globally accessible
    window.toggleTheme = toggleTheme;

    function updateThemeUI(theme) {
      const themeIcon = document.getElementById('themeIcon');
      
      if (!themeIcon) {
        console.warn('Theme icon element not found');
        return;
      }
      
      if (theme === 'dark') {
        // Sun icon for light mode
        themeIcon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
      } else {
        // Moon icon for dark mode
        themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
      }
    }

    // Initialize theme on page load
    initTheme();

    // Customer management functions
    async function loadCustomers() {
      const user = auth.currentUser;
      if (!user) return;
      const tbody = document.getElementById('customerTableBody');
      tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading customers...</td></tr>';
      
      // Remove any previous listener to avoid duplicates
      if (window._customerListener) {
        window._customerListener.off();
      }
      const ref = rtdb.ref(`customers/${user.uid}`);
      window._customerListener = ref;
      ref.on('value', snapshot => {
        const customers = snapshot.val();
        tbody.innerHTML = '';
        
        if (customers) {
          Object.keys(customers).forEach(customerId => {
            const customer = customers[customerId];
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${customer.id || customerId}</td>
              <td>${customer.name || 'N/A'}</td>
              <td>${customer.phone || 'N/A'}</td>
              <td>${customer.email || 'N/A'}</td>
              <td><span class="status-${customer.status || 'active'}">${(customer.status || 'active').charAt(0).toUpperCase() + (customer.status || 'active').slice(1)}</span></td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-edit btn-small" onclick="editCustomer('${customerId}')">Edit</button>
                  <button class="btn btn-delete btn-small" onclick="deleteCustomer('${customerId}')">Delete</button>
                </div>
              </td>
            `;
            tbody.appendChild(row);
          });
          
          // Update stats after loading customers
          updateCustomerStats(customers);
        } else {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #64748b;">No customers found</td></tr>';
          updateCustomerStats({});
        }
      }, error => {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #e74c3c;">Error loading customers</td></tr>';
        console.error('Error loading customers:', error);
      });
    }

    function updateCustomerStats(customers) {
      const totalCustomers = Object.keys(customers).length;
      let activeCustomers = 0;
      let inactiveCustomers = 0;
      let newThisMonth = 0;
      
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      
      Object.values(customers).forEach(customer => {
        if (customer.status === 'active') {
          activeCustomers++;
        } else if (customer.status === 'inactive') {
          inactiveCustomers++;
        }
        
        // Check if customer was created this month
        if (customer.createdAt) {
          const createdDate = new Date(customer.createdAt);
          if (createdDate.getMonth() === currentMonth && createdDate.getFullYear() === currentYear) {
            newThisMonth++;
          }
        }
      });
      
      // Update stats display
      document.getElementById('customerStatTotal').textContent = totalCustomers;
      document.getElementById('customerStatActive').textContent = activeCustomers;
      document.getElementById('customerStatInactive').textContent = inactiveCustomers;
      document.getElementById('customerStatNew').textContent = newThisMonth;
    }

    // Edit customer function
    function editCustomer(customerId) {
      const user = auth.currentUser;
      if (!user) return;

      // Get customer data and show edit modal
      rtdb.ref(`customers/${user.uid}/${customerId}`).once('value')
        .then(snapshot => {
          const customer = snapshot.val();
          if (customer) {
            showEditCustomerModal(customer, customerId);
          }
        })
        .catch(error => {
          showStatus('Error loading customer: ' + error.message, 'error');
        });
    }

    function showEditCustomerModal(customer, customerId) {
      const modal = document.createElement('div');
      modal.id = 'editCustomerModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        overflow-y: auto;
        padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="
        background: var(--card-bg);
          border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          width: 90%;
          max-width: 800px;
          max-height: 90vh;
          overflow-y: auto;
          padding: 32px;
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary);">Edit Customer</h2>
            <button onclick="closeEditCustomerModal()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: var(--text-secondary);
              padding: 8px;
            ">&times;</button>
          </div>
          
          <form id="editCustomerForm">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
              <!-- Basic Information -->
              <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color);">
                <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Basic Information</h3>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Customer ID:</label>
                  <input type="text" id="editCustomerId" value="${customer.id || ''}" readonly style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
          </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Customer Name (EN):</label>
                  <input type="text" id="editCustomerName" value="${customer.name || ''}" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
          </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Customer Name (KH):</label>
                  <input type="text" id="editCustomerNameKh" value="${customer.nameKh || ''}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
          </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">VAT TIN:</label>
                  <input type="text" id="editVattin" value="${customer.vattin || ''}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
          </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Contact Name:</label>
                  <input type="text" id="editContactName" value="${customer.contactName || ''}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Status:</label>
                  <select id="editContactStatus" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                    <option value="active" ${customer.status === 'active' ? 'selected' : ''}>Active</option>
                    <option value="inactive" ${customer.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                  </select>
                </div>
              </div>
              
              <!-- Contact Information -->
              <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color);">
                <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Contact Information</h3>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Phone:</label>
                  <input type="tel" id="editPhone" value="${customer.phone || ''}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Email:</label>
                  <input type="email" id="editEmail" value="${customer.email || ''}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Address:</label>
                  <textarea id="editAddress" rows="3" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); resize: vertical;">${customer.address || ''}</textarea>
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Address (KH):</label>
                  <textarea id="editAddressKh" rows="3" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); resize: vertical;">${customer.addressKh || ''}</textarea>
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Website:</label>
                  <input type="url" id="editWebsite" value="${customer.website || ''}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
              </div>
            </div>
            
            <!-- Financial Information -->
            <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Financial Information</h3>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                <div>
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Credit Limit:</label>
                  <input type="number" id="editCreditLimit" step="0.01" value="${customer.creditLimit || 0}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Credit Days:</label>
                  <input type="number" id="editCreditDay" value="${customer.creditDay || 0}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Promo Rate (%):</label>
                  <input type="number" id="editPromoRate" step="0.01" value="${customer.promoRate || 0}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
              </div>
            </div>
            
            <!-- Notes -->
            <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Notes</h3>
              <textarea id="editNotes" rows="4" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); resize: vertical;">${customer.notes || ''}</textarea>
            </div>
            
            <!-- Actions -->
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
              <button type="button" onclick="closeEditCustomerModal()" style="
                padding: 12px 24px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                background: var(--card-bg);
                color: var(--text-primary);
                cursor: pointer;
                font-weight: 600;
              ">Cancel</button>
              <button type="submit" style="
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                background: var(--active-color);
                color: white;
                cursor: pointer;
                font-weight: 600;
              ">Update Customer</button>
          </div>
        </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Handle form submission
      document.getElementById('editCustomerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updateCustomerFromModal(customerId);
      });
    }

    function closeEditCustomerModal() {
      const modal = document.getElementById('editCustomerModal');
      if (modal) {
        modal.remove();
      }
    }

    async function updateCustomerFromModal(customerId) {
      const user = auth.currentUser;
      if (!user) {
        showStatus('User not authenticated', 'error');
        return;
      }

      // Get the update button and show loading state
      const updateButton = document.querySelector('#editCustomerForm button[type="submit"]');
      const originalText = updateButton.textContent;
      updateButton.textContent = 'Updating...';
      updateButton.disabled = true;

      try {
        // Validate required fields
        const customerName = document.getElementById('editCustomerName').value.trim();
        if (!customerName) {
          showStatus('Customer name is required!', 'error');
          updateButton.textContent = originalText;
          updateButton.disabled = false;
          return;
        }

        const customerData = {
          id: document.getElementById('editCustomerId').value,
          name: customerName,
          nameKh: document.getElementById('editCustomerNameKh').value.trim(),
          vattin: document.getElementById('editVattin').value.trim(),
          contactName: document.getElementById('editContactName').value.trim(),
          status: document.getElementById('editContactStatus').value,
          phone: document.getElementById('editPhone').value.trim(),
          email: document.getElementById('editEmail').value.trim(),
          address: document.getElementById('editAddress').value.trim(),
          addressKh: document.getElementById('editAddressKh').value.trim(),
          website: document.getElementById('editWebsite').value.trim(),
          creditLimit: parseFloat(document.getElementById('editCreditLimit').value) || 0,
          creditDay: parseFloat(document.getElementById('editCreditDay').value) || 0,
          promoRate: parseFloat(document.getElementById('editPromoRate').value) || 0,
          notes: document.getElementById('editNotes').value.trim(),
          updatedAt: new Date().toISOString()
        };

        await rtdb.ref(`customers/${user.uid}/${customerId}`).update(customerData);
        console.log('Customer updated successfully');
        showStatus('Customer updated successfully!', 'success');
        closeEditCustomerModal();
        // The realtime listener will automatically update the table
      } catch (error) {
        console.error('Error updating customer:', error);
        showStatus('Error updating customer: ' + error.message, 'error');
      } finally {
        // Reset button state
        updateButton.textContent = originalText;
        updateButton.disabled = false;
      }
    }

    // Delete customer
    async function deleteCustomer(customerId) {
      if (!confirm('Are you sure you want to delete this customer?')) return;

      const user = auth.currentUser;
      if (!user) {
        showStatus('User not authenticated', 'error');
        return;
      }

      try {
        console.log('Deleting customer:', customerId);
        await rtdb.ref(`customers/${user.uid}/${customerId}`).remove();
        console.log('Customer deleted successfully');
        showStatus('Customer deleted successfully', 'success');
        // The realtime listener will automatically update the table
      } catch (error) {
        console.error('Error deleting customer:', error);
        showStatus('Error deleting customer: ' + error.message, 'error');
      }
    }

    // New customer (placeholder function)
    function newCustomer() {
              // Show the add customer modal
        showAddCustomerModal();
    }

    // Show status message
    function showStatus(message, type) {
      const statusDiv = document.getElementById('customerStatusMessage');
      statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 5000);
    }

    // Add Customer Modal Functions
    function showAddCustomerModal() {
      const modal = document.createElement('div');
      modal.id = 'addCustomerModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        overflow-y: auto;
        padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="
          background: var(--card-bg);
          border-radius: 16px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          width: 90%;
          max-width: 800px;
          max-height: 90vh;
          overflow-y: auto;
          padding: 32px;
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary);">Add New Customer</h2>
            <button onclick="closeAddCustomerModal()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
              color: var(--text-secondary);
              padding: 8px;
            ">&times;</button>
          </div>
          
          <form id="customerForm">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
              <!-- Basic Information -->
              <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color);">
                <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Basic Information</h3>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Customer ID:</label>
                  <input type="text" id="customerId" placeholder="Enter customer ID" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Customer Name (EN):</label>
                  <input type="text" id="customerName" placeholder="Enter customer name" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Customer Name (KH):</label>
                  <input type="text" id="customerNameKh" placeholder="Enter customer name in Khmer" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">VAT TIN:</label>
                  <input type="text" id="vattin" placeholder="Enter VAT TIN" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Contact Name:</label>
                  <input type="text" id="contactName" placeholder="Enter contact person name" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Status:</label>
                  <select id="contactStatus" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                    <option value="">Select status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                  </select>
                </div>
              </div>
              
              <!-- Contact Information -->
              <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color);">
                <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Contact Information</h3>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Phone:</label>
                  <input type="tel" id="phone" placeholder="Enter phone number" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Email:</label>
                  <input type="email" id="email" placeholder="Enter email address" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Address:</label>
                  <textarea id="address" rows="3" placeholder="Enter address" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Address (KH):</label>
                  <textarea id="addressKh" rows="3" placeholder="Enter address in Khmer" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Website:</label>
                  <input type="url" id="website" placeholder="Enter website URL" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
              </div>
            </div>
            
            <!-- Financial Information -->
            <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Financial Information</h3>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                <div>
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Credit Limit:</label>
                  <input type="number" id="creditLimit" step="0.01" placeholder="0.00" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Credit Days:</label>
                  <input type="number" id="creditDay" placeholder="0" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Promo Rate (%):</label>
                  <input type="number" id="promoRate" step="0.01" placeholder="0.00" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                </div>
              </div>
            </div>
            
            <!-- Notes -->
            <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Notes</h3>
              <textarea id="notes" rows="4" placeholder="Enter any additional notes about the customer" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
            </div>
            
            <!-- Image Upload Section -->
            <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Customer Images</h3>
              
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Upload Images:</label>
                <input type="file" id="customerImages" multiple accept="image/*" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                <small style="color: var(--text-muted); font-size: 12px;">You can select multiple images. Supported formats: JPG, PNG, GIF</small>
              </div>
              
              <div id="imagePreviewContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-top: 16px;">
                <!-- Image previews will be displayed here -->
              </div>
            </div>
            
            <!-- Actions -->
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
              <button type="button" onclick="closeAddCustomerModal()" style="
                padding: 12px 24px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                background: var(--card-bg);
                color: var(--text-primary);
                cursor: pointer;
                font-weight: 600;
              ">Cancel</button>
              <button type="submit" style="
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                background: var(--active-color);
                color: white;
                cursor: pointer;
                font-weight: 600;
              ">Save Customer</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Reset uploaded images
      resetUploadedImages();
      
      // Handle form submission
      document.getElementById('customerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveCustomerFromModal();
      });

      // Initialize image upload handler
      handleImageUpload();
    }

    function closeAddCustomerModal() {
      const modal = document.getElementById('addCustomerModal');
      if (modal) {
        modal.remove();
      }
      // Reset uploaded images when modal is closed
      uploadedImages = [];
    }

    function resetUploadedImages() {
      uploadedImages = [];
      const previewContainer = document.getElementById('imagePreviewContainer');
      if (previewContainer) {
        previewContainer.innerHTML = '';
      }
    }

    function generateCustomerId() {
      return 'CUST' + Date.now();
    }

    async function saveCustomerFromModal() {
      const user = auth.currentUser;
      if (!user) {
        showStatus('User not authenticated', 'error');
        return;
      }

      // Get the save button and show loading state
      const saveButton = document.querySelector('#customerForm button[type="submit"]');
      const originalText = saveButton.textContent;
      saveButton.textContent = 'Saving...';
      saveButton.disabled = true;

      try {
        // Validate required fields
        const customerName = document.getElementById('customerName').value.trim();
        if (!customerName) {
          showStatus('Customer name is required!', 'error');
          saveButton.textContent = originalText;
          saveButton.disabled = false;
        return;
      }

        // Upload images first
        const imageUrls = await uploadImagesToStorage();

        const customerData = {
          id: document.getElementById('customerId').value || generateCustomerId(),
          name: customerName,
          nameKh: document.getElementById('customerNameKh').value.trim(),
          vattin: document.getElementById('vattin').value.trim(),
          contactName: document.getElementById('contactName').value.trim(),
          status: document.getElementById('contactStatus').value,
          phone: document.getElementById('phone').value.trim(),
          email: document.getElementById('email').value.trim(),
          address: document.getElementById('address').value.trim(),
          addressKh: document.getElementById('addressKh').value.trim(),
          website: document.getElementById('website').value.trim(),
          creditLimit: parseFloat(document.getElementById('creditLimit').value) || 0,
          creditDay: parseFloat(document.getElementById('creditDay').value) || 0,
          promoRate: parseFloat(document.getElementById('promoRate').value) || 0,
          notes: document.getElementById('notes').value.trim(),
          images: imageUrls,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };

        console.log('Saving customer data:', customerData);
        const newCustomerRef = await rtdb.ref(`customers/${user.uid}`).push(customerData);
        console.log('Customer saved successfully with key:', newCustomerRef.key);
        showStatus('Customer created successfully!', 'success');
        closeAddCustomerModal();
        // The realtime listener will automatically update the table
      } catch (error) {
        console.error('Error saving customer:', error);
        showStatus('Error saving customer: ' + error.message, 'error');
      } finally {
        // Reset button state
        saveButton.textContent = originalText;
        saveButton.disabled = false;
      }
    }

    // Auth state check
    auth.onAuthStateChanged(function(user) {
      if (!user) {
                    window.location.href = 'login.html';
      } else {
        // Load customers after auth
                  loadCustomers();
      }
    });

    // Cleanup function to remove listeners
    function cleanupCustomerListeners() {
      if (window._customerListener) {
        window._customerListener.off();
        window._customerListener = null;
      }
    }

    // Test database connection
    async function testDatabaseConnection() {
      const user = auth.currentUser;
        if (!user) {
        showStatus('User not authenticated', 'error');
          return;
        }

      try {
        console.log('Testing database connection...');
        const testRef = rtdb.ref(`customers/${user.uid}/_test`);
        await testRef.set({ test: true, timestamp: Date.now() });
        await testRef.remove();
        console.log('Database connection successful');
        showStatus('Database connection successful', 'success');
      } catch (error) {
        console.error('Database connection failed:', error);
        showStatus('Database connection failed: ' + error.message, 'error');
      }
    }

    // Initialize on page load
    window.addEventListener('load', function() {
      // Theme is already initialized above
      
      // Test database connection on load
      setTimeout(() => {
        testDatabaseConnection();
      }, 1000);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', cleanupCustomerListeners);

    // Image upload handling
    function handleImageUpload() {
      const fileInput = document.getElementById('customerImages');
      const previewContainer = document.getElementById('imagePreviewContainer');
      
      if (fileInput && previewContainer) {
        fileInput.addEventListener('change', function(e) {
          const files = Array.from(e.target.files);
          previewContainer.innerHTML = '';
          uploadedImages = [];
          
          files.forEach((file, index) => {
            if (file.type.startsWith('image/')) {
              // Create preview
              const reader = new FileReader();
              reader.onload = function(e) {
                const previewDiv = document.createElement('div');
                previewDiv.style.cssText = `
                  position: relative;
                  border-radius: 8px;
                  overflow: hidden;
                  border: 1px solid var(--border-color);
                  background: var(--card-bg);
                `;
                
                          previewDiv.innerHTML = 
            '<img src="' + e.target.result + '" style="width: 100%; height: 120px; object-fit: cover;">' +
            '<button onclick="removeImage(' + index + ')" style="' +
              'position: absolute;' +
              'top: 4px;' +
              'right: 4px;' +
              'background: var(--error-color);' +
              'color: white;' +
              'border: none;' +
              'border-radius: 50%;' +
              'width: 24px;' +
              'height: 24px;' +
              'cursor: pointer;' +
              'font-size: 12px;' +
              'display: flex;' +
              'align-items: center;' +
              'justify-content: center;' +
            '">×</button>' +
            '<div style="padding: 8px; font-size: 11px; color: var(--text-secondary); text-align: center;">' +
              (file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name) +
            '</div>';
                
                previewContainer.appendChild(previewDiv);
                uploadedImages.push(file);
              };
              reader.readAsDataURL(file);
            }
          });
        });
      }
    }

    function removeImage(index) {
      uploadedImages.splice(index, 1);
      updateImagePreviews();
    }

    function updateImagePreviews() {
      const previewContainer = document.getElementById('imagePreviewContainer');
      if (previewContainer) {
        previewContainer.innerHTML = '';
        uploadedImages.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const previewDiv = document.createElement('div');
            previewDiv.style.cssText = `
              position: relative;
              border-radius: 8px;
              overflow: hidden;
              border: 1px solid var(--border-color);
              background: var(--card-bg);
            `;
            
            previewDiv.innerHTML = 
              '<img src="' + e.target.result + '" style="width: 100%; height: 120px; object-fit: cover;">' +
              '<button onclick="removeImage(' + index + ')" style="' +
                'position: absolute;' +
                'top: 4px;' +
                'right: 4px;' +
                'background: var(--error-color);' +
                'color: white;' +
                'border: none;' +
                'border-radius: 50%;' +
                'width: 24px;' +
                'height: 24px;' +
                'cursor: pointer;' +
                'font-size: 12px;' +
                'display: flex;' +
                'align-items: center;' +
                'justify-content: center;' +
              '">×</button>' +
              '<div style="padding: 8px; font-size: 11px; color: var(--text-secondary); text-align: center;">' +
                (file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name) +
              '</div>';
            
            previewContainer.appendChild(previewDiv);
          };
          reader.readAsDataURL(file);
        });
      }
    }

    async function uploadImagesToStorage() {
      const user = auth.currentUser;
      if (!user) {
        console.log('No user authenticated for image upload');
        return [];
      }
      
      if (!uploadedImages || uploadedImages.length === 0) {
        console.log('No images to upload');
        return [];
      }
      
      const imageUrls = [];
      
      for (let i = 0; i < uploadedImages.length; i++) {
        const file = uploadedImages[i];
        if (!file) continue;
        
        const timestamp = Date.now();
        const fileName = `customer_${user.uid}_${timestamp}_${i}_${file.name}`;
        const storageRef = storage.ref(`customer_images/${user.uid}/${fileName}`);
        
        try {
          console.log(`Uploading image: ${file.name}`);
          const snapshot = await storageRef.put(file);
          const downloadURL = await snapshot.ref.getDownloadURL();
          imageUrls.push({
            url: downloadURL,
            name: file.name,
            path: `customer_images/${user.uid}/${fileName}`,
            size: file.size,
            type: file.type
          });
          console.log(`Successfully uploaded: ${file.name}`);
        } catch (error) {
          console.error('Error uploading image:', error);
          showStatus(`Error uploading ${file.name}: ${error.message}`, 'error');
        }
      }
      
      return imageUrls;
    }
  </script>
</body>
</html> 