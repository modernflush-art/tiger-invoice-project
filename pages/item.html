<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Items - Tiger Invoice</title>
    <link rel="stylesheet" href="theme.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Segoe+UI:400,600&display=swap">
  <style>
    :root {
      --bg-primary: #fafbfc;
      --bg-secondary: #ffffff;
      --bg-sidebar: #ffffff;
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --border-color: #e2e8f0;
      --border-light: #f7fafc;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --hover-bg: #f7fafc;
      --active-bg: #ebf8ff;
      --active-color: #f97316;
      --success-color: #38a169;
      --warning-color: #d69e2e;
      --error-color: #e53e3e;
      --card-bg: #ffffff;
      --input-bg: #ffffff;
      --input-border: #e2e8f0;
      --gradient-primary: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
    }

    [data-theme="dark"] {
      --bg-primary: #0f1419;
      --bg-secondary: #1a202c;
      --bg-sidebar: #1a202c;
      --text-primary: #f7fafc;
      --text-secondary: #cbd5e0;
      --text-muted: #718096;
      --border-color: #2d3748;
      --border-light: #4a5568;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
      --hover-bg: #2d3748;
      --active-bg: #2c5282;
      --active-color: #fb923c;
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --error-color: #f56565;
      --card-bg: #1a202c;
      --input-bg: #2d3748;
      --input-border: #4a5568;
      --gradient-primary: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
    }

    body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    .container {
            display: flex;
            min-height: 100vh;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 32px;
            background: var(--bg-primary);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      margin-right: 16px;
    }

    .back-btn:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .back-btn svg {
      width: 16px;
      height: 16px;
      transition: transform 0.2s ease;
    }

    .back-btn:hover svg {
      transform: translateX(-2px);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }

    .header-left {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }

    .header-left h1 {
      font-size: 28px;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
            margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #3b82f6;
            border-radius: 12px;
            cursor: pointer;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 3px;
            right: 3px;
            transition: all 0.3s;
        }

        .dropdown {
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      font-family: inherit;
      letter-spacing: 0.3px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
    }

    .btn-secondary:hover {
      background: var(--hover-bg);
    }

    .theme-toggle {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
      padding: 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
          position: relative;
          overflow: hidden;
        }

        .theme-toggle::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
          transition: left 0.5s;
    }

    .theme-toggle:hover {
      background: var(--hover-bg);
      border-color: var(--active-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

        .theme-toggle:hover::before {
          left: 100%;
        }

        .theme-toggle svg {
          width: 20px;
          height: 20px;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theme-toggle:hover svg {
          transform: rotate(180deg);
        }

        /* Stats Cards */
    .stats-grid {
      display: grid;
            grid-template-columns: repeat(4, 1fr);
      gap: 20px;
            margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card h3 {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 4px;
      color: var(--text-primary);
      line-height: 1.2;
    }

        .stat-currency {
            font-size: 14px;
            color: #94a3b8;
        }

        .stat-meta {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
        }

        /* Table Section */
        .table-section {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            width: 300px;
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--active-color);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }

    .item-table {
      width: 100%;
      border-collapse: collapse;
    }

    .item-table th {
      background: var(--bg-secondary);
            color: var(--text-secondary);
      font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border-color);
            padding: 16px;
    }

    .item-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
      color: var(--text-primary);
    }

    .item-table tbody tr:hover {
      background: var(--hover-bg);
    }

    .status-instock {
      background: var(--success-color);
      color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
    }

    .status-lowstock {
      background: var(--warning-color);
      color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
    }

    .status-outofstock {
      background: var(--error-color);
      color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
    }

        .item-info {
      display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
      font-size: 12px;
            font-weight: 600;
            color: white;
            box-shadow: var(--shadow);
        }

        .amount {
            font-weight: 600;
        }

        .actions {
            cursor: pointer;
            padding: 4px;
      border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .actions:hover {
            background: var(--hover-bg);
        }

        .table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .pagination {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .show-more {
            color: var(--active-color);
      cursor: pointer;
            font-weight: 600;
        }

        .show-more:hover {
            text-decoration: underline;
        }

        .form-control, select.form-control, textarea.form-control {
            background: var(--input-bg);
            color: #fff;
        }
        .form-control::placeholder {
            color: #cbd5e1;
            opacity: 1;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
    }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-weight: 600;
        font-size: 14px;
      }
      
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
        }

        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .status-success {
            background: var(--success-color);
            color: white;
        }

        .status-error {
            background: var(--error-color);
            color: white;
    }
  </style>
</head>
<body>
      <div class="container">
        <!-- Main Content -->
        <div class="main-content">
      <div class="header">
        <div class="header-left">
          <div style="display: flex; align-items: center; gap: 16px;">
            <button class="back-btn" onclick="window.location.href='index.html'">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              <span>Back</span>
            </button>
            <h1>Items</h1>
          </div>
        </div>
        <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Toggle theme">
                  <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>
          <button class="btn-primary" onclick="showAddItemForm()">Add Item</button>
        </div>
      </div>

    <!-- Status Messages -->
    <div id="itemStatusMessage"></div>

            <!-- Stats Grid -->
            <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <h3>Total Items</h3>
          <div class="stat-value" id="itemStatTotal">0</div>
        </div>
        <div class="stat-card">
          <h3>In Stock</h3>
          <div class="stat-value" id="itemStatInStock">0</div>
        </div>
        <div class="stat-card">
          <h3>Low Stock</h3>
          <div class="stat-value" id="itemStatLowStock">0</div>
        </div>
        <div class="stat-card">
          <h3>Out of Stock</h3>
          <div class="stat-value" id="itemStatOutOfStock">0</div>
        </div>
            </div>

            <!-- Table Section -->
            <div class="table-section">
                <div class="table-header">
                    <div class="search-box">
                        <input type="text" placeholder="Search items">
      </div>
    </div>

      <table class="item-table">
        <thead>
          <tr>
                            <th></th>
                            <th>Item Code ▼</th>
                            <th>Item Name ▼</th>
                            <th>Category ▼</th>
                            <th>Unit ▼</th>
                            <th>Stock ▼</th>
                            <th>Price ▼</th>
                            <th></th>
          </tr>
        </thead>
        <tbody id="itemTableBody">
                        <!-- Item rows will be populated by JavaScript -->
        </tbody>
      </table>

                <div class="table-footer">
                    <div class="pagination">
                        <span>Show</span>
                        <select>
                            <option>10</option>
                            <option>25</option>
                            <option>50</option>
                        </select>
                        <span>of 0 Result</span>
                    </div>
                    <div class="show-more">Show More</div>
                </div>
            </div>
    </div>
  </div>

    <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <!-- Firebase Analytics SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    <!-- Firebase Realtime Database SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <!-- Firebase Storage SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // Theme management
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeUI(savedTheme);
    }

            function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeUI(newTheme);
      }
      
      // Make toggleTheme globally accessible
      window.toggleTheme = toggleTheme;

      function updateThemeUI(theme) {
        const themeIcon = document.getElementById('themeIcon');
        
        if (theme === 'dark') {
          // Sun icon for light mode
          themeIcon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
        } else {
          // Moon icon for dark mode
          themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
        }
      }

      // Initialize theme on page load
      initTheme();

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyC2vUhY8zpsS60dAaxIVXqszC5180sGobc",
        authDomain: "tigerpower-86ca1.firebaseapp.com",
        projectId: "tigerpower-86ca1",
        databaseURL: "https://tigerpower-86ca1-default-rtdb.asia-southeast1.firebasedatabase.app",
        messagingSenderId: "493107786425",
        appId: "1:493107786425:web:39a1448aeba5b9e619e168"
      };

      // Initialize Firebase with better error handling
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const rtdb = firebase.database();
      const storage = firebase.storage();

      // Test database connection
      async function testDatabaseConnection() {
      const user = auth.currentUser;
      if (!user) {
          console.log('No user authenticated for database test');
        return;
      }
      
        try {
          console.log('Testing database connection...');
          const testRef = rtdb.ref(`items/${user.uid}/_test`);
          await testRef.set({ test: true, timestamp: Date.now() });
          await testRef.remove();
          console.log('Database connection successful');
        } catch (error) {
          console.error('Database connection failed:', error);
        }
      }

      // Initialize on page load
      window.addEventListener('load', function() {
        // Test database connection on load
        setTimeout(() => {
          testDatabaseConnection();
        }, 1000);
      });

      // User-specific data paths and security
      function getUserDataPath(path = '') {
        const user = auth.currentUser;
        if (!user) {
          console.error('No authenticated user');
          return null;
        }
        return `users/${user.uid}/${path}`;
      }

      // Make Firebase services available globally with user isolation
      window.firebase = {
        app: app,
        auth: auth,
        rtdb: rtdb,
        storage: storage, // Add storage to window.firebase
        // Auth providers
        GoogleAuthProvider: firebase.auth.GoogleAuthProvider,
        // User-specific data helpers
        getUserDataPath: getUserDataPath
      };

      console.log('Firebase initialized successfully with RTDB only - Authentication and Realtime Database');

      // Auth state check
      auth.onAuthStateChanged(function(user) {
        if (!user) {
          window.location.href = 'login.html';
        } else {
          console.log('User logged in:', user.email);
          fetchAndRenderItems();
          updateStatsFromItems();
        }
      });

      // Logout function
      function logout() {
        auth.signOut().then(() => {
          window.location.href = 'login.html';
        });
      }

      // Test Firebase connection
      function testFirebaseConnection() {
        const user = auth.currentUser;
        if (!user) {
          console.log('No user logged in');
          return false;
        }
        
        const testPath = `users/${user.uid}/test`;
        rtdb.ref(testPath).set({
          test: true,
          timestamp: new Date().toISOString()
        })
        .then(() => {
          console.log('Firebase connection test successful');
          rtdb.ref(testPath).remove(); // Clean up test data
        })
        .catch(err => {
          console.error('Firebase connection test failed:', err);
        });
      }
      
      // Test connection on page load
      setTimeout(testFirebaseConnection, 2000);

      async function fetchAndRenderItems() {
        const user = auth.currentUser;
        if (!user) {
          console.log('No user authenticated for fetching items');
        return;
      }
      
        const tbody = document.getElementById('itemTableBody');
        tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading items...</td></tr>';
      
      try {
          console.log('Fetching items from database...');
          const snapshot = await rtdb.ref(`items/${user.uid}`).once('value');
        const items = snapshot.val();
          
        tbody.innerHTML = '';
        
          if (items) {
          Object.keys(items).forEach(itemId => {
            const item = items[itemId];
              const row = document.createElement('tr');
              
              // Determine stock status
              let stockStatus = 'instock';
              if (item.stock <= 0) {
                stockStatus = 'outofstock';
              } else if (item.stock <= (item.minStock || 0)) {
                stockStatus = 'lowstock';
              }
              
            row.innerHTML = `
              <td>${item.code || itemId}</td>
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="item-avatar">${(item.name || 'N/A').charAt(0).toUpperCase()}</div>
                    <div>
                      <div style="font-weight: 600; color: var(--text-primary);">${item.name || 'N/A'}</div>
                      <div style="font-size: 12px; color: var(--text-secondary);">${item.category || 'No Category'}</div>
                    </div>
                  </div>
              </td>
                <td>${item.unit || 'pcs'}</td>
                <td>${item.stock || 0}</td>
                <td>$${parseFloat(item.sellingPrice || 0).toFixed(2)}</td>
                <td><span class="status-${stockStatus}">${stockStatus.charAt(0).toUpperCase() + stockStatus.slice(1)}</span></td>
                <td>
                  <div class="actions">
                    <button class="btn btn-edit btn-small" onclick="editItem('${itemId}')">Edit</button>
                    <button class="btn btn-delete btn-small" onclick="deleteItem('${itemId}')">Delete</button>
                </div>
              </td>
            `;
              
            tbody.appendChild(row);
          });
            
            console.log(`Loaded ${Object.keys(items).length} items successfully`);
        } else {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No items found</td></tr>';
            console.log('No items found in database');
          }
        } catch (error) {
          console.error('Error fetching items:', error);
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #e74c3c;">Error loading items</td></tr>';
          showStatusMessage('Error loading items: ' + error.message, 'error');
        }
      }

      function getStockStatusClass(stock) {
        const stockNum = parseInt(stock) || 0;
        if (stockNum > 10) return 'status-instock';
        if (stockNum > 0) return 'status-lowstock';
        return 'status-outofstock';
      }

      async function updateStatsFromItems() {
        const totalElem = document.getElementById('itemStatTotal');
        const inStockElem = document.getElementById('itemStatInStock');
        const lowStockElem = document.getElementById('itemStatLowStock');
        const outOfStockElem = document.getElementById('itemStatOutOfStock');

        let total = 0;
        let inStock = 0;
        let lowStock = 0;
        let outOfStock = 0;

        const user = auth.currentUser;
        if (!user) {
          totalElem.textContent = '0';
          inStockElem.textContent = '0';
          lowStockElem.textContent = '0';
          outOfStockElem.textContent = '0';
          return;
        }

        try {
          const snapshot = await rtdb.ref('items/' + user.uid).once('value');
          const items = snapshot.val();
          if (items) {
            Object.values(items).forEach(item => {
              total++;
              const stock = parseInt(item.stock) || 0;
              if (stock > 10) {
                inStock++;
              } else if (stock > 0) {
                lowStock++;
              } else {
                outOfStock++;
              }
            });
          }
        } catch (e) {}

        totalElem.textContent = total;
        inStockElem.textContent = inStock;
        lowStockElem.textContent = lowStock;
        outOfStockElem.textContent = outOfStock;
      }

      function toggleStats() {
        const statsGrid = document.getElementById('statsGrid');
        const isVisible = statsGrid.style.display !== 'none';
        statsGrid.style.display = isVisible ? 'none' : 'grid';
        
        // Update toggle switch appearance
        const toggle = document.querySelector('.toggle-switch');
        if (isVisible) {
          toggle.style.background = '#e2e8f0';
          toggle.style.setProperty('--after-right', '23px');
        } else {
          toggle.style.background = '#3b82f6';
          toggle.style.setProperty('--after-right', '3px');
        }
    }

    function showAddItemForm() {
      const modal = document.createElement('div');
        modal.id = 'addItemModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
          overflow-y: auto;
          padding: 20px;
      `;
      
        modal.innerHTML = `
          <div style="
        background: var(--card-bg);
            border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary);">Add New Item</h2>
              <button onclick="closeItemModal()" style="
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: var(--text-secondary);
                padding: 8px;
              ">&times;</button>
            </div>
            
        <form id="itemForm">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <!-- Basic Information -->
                <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color);">
                  <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Basic Information</h3>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Item Code:</label>
                    <input type="text" id="itemCode" placeholder="Enter item code" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
          </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Item Name *:</label>
                    <input type="text" id="itemName" placeholder="Enter item name" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
          </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Item Name (KH):</label>
                    <input type="text" id="itemNameKh" placeholder="Enter item name in Khmer" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Category:</label>
                    <select id="itemCategory" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                      <option value="">Select Category</option>
                      <option value="electronics">Electronics</option>
                      <option value="clothing">Clothing</option>
                      <option value="food">Food & Beverages</option>
                      <option value="automotive">Automotive</option>
                      <option value="construction">Construction</option>
                      <option value="office">Office Supplies</option>
                      <option value="healthcare">Healthcare</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Brand:</label>
                    <input type="text" id="itemBrand" placeholder="Enter brand name" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Model:</label>
                    <input type="text" id="itemModel" placeholder="Enter model number" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                </div>
                
                <!-- Pricing & Stock -->
                <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color);">
                  <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Pricing & Stock</h3>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Unit:</label>
                    <select id="itemUnit" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
              <option value="pcs">Pieces</option>
              <option value="kg">Kilograms</option>
                      <option value="g">Grams</option>
              <option value="m">Meters</option>
                      <option value="cm">Centimeters</option>
              <option value="l">Liters</option>
                      <option value="ml">Milliliters</option>
              <option value="box">Box</option>
              <option value="set">Set</option>
                      <option value="pair">Pair</option>
                      <option value="dozen">Dozen</option>
                      <option value="roll">Roll</option>
                      <option value="bottle">Bottle</option>
                      <option value="can">Can</option>
                      <option value="pack">Pack</option>
            </select>
          </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Purchase Price:</label>
                    <input type="number" id="purchasePrice" min="0" step="0.01" placeholder="0.00" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
          </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Selling Price:</label>
                    <input type="number" id="sellingPrice" min="0" step="0.01" placeholder="0.00" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
          </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Stock Quantity:</label>
                    <input type="number" id="itemStock" min="0" placeholder="0" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
          </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Minimum Stock:</label>
                    <input type="number" id="minStock" min="0" placeholder="0" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Tax Rate (%):</label>
                    <input type="number" id="taxRate" min="0" max="100" step="0.01" placeholder="10.00" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                </div>
              </div>
              
              <!-- Additional Information -->
              <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); margin-top: 24px;">
                <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Additional Information</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Supplier:</label>
                    <input type="text" id="supplier" placeholder="Enter supplier name" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">SKU:</label>
                    <input type="text" id="sku" placeholder="Enter SKU code" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Barcode:</label>
                    <input type="text" id="barcode" placeholder="Enter barcode" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Weight (kg):</label>
                    <input type="number" id="weight" min="0" step="0.01" placeholder="0.00" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                </div>
                
                <div style="margin-top: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Description:</label>
                  <textarea id="itemDescription" rows="4" placeholder="Enter item description" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
                </div>
              </div>
              
              <!-- Image Upload Section -->
              <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); margin-top: 24px;">
                <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Item Images</h3>
                
                <div style="margin-bottom: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Upload Images:</label>
                  <input type="file" id="itemImages" multiple accept="image/*" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  <small style="color: var(--text-muted); font-size: 12px;">You can select multiple images. Supported formats: JPG, PNG, GIF</small>
                </div>
                
                <div id="itemImagePreviewContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-top: 16px;">
                  <!-- Image previews will be displayed here -->
                </div>
              </div>
              
              <!-- Actions -->
              <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" onclick="closeItemModal()" style="
                  padding: 12px 24px;
                  border: 1px solid var(--border-color);
                  border-radius: 8px;
                  background: var(--card-bg);
                  color: var(--text-primary);
                  cursor: pointer;
                  font-weight: 600;
                ">Cancel</button>
                <button type="submit" style="
                  padding: 12px 24px;
                  border: none;
                  border-radius: 8px;
                  background: var(--active-color);
                  color: white;
                  cursor: pointer;
                  font-weight: 600;
                ">Save Item</button>
          </div>
        </form>
          </div>
      `;
      
      document.body.appendChild(modal);
      
      // Handle form submission
      document.getElementById('itemForm').addEventListener('submit', function(e) {
        e.preventDefault();
          saveItemFromModal();
      });

        // Initialize image upload handler
        handleItemImageUpload();
    }

    function closeItemModal() {
        const modal = document.getElementById('addItemModal');
      if (modal) {
        modal.remove();
      }
    }

      function generateItemCode() {
        return 'ITEM' + Date.now();
      }

      async function saveItemFromModal() {
      const user = auth.currentUser;
      if (!user) {
          showStatusMessage('User not authenticated', 'error');
        return;
      }

        // Get the save button and show loading state
        const saveButton = document.querySelector('#itemForm button[type="submit"]');
        const originalText = saveButton.textContent;
        saveButton.textContent = 'Saving...';
        saveButton.disabled = true;

        try {
          // Validate required fields
          const itemName = document.getElementById('itemName').value.trim();
          if (!itemName) {
            showStatusMessage('Item name is required!', 'error');
            saveButton.textContent = originalText;
            saveButton.disabled = false;
            return;
          }

          // Upload images first
          const imageUrls = await uploadItemImagesToStorage();

          const itemData = {
            code: document.getElementById('itemCode').value || generateItemCode(),
            name: itemName,
            nameKh: document.getElementById('itemNameKh').value.trim(),
            category: document.getElementById('itemCategory').value,
            brand: document.getElementById('itemBrand').value.trim(),
            model: document.getElementById('itemModel').value.trim(),
        unit: document.getElementById('itemUnit').value,
            purchasePrice: parseFloat(document.getElementById('purchasePrice').value) || 0,
            sellingPrice: parseFloat(document.getElementById('sellingPrice').value) || 0,
        stock: parseInt(document.getElementById('itemStock').value) || 0,
            minStock: parseInt(document.getElementById('minStock').value) || 0,
            taxRate: parseFloat(document.getElementById('taxRate').value) || 10,
            supplier: document.getElementById('supplier').value.trim(),
            sku: document.getElementById('sku').value.trim(),
            barcode: document.getElementById('barcode').value.trim(),
            weight: parseFloat(document.getElementById('weight').value) || 0,
        description: document.getElementById('itemDescription').value.trim(),
            images: imageUrls,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };

          const newItemRef = await rtdb.ref(`items/${user.uid}`).push(itemData);
          showStatusMessage('Item created successfully!', 'success');
          closeItemModal();
          fetchAndRenderItems();
        } catch (error) {
          showStatusMessage('Error saving item: ' + error.message, 'error');
        } finally {
          // Reset button state
          saveButton.textContent = originalText;
          saveButton.disabled = false;
        }
    }

    function editItem(itemId) {
      const user = auth.currentUser;
      if (!user) {
        alert('Please log in to edit items.');
        return;
      }

        rtdb.ref(`items/${user.uid}/${itemId}`).once('value')
        .then(snapshot => {
          const item = snapshot.val();
          if (item) {
              showEditItemModal(item, itemId);
            }
                })
                .catch(error => {
            showStatusMessage('Error loading item: ' + error.message, 'error');
          });
      }

      function showEditItemModal(item, itemId) {
        const modal = document.createElement('div');
        modal.id = 'editItemModal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          overflow-y: auto;
          padding: 20px;
        `;
        
        modal.innerHTML = `
          <div style="
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary);">Edit Item</h2>
              <button onclick="closeEditItemModal()" style="
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: var(--text-secondary);
                padding: 8px;
              ">&times;</button>
            </div>
            
            <form id="editItemForm">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <!-- Basic Information -->
                <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color);">
                  <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Basic Information</h3>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Item Code:</label>
                    <input type="text" id="editItemCode" value="${item.code || ''}" readonly style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Item Name *:</label>
                    <input type="text" id="editItemName" value="${item.name || ''}" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Item Name (KH):</label>
                    <input type="text" id="editItemNameKh" value="${item.nameKh || ''}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Category:</label>
                    <select id="editItemCategory" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                      <option value="">Select Category</option>
                      <option value="electronics" ${item.category === 'electronics' ? 'selected' : ''}>Electronics</option>
                      <option value="clothing" ${item.category === 'clothing' ? 'selected' : ''}>Clothing</option>
                      <option value="food" ${item.category === 'food' ? 'selected' : ''}>Food & Beverages</option>
                      <option value="automotive" ${item.category === 'automotive' ? 'selected' : ''}>Automotive</option>
                      <option value="construction" ${item.category === 'construction' ? 'selected' : ''}>Construction</option>
                      <option value="office" ${item.category === 'office' ? 'selected' : ''}>Office Supplies</option>
                      <option value="healthcare" ${item.category === 'healthcare' ? 'selected' : ''}>Healthcare</option>
                      <option value="other" ${item.category === 'other' ? 'selected' : ''}>Other</option>
                    </select>
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Brand:</label>
                    <input type="text" id="editItemBrand" value="${item.brand || ''}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Model:</label>
                    <input type="text" id="editItemModel" value="${item.model || ''}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                </div>
                
                <!-- Pricing & Stock -->
                <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color);">
                  <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Pricing & Stock</h3>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Unit:</label>
                    <select id="editItemUnit" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                      <option value="pcs" ${item.unit === 'pcs' ? 'selected' : ''}>Pieces</option>
                      <option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>Kilograms</option>
                      <option value="g" ${item.unit === 'g' ? 'selected' : ''}>Grams</option>
                      <option value="m" ${item.unit === 'm' ? 'selected' : ''}>Meters</option>
                      <option value="cm" ${item.unit === 'cm' ? 'selected' : ''}>Centimeters</option>
                      <option value="l" ${item.unit === 'l' ? 'selected' : ''}>Liters</option>
                      <option value="ml" ${item.unit === 'ml' ? 'selected' : ''}>Milliliters</option>
                      <option value="box" ${item.unit === 'box' ? 'selected' : ''}>Box</option>
                      <option value="set" ${item.unit === 'set' ? 'selected' : ''}>Set</option>
                      <option value="pair" ${item.unit === 'pair' ? 'selected' : ''}>Pair</option>
                      <option value="dozen" ${item.unit === 'dozen' ? 'selected' : ''}>Dozen</option>
                      <option value="roll" ${item.unit === 'roll' ? 'selected' : ''}>Roll</option>
                      <option value="bottle" ${item.unit === 'bottle' ? 'selected' : ''}>Bottle</option>
                      <option value="can" ${item.unit === 'can' ? 'selected' : ''}>Can</option>
                      <option value="pack" ${item.unit === 'pack' ? 'selected' : ''}>Pack</option>
                    </select>
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Purchase Price:</label>
                    <input type="number" id="editPurchasePrice" min="0" step="0.01" value="${item.purchasePrice || 0}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Selling Price:</label>
                    <input type="number" id="editSellingPrice" min="0" step="0.01" value="${item.sellingPrice || 0}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Stock Quantity:</label>
                    <input type="number" id="editItemStock" min="0" value="${item.stock || 0}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Minimum Stock:</label>
                    <input type="number" id="editMinStock" min="0" value="${item.minStock || 0}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Tax Rate (%):</label>
                    <input type="number" id="editTaxRate" min="0" max="100" step="0.01" value="${item.taxRate || 10}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                </div>
              </div>
              
              <!-- Additional Information -->
              <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); margin-top: 24px;">
                <h3 style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600;">Additional Information</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Supplier:</label>
                    <input type="text" id="editSupplier" value="${item.supplier || ''}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">SKU:</label>
                    <input type="text" id="editSku" value="${item.sku || ''}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Barcode:</label>
                    <input type="text" id="editBarcode" value="${item.barcode || ''}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Weight (kg):</label>
                    <input type="number" id="editWeight" min="0" step="0.01" value="${item.weight || 0}" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                  </div>
                </div>
                
                <div style="margin-top: 16px;">
                  <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Description:</label>
                  <textarea id="editItemDescription" rows="4" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); resize: vertical;">${item.description || ''}</textarea>
                </div>
              </div>
              
              <!-- Actions -->
              <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" onclick="closeEditItemModal()" style="
                  padding: 12px 24px;
                  border: 1px solid var(--border-color);
                  border-radius: 8px;
                  background: var(--card-bg);
                  color: var(--text-primary);
                  cursor: pointer;
                  font-weight: 600;
                ">Cancel</button>
                <button type="submit" style="
                  padding: 12px 24px;
                  border: none;
                  border-radius: 8px;
                  background: var(--active-color);
                  color: white;
                  cursor: pointer;
                  font-weight: 600;
                ">Update Item</button>
              </div>
            </form>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Handle form submission
        document.getElementById('editItemForm').addEventListener('submit', function(e) {
          e.preventDefault();
          updateItemFromModal(itemId);
        });
      }

      function closeEditItemModal() {
        const modal = document.getElementById('editItemModal');
        if (modal) {
          modal.remove();
        }
      }

      async function updateItemFromModal(itemId) {
        const user = auth.currentUser;
        if (!user) {
          showStatusMessage('User not authenticated', 'error');
          return;
        }

        // Get the update button and show loading state
        const updateButton = document.querySelector('#editItemForm button[type="submit"]');
        const originalText = updateButton.textContent;
        updateButton.textContent = 'Updating...';
        updateButton.disabled = true;

        try {
          // Validate required fields
          const itemName = document.getElementById('editItemName').value.trim();
          if (!itemName) {
            showStatusMessage('Item name is required!', 'error');
            updateButton.textContent = originalText;
            updateButton.disabled = false;
            return;
          }

          const itemData = {
            code: document.getElementById('editItemCode').value,
            name: itemName,
            nameKh: document.getElementById('editItemNameKh').value.trim(),
            category: document.getElementById('editItemCategory').value,
            brand: document.getElementById('editItemBrand').value.trim(),
            model: document.getElementById('editItemModel').value.trim(),
            unit: document.getElementById('editItemUnit').value,
            purchasePrice: parseFloat(document.getElementById('editPurchasePrice').value) || 0,
            sellingPrice: parseFloat(document.getElementById('editSellingPrice').value) || 0,
            stock: parseInt(document.getElementById('editItemStock').value) || 0,
            minStock: parseInt(document.getElementById('editMinStock').value) || 0,
            taxRate: parseFloat(document.getElementById('editTaxRate').value) || 10,
            supplier: document.getElementById('editSupplier').value.trim(),
            sku: document.getElementById('editSku').value.trim(),
            barcode: document.getElementById('editBarcode').value.trim(),
            weight: parseFloat(document.getElementById('editWeight').value) || 0,
            description: document.getElementById('editItemDescription').value.trim(),
            updatedAt: new Date().toISOString()
          };

          await rtdb.ref(`items/${user.uid}/${itemId}`).update(itemData);
          showStatusMessage('Item updated successfully!', 'success');
          closeEditItemModal();
          fetchAndRenderItems();
        } catch (error) {
          showStatusMessage('Error updating item: ' + error.message, 'error');
        } finally {
          // Reset button state
          updateButton.textContent = originalText;
          updateButton.disabled = false;
        }
      }

      function removeItemFromFirebase(itemId) {
        const user = auth.currentUser;
        if (!user) {
          alert('User not logged in.');
          return;
        }
        if (!confirm('Are you sure you want to remove this item?')) return;
        rtdb.ref('items/' + user.uid + '/' + itemId).remove()
          .then(() => {
            fetchAndRenderItems();
            updateStatsFromItems();
            showStatusMessage('Item removed successfully!', 'success');
          })
          .catch(error => {
            alert('Error removing item: ' + error.message);
            showStatusMessage('Error removing item: ' + error.message, 'error');
          });
    }

    function showStatusMessage(message, type) {
      const statusDiv = document.getElementById('itemStatusMessage');
      const bgColor = type === 'success' ? 'var(--success-color)' : 'var(--error-color)';
        statusDiv.innerHTML = `<div class="status-message status-${type}" style="background: ${bgColor}; color: white;">${message}</div>`;
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 5000);
    }

      // Debug function to manually load data
      function debugLoadData() {
        console.log('=== DEBUG: Loading Items Data ===');
        const user = auth.currentUser;
      if (!user) {
          console.log('No user logged in');
          return;
        }
        
        console.log('User:', user.uid);
        
        // Test loading items
        rtdb.ref(`items/${user.uid}`).once('value')
          .then((snapshot) => {
            const items = snapshot.val();
            console.log('Items in database:', items);
          })
          .catch(err => {
            console.error('Error loading items:', err);
          });
      }

      // Make debug function available globally
      window.debugLoadData = debugLoadData;

      // Function to check auth state without redirecting
      function checkAuthState() {
        const user = auth.currentUser;
        console.log('Auth state check - User:', user ? user.uid : 'No user');
        return user;
      }

      // Make auth check available globally
      window.checkAuthState = checkAuthState;

      // Image upload handling for items
      let uploadedItemImages = [];

      function handleItemImageUpload() {
        const fileInput = document.getElementById('itemImages');
        const previewContainer = document.getElementById('itemImagePreviewContainer');
        
        if (fileInput && previewContainer) {
          fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            previewContainer.innerHTML = '';
            uploadedItemImages = [];
            
            files.forEach((file, index) => {
              if (file.type.startsWith('image/')) {
                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                  const previewDiv = document.createElement('div');
                  previewDiv.style.cssText = 
                    'position: relative;' +
                    'border-radius: 8px;' +
                    'overflow: hidden;' +
                    'border: 1px solid var(--border-color);' +
                    'background: var(--card-bg);';
                  
                  previewDiv.innerHTML = 
                    '<img src="' + e.target.result + '" style="width: 100%; height: 120px; object-fit: cover;">' +
                    '<button onclick="removeItemImage(' + index + ')" style="' +
                      'position: absolute;' +
                      'top: 4px;' +
                      'right: 4px;' +
                      'background: var(--error-color);' +
                      'color: white;' +
                      'border: none;' +
                      'border-radius: 50%;' +
                      'width: 24px;' +
                      'height: 24px;' +
                      'cursor: pointer;' +
                      'font-size: 12px;' +
                      'display: flex;' +
                      'align-items: center;' +
                      'justify-content: center;' +
                    '">×</button>' +
                    '<div style="padding: 8px; font-size: 11px; color: var(--text-secondary); text-align: center;">' +
                      (file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name) +
                    '</div>';
                  
                  previewContainer.appendChild(previewDiv);
                  uploadedItemImages.push(file);
                };
                reader.readAsDataURL(file);
              }
            });
          });
        }
      }

      function removeItemImage(index) {
        uploadedItemImages.splice(index, 1);
        updateItemImagePreviews();
      }

      function updateItemImagePreviews() {
        const previewContainer = document.getElementById('itemImagePreviewContainer');
        if (previewContainer) {
          previewContainer.innerHTML = '';
          uploadedItemImages.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
              const previewDiv = document.createElement('div');
              previewDiv.style.cssText = 
                'position: relative;' +
                'border-radius: 8px;' +
                'overflow: hidden;' +
                'border: 1px solid var(--border-color);' +
                'background: var(--card-bg);';
              
              previewDiv.innerHTML = 
                '<img src="' + e.target.result + '" style="width: 100%; height: 120px; object-fit: cover;">' +
                '<button onclick="removeItemImage(' + index + ')" style="' +
                  'position: absolute;' +
                  'top: 4px;' +
                  'right: 4px;' +
                  'background: var(--error-color);' +
                  'color: white;' +
                  'border: none;' +
                  'border-radius: 50%;' +
                  'width: 24px;' +
                  'height: 24px;' +
                  'cursor: pointer;' +
                  'font-size: 12px;' +
                  'display: flex;' +
                  'align-items: center;' +
                  'justify-content: center;' +
                '">×</button>' +
                '<div style="padding: 8px; font-size: 11px; color: var(--text-secondary); text-align: center;">' +
                  (file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name) +
                '</div>';
              
              previewContainer.appendChild(previewDiv);
            };
            reader.readAsDataURL(file);
          });
        }
      }

      async function uploadItemImagesToStorage() {
        const user = auth.currentUser;
        if (!user || uploadedItemImages.length === 0) return [];
        
        const imageUrls = [];
        
        for (let i = 0; i < uploadedItemImages.length; i++) {
          const file = uploadedItemImages[i];
          const timestamp = Date.now();
          const fileName = `item_${user.uid}_${timestamp}_${i}_${file.name}`;
          const storageRef = storage.ref(`item_images/${user.uid}/${fileName}`);
          
          try {
            const snapshot = await storageRef.put(file);
            const downloadURL = await snapshot.ref.getDownloadURL();
            imageUrls.push({
              url: downloadURL,
              name: file.name,
              path: `item_images/${user.uid}/${fileName}`,
              size: file.size,
              type: file.type
            });
          } catch (error) {
            console.error('Error uploading image:', error);
            showStatusMessage(`Error uploading ${file.name}: ${error.message}`, 'error');
          }
        }
        
        return imageUrls;
      }

      // Delete item function
      async function deleteItem(itemId) {
        if (!confirm('Are you sure you want to delete this item?')) return;

        const user = auth.currentUser;
        if (!user) {
          showStatusMessage('User not authenticated', 'error');
          return;
        }

        try {
          console.log('Deleting item:', itemId);
          await rtdb.ref(`items/${user.uid}/${itemId}`).remove();
          console.log('Item deleted successfully');
          showStatusMessage('Item deleted successfully', 'success');
          fetchAndRenderItems();
        } catch (error) {
          console.error('Error deleting item:', error);
          showStatusMessage('Error deleting item: ' + error.message, 'error');
        }
      }
  </script>
</body>
</html> 